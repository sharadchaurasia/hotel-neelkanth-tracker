<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; background: #f5f7fa; min-height: 100vh; color: #1a1a2e; }
    .app-container { max-width: 1400px; margin: 0 auto; padding: 20px; }

    .header {
      background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%);
      color: white; padding: 24px 30px; border-radius: 16px; margin-bottom: 24px;
      display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px;
    }
    .header-brand { display: flex; align-items: center; gap: 15px; }
    .header-brand .icon { font-size: 40px; }
    .header-brand h1 { font-size: 26px; font-weight: 700; }
    .header-brand p { opacity: 0.85; font-size: 14px; }
    .header-actions { display: flex; gap: 12px; flex-wrap: wrap; }

    .btn {
      padding: 12px 24px; border: none; border-radius: 10px; cursor: pointer;
      font-size: 14px; font-weight: 600; display: inline-flex; align-items: center; gap: 8px;
    }
    .btn-primary { background: #10b981; color: white; }
    .btn-secondary { background: white; color: #1e3a5f; }
    .btn-danger { background: #ef4444; color: white; }
    .btn-warning { background: #f59e0b; color: white; }
    .btn-small { padding: 8px 14px; font-size: 12px; }
    .btn .material-icons { font-size: 18px; }

    .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 24px; }
    .stat-card { background: white; padding: 24px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.06); border-left: 4px solid; }
    .stat-card.blue { border-color: #3b82f6; }
    .stat-card.red { border-color: #ef4444; }
    .stat-card.green { border-color: #10b981; }
    .stat-card.orange { border-color: #f59e0b; }
    .stat-card .label { font-size: 12px; font-weight: 600; color: #6b7280; text-transform: uppercase; margin-bottom: 8px; }
    .stat-card .value { font-size: 32px; font-weight: 700; }
    .stat-card.blue .value { color: #3b82f6; }
    .stat-card.red .value { color: #ef4444; }
    .stat-card.green .value { color: #10b981; }
    .stat-card.orange .value { color: #f59e0b; }

    .alert-box {
      background: #fef3c7; border-left: 5px solid #f59e0b; padding: 18px 24px;
      border-radius: 12px; margin-bottom: 24px; display: flex; align-items: center; gap: 15px;
    }
    .alert-box .material-icons { color: #d97706; font-size: 28px; }
    .alert-box h4 { color: #92400e; font-size: 15px; margin-bottom: 4px; }
    .alert-box p { color: #78350f; font-size: 14px; }

    .ledger-summary { background: white; padding: 24px; border-radius: 16px; margin-bottom: 24px; }
    .ledger-summary h3 { font-size: 16px; color: #1e3a5f; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
    .ledger-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; }
    .ledger-item { display: flex; justify-content: space-between; padding: 12px 16px; background: #f9fafb; border-radius: 10px; }
    .ledger-item .name { font-weight: 500; }
    .ledger-item .amount { font-weight: 700; color: #ef4444; }

    .filters-card { background: white; padding: 20px 24px; border-radius: 16px; margin-bottom: 24px; }
    .filters-row { display: flex; flex-wrap: wrap; gap: 16px; align-items: flex-end; }
    .filter-group { display: flex; flex-direction: column; gap: 6px; }
    .filter-group label { font-size: 11px; font-weight: 600; color: #6b7280; text-transform: uppercase; }
    .filter-group input, .filter-group select {
      padding: 10px 14px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 14px; min-width: 160px;
    }

    .table-card { background: white; border-radius: 16px; overflow: hidden; }
    .table-header { padding: 20px 24px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; }
    .table-header h2 { font-size: 18px; font-weight: 600; color: #1e3a5f; }
    .record-count { background: #e5e7eb; padding: 6px 14px; border-radius: 20px; font-size: 13px; }
    .table-wrapper { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; }
    th { background: #f9fafb; padding: 14px 16px; text-align: left; font-size: 11px; font-weight: 600; color: #6b7280; text-transform: uppercase; }
    td { padding: 16px; border-bottom: 1px solid #f3f4f6; font-size: 14px; }
    tr:hover { background: #f9fafb; }

    .badge { display: inline-block; padding: 5px 12px; border-radius: 20px; font-size: 11px; font-weight: 600; }
    .badge-walkin { background: #e0e7ff; color: #3730a3; }
    .badge-ota { background: #fce7f3; color: #9d174d; }
    .badge-agent { background: #cffafe; color: #0e7490; }
    .badge-collected { background: #d1fae5; color: #065f46; }
    .badge-pending { background: #fee2e2; color: #991b1b; }
    .badge-partial { background: #fef3c7; color: #92400e; }

    .amount { font-family: monospace; font-weight: 600; }
    .amount-pending { color: #ef4444; }
    .amount-received { color: #10b981; }
    .payment-type { font-size: 11px; color: #6b7280; background: #f3f4f6; padding: 4px 10px; border-radius: 6px; }
    .actions { display: flex; gap: 8px; }

    .empty-state { text-align: center; padding: 60px 20px; }
    .empty-state .material-icons { font-size: 64px; color: #d1d5db; margin-bottom: 16px; }
    .empty-state h3 { color: #6b7280; font-size: 18px; }

    .loading { display: flex; align-items: center; justify-content: center; padding: 40px; }
    .spinner { width: 40px; height: 40px; border: 4px solid #e5e7eb; border-top-color: #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* MODAL - IMPORTANT */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.6);
      z-index: 9999;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    .modal-overlay.active { display: flex !important; }
    .modal {
      background: white;
      border-radius: 20px;
      width: 100%;
      max-width: 640px;
      max-height: 90vh;
      overflow: hidden;
    }
    .modal-header { padding: 24px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; }
    .modal-header h3 { font-size: 20px; font-weight: 600; color: #1e3a5f; }
    .modal-close { background: #f3f4f6; border: none; width: 36px; height: 36px; border-radius: 10px; cursor: pointer; font-size: 20px; }
    .modal-body { padding: 24px; max-height: 60vh; overflow-y: auto; }
    .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 16px; }
    .form-group { display: flex; flex-direction: column; gap: 6px; }
    .form-group label { font-size: 13px; font-weight: 600; color: #374151; }
    .form-group input, .form-group select { padding: 12px 14px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 14px; }
    .modal-footer { padding: 20px 24px; border-top: 1px solid #e5e7eb; display: flex; justify-content: flex-end; gap: 12px; background: #f9fafb; }

    .toast { position: fixed; bottom: 24px; right: 24px; background: #059669; color: white; padding: 16px 24px; border-radius: 12px; z-index: 10000; display: flex; align-items: center; gap: 12px; }
    .toast.error { background: #dc2626; }

    @media (max-width: 768px) {
      .header { flex-direction: column; text-align: center; }
      .filters-row { flex-direction: column; }
      table { min-width: 900px; }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <div class="header">
      <div class="header-brand">
        <span class="icon">üè®</span>
        <div>
          <h1>Hotel Neelkanth</h1>
          <p>Collection Tracker</p>
        </div>
      </div>
      <div class="header-actions">
        <button class="btn btn-primary" id="newBookingBtn">
          <span class="material-icons">add</span> New Booking
        </button>
        <button class="btn btn-secondary" id="viewSheetBtn">
          <span class="material-icons">table_chart</span> View Sheet
        </button>
        <button class="btn btn-secondary" id="refreshBtn">
          <span class="material-icons">refresh</span>
        </button>
      </div>
    </div>

    <div class="dashboard">
      <div class="stat-card blue"><div class="label">Today's Checkouts</div><div class="value" id="todayCheckouts">-</div></div>
      <div class="stat-card red"><div class="label">Pending (Today)</div><div class="value" id="pendingToday">-</div></div>
      <div class="stat-card green"><div class="label">Total Pending</div><div class="value" id="totalPending">-</div></div>
      <div class="stat-card orange"><div class="label">Ledger Due</div><div class="value" id="ledgerDue">-</div></div>
    </div>

    <div class="alert-box" id="alertBox" style="display: none;">
      <span class="material-icons">warning</span>
      <div><h4>Attention Required</h4><p id="alertText"></p></div>
    </div>

    <div class="ledger-summary" id="ledgerSummary" style="display: none;">
      <h3><span class="material-icons">account_balance</span> Agent Ledger Summary</h3>
      <div class="ledger-grid" id="ledgerGrid"></div>
    </div>

    <div class="filters-card">
      <div class="filters-row">
        <div class="filter-group"><label>Checkout Date</label><input type="date" id="filterDate"></div>
        <div class="filter-group"><label>Status</label>
          <select id="filterStatus"><option value="">All</option><option value="PENDING">Pending</option><option value="PARTIAL">Partial</option><option value="COLLECTED">Collected</option></select>
        </div>
        <div class="filter-group"><label>Payment Type</label>
          <select id="filterPaymentType"><option value="">All</option><option value="Prepaid">Prepaid</option><option value="Postpaid">Postpaid</option><option value="Ledger">Ledger</option></select>
        </div>
        <div class="filter-group"><label>Source</label>
          <select id="filterSource"><option value="">All</option><option value="Walk-in">Walk-in</option><option value="OTA">OTA</option><option value="Agent">Agent</option></select>
        </div>
        <div class="filter-group"><label>&nbsp;</label><button class="btn btn-secondary btn-small" id="clearFiltersBtn">Clear</button></div>
        <div class="filter-group"><label>&nbsp;</label><button class="btn btn-warning btn-small" id="todayPendingBtn">Today's Pending</button></div>
      </div>
    </div>

    <div class="table-card">
      <div class="table-header"><h2>Bookings</h2><span class="record-count" id="recordCount">0 records</span></div>
      <div id="tableLoading" class="loading"><div class="spinner"></div></div>
      <div class="table-wrapper" id="tableWrapper" style="display: none;">
        <table>
          <thead><tr><th>ID</th><th>Guest</th><th>Room</th><th>Check-in</th><th>Checkout</th><th>Source</th><th>Type</th><th>Total</th><th>Received</th><th>Pending</th><th>Status</th><th>Actions</th></tr></thead>
          <tbody id="bookingsTable"></tbody>
        </table>
      </div>
      <div class="empty-state" id="emptyState" style="display: none;">
        <span class="material-icons">inbox</span><h3>No bookings found</h3>
      </div>
    </div>
  </div>

  <!-- BOOKING MODAL -->
  <div class="modal-overlay" id="bookingModal">
    <div class="modal">
      <div class="modal-header">
        <h3 id="modalTitle">New Booking</h3>
        <button class="modal-close" id="closeModalBtn">&times;</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="bookingRow">
        <div class="form-row">
          <div class="form-group"><label>Guest Name *</label><input type="text" id="guestName"></div>
          <div class="form-group"><label>Phone</label><input type="tel" id="guestPhone"></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Room *</label>
            <select id="roomNo"><option value="">Select</option>
              <option>101</option><option>102</option><option>103</option><option>104</option><option>105</option>
              <option>106</option><option>107</option><option>108</option><option>109</option><option>110</option>
              <option>111</option><option>112</option><option>113</option><option>114</option><option>115</option>
              <option>116</option><option>117</option><option>118</option><option>119</option><option>120</option>
            </select>
          </div>
          <div class="form-group"><label>Check-in *</label><input type="date" id="checkIn"></div>
          <div class="form-group"><label>Checkout *</label><input type="date" id="checkOut"></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Source *</label>
            <select id="bookingSource"><option value="Walk-in">Walk-in</option><option value="OTA">OTA</option><option value="Agent">Agent</option></select>
          </div>
          <div class="form-group" id="sourceNameGroup" style="display:none;"><label>Source Name *</label><input type="text" id="sourceName"></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Total Amount *</label><input type="number" id="totalAmount" min="0"></div>
          <div class="form-group"><label>Payment Type *</label>
            <select id="paymentType"><option value="Prepaid">Prepaid</option><option value="Postpaid">Postpaid</option><option value="Ledger">Ledger</option></select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Advance Received</label><input type="number" id="advanceReceived" min="0" value="0"></div>
          <div class="form-group"><label>Payment Mode</label>
            <select id="paymentMode"><option value="">Select</option><option>Cash</option><option>UPI</option><option>Card</option><option>Bank Transfer</option></select>
          </div>
        </div>
        <div class="form-group"><label>Remarks</label><input type="text" id="remarks"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="cancelModalBtn">Cancel</button>
        <button class="btn btn-primary" id="saveBookingBtn">Save Booking</button>
      </div>
    </div>
  </div>

  <!-- COLLECT MODAL -->
  <div class="modal-overlay" id="collectModal">
    <div class="modal" style="max-width:420px;">
      <div class="modal-header">
        <h3>Collect Payment</h3>
        <button class="modal-close" id="closeCollectBtn">&times;</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="collectRow">
        <p style="margin-bottom:20px;font-size:16px;">Pending: <strong style="color:#ef4444;" id="collectPendingAmount">‚Çπ0</strong></p>
        <div class="form-group" style="margin-bottom:16px;"><label>Amount *</label><input type="number" id="collectAmount" min="0"></div>
        <div class="form-group"><label>Payment Mode *</label>
          <select id="collectPaymentMode"><option>Cash</option><option>UPI</option><option>Card</option><option>Bank Transfer</option></select>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="cancelCollectBtn">Cancel</button>
        <button class="btn btn-primary" id="doCollectBtn">Collect</button>
      </div>
    </div>
  </div>

<script>
var bookings = [];
var spreadsheetUrl = '';

// Wait for DOM
document.addEventListener('DOMContentLoaded', function() {
  // Set today's date
  var today = new Date().toISOString().split('T')[0];
  document.getElementById('filterDate').value = today;
  document.getElementById('checkIn').value = today;

  // Load data
  loadData();

  // Button event listeners
  document.getElementById('newBookingBtn').addEventListener('click', openBookingModal);
  document.getElementById('viewSheetBtn').addEventListener('click', openSpreadsheet);
  document.getElementById('refreshBtn').addEventListener('click', refreshData);
  document.getElementById('clearFiltersBtn').addEventListener('click', clearFilters);
  document.getElementById('todayPendingBtn').addEventListener('click', showTodayPending);

  // Modal buttons
  document.getElementById('closeModalBtn').addEventListener('click', closeBookingModal);
  document.getElementById('cancelModalBtn').addEventListener('click', closeBookingModal);
  document.getElementById('saveBookingBtn').addEventListener('click', saveBooking);

  // Collect modal buttons
  document.getElementById('closeCollectBtn').addEventListener('click', closeCollectModal);
  document.getElementById('cancelCollectBtn').addEventListener('click', closeCollectModal);
  document.getElementById('doCollectBtn').addEventListener('click', collectPayment);

  // Source change
  document.getElementById('bookingSource').addEventListener('change', toggleSourceName);

  // Filters
  document.getElementById('filterDate').addEventListener('change', applyFilters);
  document.getElementById('filterStatus').addEventListener('change', applyFilters);
  document.getElementById('filterPaymentType').addEventListener('change', applyFilters);
  document.getElementById('filterSource').addEventListener('change', applyFilters);
});

function getToday() {
  return new Date().toISOString().split('T')[0];
}

function formatCurrency(amt) {
  return '‚Çπ' + Number(amt || 0).toLocaleString('en-IN');
}

function formatDate(d) {
  if (!d) return '-';
  return new Date(d).toLocaleDateString('en-IN', {day:'2-digit', month:'short'});
}

function loadData() {
  document.getElementById('tableLoading').style.display = 'flex';
  document.getElementById('tableWrapper').style.display = 'none';

  google.script.run
    .withSuccessHandler(function(data) {
      bookings = data || [];
      renderBookings();
      loadDashboard();
      google.script.run.withSuccessHandler(function(url) { spreadsheetUrl = url; }).getSpreadsheetUrl();
    })
    .withFailureHandler(function(e) { showToast('Failed to load', true); })
    .getBookings();
}

function loadDashboard() {
  google.script.run.withSuccessHandler(function(s) {
    document.getElementById('todayCheckouts').textContent = s.todayCheckouts;
    document.getElementById('pendingToday').textContent = formatCurrency(s.pendingToday);
    document.getElementById('totalPending').textContent = formatCurrency(s.totalPending);
    document.getElementById('ledgerDue').textContent = formatCurrency(s.ledgerDue);

    var alertBox = document.getElementById('alertBox');
    if (s.pendingToday > 0) {
      alertBox.style.display = 'flex';
      document.getElementById('alertText').textContent = s.todayCheckouts + ' checkout(s) with ' + formatCurrency(s.pendingToday) + ' pending';
    } else {
      alertBox.style.display = 'none';
    }

    var ledgerSummary = document.getElementById('ledgerSummary');
    var ledgerGrid = document.getElementById('ledgerGrid');
    var agents = Object.keys(s.ledgerByAgent);
    if (agents.length > 0) {
      ledgerSummary.style.display = 'block';
      ledgerGrid.innerHTML = agents.map(function(name) {
        return '<div class="ledger-item"><span class="name">' + name + '</span><span class="amount">' + formatCurrency(s.ledgerByAgent[name]) + '</span></div>';
      }).join('');
    } else {
      ledgerSummary.style.display = 'none';
    }
  }).getDashboardStats();
}

function refreshData() { loadData(); showToast('Refreshed'); }

function openSpreadsheet() { if (spreadsheetUrl) window.open(spreadsheetUrl, '_blank'); }

function applyFilters() { renderBookings(); }

function clearFilters() {
  document.getElementById('filterDate').value = '';
  document.getElementById('filterStatus').value = '';
  document.getElementById('filterPaymentType').value = '';
  document.getElementById('filterSource').value = '';
  renderBookings();
}

function showTodayPending() {
  document.getElementById('filterDate').value = getToday();
  document.getElementById('filterStatus').value = 'PENDING';
  renderBookings();
}

function getFilteredBookings() {
  var fd = document.getElementById('filterDate').value;
  var fs = document.getElementById('filterStatus').value;
  var fp = document.getElementById('filterPaymentType').value;
  var fo = document.getElementById('filterSource').value;

  return bookings.filter(function(b) {
    if (fd && b.checkout !== fd) return false;
    if (fs && b.status !== fs) return false;
    if (fp && b.payment_type !== fp) return false;
    if (fo && b.source !== fo) return false;
    return true;
  });
}

function renderBookings() {
  var filtered = getFilteredBookings();
  var tbody = document.getElementById('bookingsTable');

  document.getElementById('tableLoading').style.display = 'none';
  document.getElementById('recordCount').textContent = filtered.length + ' records';

  if (filtered.length === 0) {
    document.getElementById('tableWrapper').style.display = 'none';
    document.getElementById('emptyState').style.display = 'block';
    return;
  }

  document.getElementById('tableWrapper').style.display = 'block';
  document.getElementById('emptyState').style.display = 'none';

  filtered.sort(function(a,b) { return new Date(a.checkout) - new Date(b.checkout); });

  tbody.innerHTML = filtered.map(function(b) {
    var received = (parseFloat(b.advance_received)||0) + (parseFloat(b.balance_received)||0);
    var pending = (parseFloat(b.total_amount)||0) - received;
    var srcClass = b.source === 'Walk-in' ? 'badge-walkin' : b.source === 'OTA' ? 'badge-ota' : 'badge-agent';
    var statClass = b.status === 'COLLECTED' ? 'badge-collected' : b.status === 'PARTIAL' ? 'badge-partial' : 'badge-pending';

    return '<tr>' +
      '<td><strong>' + b.booking_id + '</strong></td>' +
      '<td>' + b.guest_name + (b.phone ? '<br><small style="color:#888">' + b.phone + '</small>' : '') + '</td>' +
      '<td>' + b.room_no + '</td>' +
      '<td>' + formatDate(b.check_in || b['check-in']) + '</td>' +
      '<td><strong>' + formatDate(b.checkout) + '</strong></td>' +
      '<td><span class="badge ' + srcClass + '">' + b.source + '</span>' + (b.source_name ? '<br><small>' + b.source_name + '</small>' : '') + '</td>' +
      '<td><span class="payment-type">' + b.payment_type + '</span></td>' +
      '<td class="amount">' + formatCurrency(b.total_amount) + '</td>' +
      '<td class="amount amount-received">' + formatCurrency(received) + '</td>' +
      '<td class="amount ' + (pending > 0 ? 'amount-pending' : '') + '">' + formatCurrency(pending) + '</td>' +
      '<td><span class="badge ' + statClass + '">' + b.status + '</span></td>' +
      '<td class="actions">' +
        (pending > 0 ? '<button class="btn btn-primary btn-small" onclick="openCollectModal(' + b.row + ',' + pending + ')">Collect</button>' : '') +
        '<button class="btn btn-secondary btn-small" onclick="editBooking(' + b.row + ')">Edit</button>' +
        '<button class="btn btn-danger btn-small" onclick="deleteBooking(' + b.row + ')">Del</button>' +
      '</td></tr>';
  }).join('');
}

function openBookingModal() {
  document.getElementById('modalTitle').textContent = 'New Booking';
  document.getElementById('bookingRow').value = '';
  document.getElementById('guestName').value = '';
  document.getElementById('guestPhone').value = '';
  document.getElementById('roomNo').value = '';
  document.getElementById('checkIn').value = getToday();
  document.getElementById('checkOut').value = '';
  document.getElementById('bookingSource').value = 'Walk-in';
  document.getElementById('sourceName').value = '';
  document.getElementById('totalAmount').value = '';
  document.getElementById('paymentType').value = 'Postpaid';
  document.getElementById('advanceReceived').value = '0';
  document.getElementById('paymentMode').value = '';
  document.getElementById('remarks').value = '';
  toggleSourceName();
  document.getElementById('bookingModal').classList.add('active');
}

function editBooking(row) {
  var b = bookings.find(function(x) { return x.row === row; });
  if (!b) return;
  document.getElementById('modalTitle').textContent = 'Edit Booking';
  document.getElementById('bookingRow').value = row;
  document.getElementById('guestName').value = b.guest_name;
  document.getElementById('guestPhone').value = b.phone || '';
  document.getElementById('roomNo').value = b.room_no;
  document.getElementById('checkIn').value = b.check_in || b['check-in'];
  document.getElementById('checkOut').value = b.checkout;
  document.getElementById('bookingSource').value = b.source;
  document.getElementById('sourceName').value = b.source_name || '';
  document.getElementById('totalAmount').value = b.total_amount;
  document.getElementById('paymentType').value = b.payment_type;
  document.getElementById('advanceReceived').value = b.advance_received || 0;
  document.getElementById('paymentMode').value = b.payment_mode || '';
  document.getElementById('remarks').value = b.remarks || '';
  toggleSourceName();
  document.getElementById('bookingModal').classList.add('active');
}

function closeBookingModal() {
  document.getElementById('bookingModal').classList.remove('active');
}

function toggleSourceName() {
  var src = document.getElementById('bookingSource').value;
  document.getElementById('sourceNameGroup').style.display = (src === 'OTA' || src === 'Agent') ? 'block' : 'none';
}

function saveBooking() {
  var data = {
    row: document.getElementById('bookingRow').value || null,
    guestName: document.getElementById('guestName').value.trim(),
    phone: document.getElementById('guestPhone').value.trim(),
    roomNo: document.getElementById('roomNo').value,
    checkIn: document.getElementById('checkIn').value,
    checkOut: document.getElementById('checkOut').value,
    source: document.getElementById('bookingSource').value,
    sourceName: document.getElementById('sourceName').value.trim(),
    totalAmount: document.getElementById('totalAmount').value,
    paymentType: document.getElementById('paymentType').value,
    advanceReceived: document.getElementById('advanceReceived').value,
    paymentMode: document.getElementById('paymentMode').value,
    remarks: document.getElementById('remarks').value.trim()
  };

  if (!data.guestName || !data.roomNo || !data.checkIn || !data.checkOut || !data.totalAmount) {
    showToast('Fill all required fields', true);
    return;
  }

  var btn = document.getElementById('saveBookingBtn');
  btn.disabled = true;
  btn.textContent = 'Saving...';

  var method = data.row ? 'updateBooking' : 'addBooking';
  google.script.run
    .withSuccessHandler(function() {
      closeBookingModal();
      showToast(data.row ? 'Updated!' : 'Booking added!');
      loadData();
      btn.disabled = false;
      btn.textContent = 'Save Booking';
    })
    .withFailureHandler(function() {
      showToast('Error saving', true);
      btn.disabled = false;
      btn.textContent = 'Save Booking';
    })[method](data);
}

function openCollectModal(row, pending) {
  document.getElementById('collectRow').value = row;
  document.getElementById('collectPendingAmount').textContent = formatCurrency(pending);
  document.getElementById('collectAmount').value = pending;
  document.getElementById('collectModal').classList.add('active');
}

function closeCollectModal() {
  document.getElementById('collectModal').classList.remove('active');
}

function collectPayment() {
  var row = parseInt(document.getElementById('collectRow').value);
  var amount = document.getElementById('collectAmount').value;
  var mode = document.getElementById('collectPaymentMode').value;

  if (!amount || parseFloat(amount) <= 0) {
    showToast('Enter valid amount', true);
    return;
  }

  google.script.run
    .withSuccessHandler(function() {
      closeCollectModal();
      showToast('Payment collected!');
      loadData();
    })
    .withFailureHandler(function() { showToast('Error', true); })
    .collectPayment({ row: row, amount: amount, paymentMode: mode });
}

function deleteBooking(row) {
  if (!confirm('Delete this booking?')) return;
  google.script.run
    .withSuccessHandler(function() { showToast('Deleted'); loadData(); })
    .deleteBooking(row);
}

function showToast(msg, isError) {
  var t = document.createElement('div');
  t.className = 'toast' + (isError ? ' error' : '');
  t.innerHTML = '<span class="material-icons">' + (isError ? 'error' : 'check_circle') + '</span> ' + msg;
  document.body.appendChild(t);
  setTimeout(function() { t.remove(); }, 3000);
}
</script>
</body>
</html>
