<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#1a1a2e">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Neelkanth CRM">
  <link rel="manifest" href="/manifest.json">
  <link rel="apple-touch-icon" href="/icon-192.png">
  <title>The Neelkanth Grand - CRM</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, #f5f3ef 0%, #ebe8e2 100%);
      min-height: 100vh;
      color: #2c2a26;
    }

    h1, h2, h3 {
      font-family: 'Playfair Display', Georgia, serif;
    }

    /* Auth Screens */
    .auth-screen {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      background: linear-gradient(135deg, #1c2038 0%, #2c2450 100%);
    }
    .auth-card {
      background: rgba(255,255,255,0.97);
      border-radius: 20px;
      padding: 48px 40px;
      width: 100%;
      max-width: 420px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      text-align: center;
    }
    .auth-card .auth-logo { font-size: 48px; margin-bottom: 8px; }
    .auth-card h2 { font-family: 'Playfair Display', serif; margin-bottom: 8px; color: #1c2038; }
    .auth-card p { color: #666; margin-bottom: 24px; font-size: 14px; }
    .auth-card input {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid #e0ddd8;
      border-radius: 10px;
      font-size: 15px;
      margin-bottom: 16px;
      outline: none;
      transition: border-color 0.2s;
    }
    .auth-card input:focus { border-color: #b8943e; }
    .auth-card .auth-btn {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #1c2038, #2c2450);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      margin-bottom: 12px;
    }
    .auth-card .auth-btn:hover { opacity: 0.9; }
    .auth-card .auth-link { color: #b8943e; cursor: pointer; font-size: 14px; }
    .auth-card .error-text { color: #e74c3c; font-size: 13px; margin-top: 8px; }
    .auth-hidden { display: none !important; }

    /* User badge in header */
    .header-user {
      display: flex;
      align-items: center;
      gap: 12px;
      background: rgba(255,255,255,0.1);
      padding: 8px 16px;
      border-radius: 10px;
    }
    .header-user .user-name { font-size: 14px; color: #f5f3ef; font-weight: 500; }
    .header-user .logout-btn {
      background: rgba(255,255,255,0.15);
      color: #f5f3ef;
      border: 1px solid rgba(255,255,255,0.2);
      padding: 6px 14px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
    }
    .header-user .logout-btn:hover { background: rgba(255,255,255,0.25); }

    .app-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    /* Header */
    .header {
      background: linear-gradient(135deg, #1c2038 0%, #2c2450 100%);
      color: #f5f3ef;
      padding: 24px 30px;
      border-radius: 16px;
      margin-bottom: 24px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
      border-bottom: 3px solid #b8943e;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 20px;
    }

    .header-brand {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .header-brand .icon {
      font-size: 40px;
    }

    .header-brand h1 {
      font-size: 26px;
      font-weight: 700;
      color: #d4b87a;
    }

    .header-brand p {
      opacity: 0.85;
      font-size: 14px;
      color: #d4c9a8;
    }

    .header-actions {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    /* Buttons */
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      font-family: inherit;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s ease;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(0,0,0,0.15);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn-primary {
      background: linear-gradient(135deg, #b8862e 0%, #9a7520 100%);
      color: #ffffff;
    }

    .btn-secondary {
      background: #ffffff;
      color: #996b2f;
      border: 1px solid rgba(153, 107, 47, 0.4);
    }

    .btn-danger {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: white;
    }

    .btn-warning {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      color: white;
    }

    .btn-small {
      padding: 8px 14px;
      font-size: 12px;
      border-radius: 8px;
    }

    .btn .material-icons {
      font-size: 18px;
    }

    /* Dashboard Cards */
    .dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 20px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      padding: 24px;
      border-radius: 16px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.06);
      border: 1px solid rgba(153, 107, 47, 0.2);
      position: relative;
      overflow: hidden;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 4px;
      height: 100%;
    }

    .stat-card.blue::before { background: #996b2f; }
    .stat-card.red::before { background: #a07a28; }
    .stat-card.green::before { background: #c99b1a; }
    .stat-card.orange::before { background: #9c7525; }

    .stat-card .label {
      font-size: 12px;
      font-weight: 600;
      color: #7a7060;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .stat-card .value {
      font-size: 32px;
      font-weight: 700;
    }

    .stat-card.blue .value { color: #996b2f; }
    .stat-card.red .value { color: #a07a28; }
    .stat-card.green .value { color: #8b6d1e; }
    .stat-card.orange .value { color: #9c7525; }

    /* Alert Box */
    .alert-box {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-left: 5px solid #996b2f;
      border: 1px solid rgba(153, 107, 47, 0.3);
      border-left: 5px solid #996b2f;
      padding: 18px 24px;
      border-radius: 12px;
      margin-bottom: 24px;
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .alert-box .material-icons {
      color: #996b2f;
      font-size: 28px;
    }

    .alert-box h4 {
      color: #8b6d1e;
      font-size: 15px;
      margin-bottom: 4px;
    }

    .alert-box p {
      color: #5c5040;
      font-size: 14px;
    }

    /* Ledger Summary */
    .ledger-summary {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      padding: 24px;
      border-radius: 16px;
      margin-bottom: 24px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.06);
      border: 1px solid rgba(153, 107, 47, 0.2);
    }

    .ledger-summary h3 {
      font-size: 16px;
      color: #996b2f;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .ledger-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
    }

    .ledger-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      background: #ffffff;
      border-radius: 10px;
      border: 1px solid rgba(153, 107, 47, 0.15);
    }

    .ledger-item .name {
      font-weight: 500;
      color: #5c5040;
    }

    .ledger-item .amount {
      font-weight: 700;
      color: #a07a28;
      font-family: 'SF Mono', 'Courier New', monospace;
    }

    /* Filters */
    .filters-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      padding: 20px 24px;
      border-radius: 16px;
      margin-bottom: 24px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.06);
      border: 1px solid rgba(153, 107, 47, 0.2);
    }

    .filters-row {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      align-items: flex-end;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .filter-group label {
      font-size: 11px;
      font-weight: 600;
      color: #7a7060;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .filter-group input,
    .filter-group select {
      padding: 10px 14px;
      border: 2px solid rgba(153, 107, 47, 0.3);
      border-radius: 10px;
      font-size: 14px;
      font-family: inherit;
      min-width: 160px;
      transition: border-color 0.2s;
      background: #ffffff;
      color: #2c2a26;
    }

    .filter-group input:focus,
    .filter-group select:focus {
      outline: none;
      border-color: #996b2f;
    }

    /* Table */
    .table-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-radius: 16px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.06);
      border: 1px solid rgba(153, 107, 47, 0.2);
      overflow: hidden;
    }

    .table-header {
      padding: 20px 24px;
      border-bottom: 1px solid rgba(153, 107, 47, 0.2);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .table-header h2 {
      font-size: 18px;
      font-weight: 600;
      color: #996b2f;
    }

    .record-count {
      background: rgba(153, 107, 47, 0.15);
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 500;
      color: #996b2f;
    }

    .table-wrapper {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th {
      background: rgba(240, 237, 230, 0.95);
      padding: 14px 16px;
      text-align: left;
      font-size: 11px;
      font-weight: 600;
      color: #996b2f;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 1px solid rgba(153, 107, 47, 0.2);
      white-space: nowrap;
    }

    td {
      padding: 16px;
      border-bottom: 1px solid rgba(153, 107, 47, 0.1);
      font-size: 14px;
      color: #2c2a26;
    }

    tr:hover {
      background: rgba(153, 107, 47, 0.05);
    }

    .guest-info .name {
      font-weight: 600;
      color: #2c2a26;
    }

    .guest-info .phone {
      font-size: 12px;
      color: #7a7060;
      margin-top: 2px;
    }

    .badge {
      display: inline-block;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .badge-walkin { background: rgba(99, 102, 241, 0.12); color: #4338ca; }
    .badge-ota { background: rgba(236, 72, 153, 0.12); color: #be185d; }
    .badge-agent { background: rgba(6, 182, 212, 0.12); color: #0e7490; }

    .badge-collected { background: rgba(16, 185, 129, 0.15); color: #0d7a54; }
    .badge-pending { background: rgba(239, 68, 68, 0.12); color: #c53030; }
    .badge-partial { background: rgba(245, 158, 11, 0.15); color: #b45309; }
    .badge-cancelled { background: rgba(107, 114, 128, 0.12); color: #6b7280; text-decoration: line-through; }
    .badge-rescheduled { background: rgba(59, 130, 246, 0.12); color: #2563eb; }

    .badge-kot {
      background: rgba(245, 158, 11, 0.12);
      color: #b45309;
      font-size: 10px;
      padding: 2px 8px;
      border-radius: 6px;
      margin-left: 4px;
    }

    .amount {
      font-family: 'SF Mono', 'Courier New', monospace;
      font-weight: 600;
    }

    .amount-pending {
      color: #dc2626;
    }

    .amount-received {
      color: #059669;
    }

    .payment-type {
      font-size: 11px;
      color: #7a7060;
      background: #ffffff;
      padding: 4px 10px;
      border-radius: 6px;
    }

    .actions {
      display: flex;
      gap: 8px;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
    }

    .empty-state .material-icons {
      font-size: 64px;
      color: rgba(153, 107, 47, 0.3);
      margin-bottom: 16px;
    }

    .empty-state h3 {
      color: #7a7060;
      font-size: 18px;
      margin-bottom: 8px;
    }

    .empty-state p {
      color: #9e9688;
      font-size: 14px;
    }

    /* Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.35);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      padding: 20px;
      backdrop-filter: blur(4px);
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: #ffffff;
      border-radius: 20px;
      width: 100%;
      max-width: 640px;
      max-height: 90vh;
      overflow: hidden;
      box-shadow: 0 10px 40px rgba(0,0,0,0.12);
      border: 1px solid rgba(153, 107, 47, 0.2);
      animation: modalIn 0.3s ease;
    }

    @keyframes modalIn {
      from {
        opacity: 0;
        transform: scale(0.95) translateY(-20px);
      }
      to {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }

    .modal-header {
      padding: 24px;
      border-bottom: 1px solid rgba(153, 107, 47, 0.2);
      background: rgba(153, 107, 47, 0.08);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h3 {
      font-size: 20px;
      font-weight: 600;
      color: #996b2f;
    }

    .modal-close {
      background: rgba(153, 107, 47, 0.15);
      border: none;
      width: 36px;
      height: 36px;
      border-radius: 10px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
      color: #996b2f;
    }

    .modal-close:hover {
      background: rgba(153, 107, 47, 0.25);
    }

    .modal-body {
      padding: 24px;
      max-height: 60vh;
      overflow-y: auto;
    }

    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 16px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .form-group label {
      font-size: 13px;
      font-weight: 600;
      color: #5c5040;
    }

    .form-group input,
    .form-group select {
      padding: 12px 14px;
      border: 2px solid rgba(153, 107, 47, 0.3);
      border-radius: 10px;
      font-size: 14px;
      font-family: inherit;
      transition: border-color 0.2s;
      background: #ffffff;
      color: #2c2a26;
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #996b2f;
    }

    .modal-footer {
      padding: 20px 24px;
      border-top: 1px solid rgba(153, 107, 47, 0.2);
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      background: rgba(240, 237, 230, 0.6);
    }

    /* Toast Notification */
    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: #ffffff;
      color: #2c2a26;
      padding: 16px 24px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      border: 1px solid rgba(153, 107, 47, 0.3);
      display: flex;
      align-items: center;
      gap: 12px;
      z-index: 2000;
      animation: toastIn 0.3s ease;
    }

    .toast.success { background: #f0fdf4; border-color: rgba(16, 185, 129, 0.4); color: #166534; }
    .toast.error { background: #fef2f2; border-color: rgba(239, 68, 68, 0.4); color: #991b1b; }

    @keyframes toastIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Responsive */
    @media (max-width: 768px) {
      body { font-size: 11px; }
      .app-container { padding: 6px; }

      /* Header - compact */
      .header {
        flex-direction: column; text-align: center;
        padding: 8px 10px; border-radius: 8px; margin-bottom: 8px; gap: 4px;
      }
      .header-brand { gap: 8px; }
      .header-brand .icon { font-size: 22px; }
      .header-brand h1 { font-size: 14px; }
      .header-brand p { font-size: 9px; }
      .header-user { padding: 3px 8px; gap: 4px; }
      .header-user .user-name { font-size: 10px; }
      .header-user .logout-btn { font-size: 9px; padding: 3px 8px; }
      .header-actions { justify-content: center; gap: 4px; }
      .header-actions .btn { font-size: 9px; padding: 4px 8px; }

      /* Tabs - icon only */
      .nav-tabs { margin-bottom: 8px; border-radius: 6px; justify-content: center; }
      .nav-tabs button {
        font-size: 0; padding: 8px 0; gap: 0;
        flex: 1 1 12.5%; min-width: 0; justify-content: center;
        border-bottom-width: 2px;
      }
      .nav-tabs button .material-icons { font-size: 18px; }

      /* Dashboard cards */
      .dashboard { grid-template-columns: repeat(2, 1fr); gap: 6px; margin-bottom: 8px; }
      .stat-card { padding: 8px; border-radius: 8px; }
      .stat-card .label { font-size: 8px; margin-bottom: 2px; letter-spacing: 0.3px; }
      .stat-card .value { font-size: 16px; }
      .stat-card::before { width: 3px; }

      /* Alert box */
      .alert-box { padding: 6px 8px; border-radius: 6px; margin-bottom: 8px; gap: 6px; }
      .alert-box .material-icons { font-size: 16px; }
      .alert-box h4 { font-size: 10px; margin-bottom: 2px; }
      .alert-box p { font-size: 9px; }

      /* Ledger summary */
      .ledger-summary { padding: 8px; border-radius: 8px; margin-bottom: 8px; }
      .ledger-summary h3 { font-size: 11px; margin-bottom: 6px; }
      .ledger-grid { grid-template-columns: 1fr 1fr; gap: 4px; }
      .ledger-item { padding: 6px 8px; border-radius: 6px; }
      .ledger-item .name { font-size: 10px; }
      .ledger-item .amount { font-size: 10px; }

      /* Filters */
      .filters-card { padding: 8px; border-radius: 8px; margin-bottom: 8px; }
      .filters-row { flex-direction: column; gap: 6px; }
      .filter-group { width: 100%; }
      .filter-group label { font-size: 9px; margin-bottom: 2px; }
      .filter-group input, .filter-group select {
        width: 100%; font-size: 11px; padding: 6px 8px; border-radius: 6px;
      }

      /* Buttons */
      .btn { padding: 5px 10px; font-size: 10px; border-radius: 6px; gap: 4px; }
      .btn:hover { transform: none; box-shadow: none; }
      .btn-small { padding: 4px 8px; font-size: 9px; }
      .btn .material-icons { font-size: 14px; }

      /* Tables */
      table { min-width: 700px; }
      .table-wrapper { border-radius: 6px; margin-bottom: 8px; }
      .report-table th { padding: 6px 8px; font-size: 9px; }
      .report-table td { padding: 6px 8px; font-size: 10px; }

      /* Guest lists */
      .guest-lists { margin-bottom: 8px; }
      .guest-list-section { border-radius: 8px; margin-bottom: 8px; }
      .guest-list-section .section-title { padding: 8px 12px; font-size: 11px; gap: 6px; }
      .guest-list-section .section-title .material-icons { font-size: 16px; }
      .guest-list-table th { padding: 5px 8px; font-size: 8px; }
      .guest-list-table td { padding: 6px 8px; font-size: 10px; }
      .guest-list-empty { padding: 10px; font-size: 10px; }

      /* Modal */
      .modal {
        max-width: 100%; border-radius: 10px 10px 0 0; max-height: 90vh;
      }
      .modal-header { padding: 10px 12px; }
      .modal-header h3 { font-size: 14px; }
      .modal-body { padding: 10px 12px; }
      .modal-body label { font-size: 10px; }
      .modal-body input, .modal-body select, .modal-body textarea {
        font-size: 12px; padding: 7px 10px;
      }
      .modal-footer { padding: 8px 12px; }
      .form-group { margin-bottom: 8px; }

      /* Auth screens */
      .auth-card { padding: 24px 18px; border-radius: 12px; }
      .auth-card .auth-logo { font-size: 30px; }
      .auth-card h2 { font-size: 18px; }
      .auth-card p { font-size: 11px; margin-bottom: 16px; }
      .auth-card input { padding: 10px 12px; font-size: 13px; margin-bottom: 10px; }
      .auth-card .auth-btn { padding: 10px; font-size: 13px; }
      .auth-card .auth-link { font-size: 11px; }

      /* Day Book */
      .daybook-date-bar { flex-direction: column; gap: 6px; margin-bottom: 8px; }
      .balance-cards { grid-template-columns: repeat(2, 1fr); gap: 4px; }
      .balance-card { padding: 6px; border-radius: 6px; }
      .bc-label { font-size: 8px; }
      .bc-value { font-size: 13px; }
      .daybook-section { margin-bottom: 8px; }
      .section-header { flex-direction: column; gap: 4px; padding: 6px 0; }
      .section-header h3 { font-size: 12px; }

      /* Dashboard controls */
      .dashboard-controls { gap: 6px; margin-bottom: 8px; }
      .dashboard-controls label { font-size: 10px; }
      .dashboard-controls select { font-size: 10px; padding: 4px 8px; }

      /* General text overrides */
      h2 { font-size: 14px !important; }
      h3 { font-size: 12px !important; }
      h4 { font-size: 11px !important; }
      p, span, small, label, td, th { line-height: 1.3; }
    }

    /* Dashboard View Toggle */
    .dashboard-controls {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 24px;
      flex-wrap: wrap;
    }

    .dashboard-controls label {
      font-size: 13px;
      font-weight: 600;
      color: #7a7060;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .view-toggle {
      display: flex;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 1px 6px rgba(0,0,0,0.06);
      border: 1px solid rgba(153, 107, 47, 0.2);
    }

    .view-toggle button {
      padding: 10px 20px;
      border: none;
      background: transparent;
      color: #7a7060;
      font-size: 13px;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.2s;
      border-right: 1px solid rgba(153, 107, 47, 0.15);
    }

    .view-toggle button:last-child {
      border-right: none;
    }

    .view-toggle button.active {
      background: linear-gradient(135deg, #b8862e 0%, #9a7520 100%);
      color: #ffffff;
    }

    .view-toggle button:hover:not(.active) {
      background: rgba(153, 107, 47, 0.1);
    }

    /* Monthly Summary Section */
    .monthly-summary {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      padding: 24px;
      border-radius: 16px;
      margin-bottom: 24px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.06);
      border: 1px solid rgba(153, 107, 47, 0.2);
    }

    .monthly-summary .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
      flex-wrap: wrap;
      gap: 12px;
    }

    .monthly-summary h3 {
      font-size: 16px;
      color: #996b2f;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .month-selector {
      padding: 8px 14px;
      border: 2px solid rgba(153, 107, 47, 0.3);
      border-radius: 10px;
      font-size: 14px;
      font-family: inherit;
      background: #ffffff;
      color: #2c2a26;
    }

    .monthly-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
    }

    .monthly-card {
      padding: 16px 20px;
      border-radius: 12px;
      border: 1px solid rgba(153, 107, 47, 0.15);
      background: #ffffff;
    }

    .monthly-card .mc-label {
      font-size: 11px;
      font-weight: 600;
      color: #7a7060;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 6px;
    }

    .monthly-card .mc-value {
      font-size: 24px;
      font-weight: 700;
      font-family: 'SF Mono', 'Courier New', monospace;
    }

    .monthly-card .mc-value.blue { color: #996b2f; }
    .monthly-card .mc-value.green { color: #8b6d1e; }
    .monthly-card .mc-value.red { color: #a07a28; }
    .monthly-card .mc-value.orange { color: #9c7525; }

    /* Room Inventory Section */
    .inventory-section {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      padding: 24px;
      border-radius: 16px;
      margin-bottom: 24px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.06);
      border: 1px solid rgba(153, 107, 47, 0.2);
    }

    .inventory-section .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
      flex-wrap: wrap;
      gap: 12px;
    }

    .inventory-section h3 {
      font-size: 16px;
      color: #996b2f;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .inv-table-wrap {
      overflow-x: auto;
    }

    .inv-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    .inv-table th, .inv-table td {
      padding: 6px 4px;
      text-align: center;
      border: 1px solid rgba(153, 107, 47, 0.15);
      min-width: 36px;
    }

    .inv-table th {
      background: rgba(240, 237, 230, 0.95);
      font-weight: 700;
      color: #996b2f;
      position: sticky;
      top: 0;
    }

    .inv-table th.room-col {
      text-align: left;
      padding-left: 10px;
      min-width: 60px;
      position: sticky;
      left: 0;
      z-index: 2;
      background: rgba(240, 237, 230, 0.95);
    }

    .inv-table td.room-col {
      text-align: left;
      padding-left: 10px;
      font-weight: 600;
      color: #5c5040;
      position: sticky;
      left: 0;
      background: #ffffff;
      z-index: 1;
    }

    .inv-table .cell-occupied {
      background: rgba(239, 68, 68, 0.1);
      color: #dc2626;
      font-weight: 600;
      font-size: 10px;
      cursor: pointer;
    }

    .inv-table .cell-occupied:hover {
      background: rgba(239, 68, 68, 0.18);
    }

    .inv-table .cell-vacant {
      background: rgba(16, 185, 129, 0.08);
      color: #059669;
    }

    .inv-table .cell-today {
      border-bottom: 3px solid #996b2f;
    }

    .inv-summary-row {
      display: flex;
      gap: 20px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }

    .inv-summary-row .inv-chip {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      font-weight: 500;
    }

    .inv-chip .dot {
      width: 14px;
      height: 14px;
      border-radius: 4px;
    }

    .dot-occupied { background: rgba(239, 68, 68, 0.3); border: 1px solid rgba(239, 68, 68, 0.5); }
    .dot-vacant { background: rgba(16, 185, 129, 0.3); border: 1px solid rgba(16, 185, 129, 0.5); }

    .room-avail-hint {
      font-size: 12px;
      color: #059669;
      margin-top: 4px;
      font-weight: 500;
    }

    .room-avail-hint.warn {
      color: #dc2626;
    }

    /* Reports Section */
    .reports-section {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      padding: 24px;
      border-radius: 16px;
      margin-bottom: 24px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.06);
      border: 1px solid rgba(153, 107, 47, 0.2);
    }

    .reports-section .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
      flex-wrap: wrap;
      gap: 12px;
    }

    .reports-section h3 {
      font-size: 16px;
      color: #996b2f;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .report-filters {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
    }

    .report-filters select,
    .report-filters input {
      padding: 8px 14px;
      border: 2px solid rgba(153, 107, 47, 0.3);
      border-radius: 10px;
      font-size: 13px;
      font-family: inherit;
      background: #ffffff;
      color: #2c2a26;
    }

    .report-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
    }

    .report-table th {
      background: rgba(240, 237, 230, 0.95);
      padding: 12px 16px;
      text-align: left;
      font-size: 11px;
      font-weight: 700;
      color: #996b2f;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 2px solid rgba(153, 107, 47, 0.2);
    }

    .report-table td {
      padding: 12px 16px;
      border-bottom: 1px solid rgba(153, 107, 47, 0.1);
      font-size: 14px;
      color: #2c2a26;
    }

    .report-table tr:hover {
      background: rgba(153, 107, 47, 0.05);
    }

    .report-table .total-row {
      font-weight: 700;
      background: rgba(153, 107, 47, 0.1);
    }

    .report-table .total-row td {
      border-top: 2px solid #996b2f;
    }

    /* Tabs */
    .nav-tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 0;
      margin-bottom: 24px;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 1px 6px rgba(0,0,0,0.06);
      border: 1px solid rgba(153, 107, 47, 0.2);
    }

    .nav-tabs button {
      flex: 1 1 auto;
      padding: 10px 12px;
      border: none;
      background: transparent;
      color: #7a7060;
      font-size: 14px;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      border-bottom: 3px solid transparent;
    }

    .nav-tabs button.active {
      color: #996b2f;
      border-bottom-color: #996b2f;
      background: rgba(153, 107, 47, 0.1);
    }

    .nav-tabs button:hover:not(.active) {
      background: rgba(153, 107, 47, 0.05);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* Dashboard Guest Lists */
    .guest-lists { margin-bottom: 24px; }
    .guest-list-section {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-radius: 16px;
      margin-bottom: 16px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.06);
      border: 1px solid rgba(153, 107, 47, 0.2);
      overflow: hidden;
    }
    .guest-list-section .section-title {
      padding: 16px 24px;
      font-size: 15px;
      font-weight: 700;
      color: #ffffff;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .guest-list-section.checkin-section .section-title { background: linear-gradient(135deg, #996b2f, #c99b1a); }
    .guest-list-section.inhouse-section .section-title { background: linear-gradient(135deg, #8b6d1e, #c9a51a); }
    .guest-list-section.checkout-section .section-title { background: linear-gradient(135deg, #9c7525, #d4a94e); }
    .guest-list-table {
      width: 100%;
      border-collapse: collapse;
    }
    .guest-list-table th {
      background: rgba(240, 237, 230, 0.95);
      padding: 10px 16px;
      text-align: left;
      font-size: 11px;
      font-weight: 600;
      color: #996b2f;
      text-transform: uppercase;
      border-bottom: 1px solid rgba(153, 107, 47, 0.2);
      white-space: nowrap;
    }
    .guest-list-table td {
      padding: 12px 16px;
      border-bottom: 1px solid rgba(153, 107, 47, 0.1);
      font-size: 13px;
      color: #2c2a26;
    }
    .guest-list-table tr:hover { background: rgba(153, 107, 47, 0.05); }
    .guest-list-empty {
      text-align: center;
      padding: 20px;
      color: #9e9688;
      font-size: 13px;
    }

    /* Day Book */
    .daybook-date-bar {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }
    .balance-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    .balance-card {
      padding: 16px 20px;
      border-radius: 12px;
      border: 1px solid rgba(153, 107, 47, 0.15);
      background: #ffffff;
    }
    .balance-card .bc-label {
      font-size: 11px;
      font-weight: 600;
      color: #7a7060;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 6px;
    }
    .balance-card .bc-value {
      font-size: 22px;
      font-weight: 700;
      font-family: 'SF Mono', 'Courier New', monospace;
    }
    .bc-value.blue { color: #996b2f; }
    .bc-value.green { color: #8b6d1e; }
    .bc-value.red { color: #a07a28; }
    .bc-value.orange { color: #9c7525; }

    .daybook-section {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      padding: 24px;
      border-radius: 16px;
      margin-bottom: 24px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.06);
      border: 1px solid rgba(153, 107, 47, 0.2);
    }
    .daybook-section .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
      flex-wrap: wrap;
      gap: 12px;
    }
    .daybook-section h3 {
      font-size: 16px;
      color: #996b2f;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* Attendance Calendar */
    .attendance-calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
      margin-top: 12px;
    }
    .attendance-day {
      text-align: center;
      padding: 8px 4px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s;
      border: 2px solid transparent;
    }
    .attendance-day.header {
      font-weight: 700;
      color: #996b2f;
      font-size: 11px;
      text-transform: uppercase;
      cursor: default;
      background: #ffffff;
    }
    .attendance-day.present {
      background: rgba(16, 185, 129, 0.12);
      color: #059669;
    }
    .attendance-day.present:hover {
      border-color: #059669;
    }
    .attendance-day.absent {
      background: rgba(239, 68, 68, 0.12);
      color: #dc2626;
      font-weight: 700;
    }
    .attendance-day.absent:hover {
      border-color: #dc2626;
    }
    .attendance-day.future {
      background: rgba(0, 0, 0, 0.04);
      color: #b0a898;
      cursor: default;
    }
    .attendance-day.empty {
      cursor: default;
    }

    /* Staff badges */
    .badge-active { background: rgba(16, 185, 129, 0.12); color: #059669; }
    .badge-left { background: rgba(239, 68, 68, 0.12); color: #dc2626; }

    /* Salary table */
    .salary-paid {
      background: rgba(16, 185, 129, 0.12);
      color: #059669;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
    }
    .salary-unpaid {
      background: rgba(245, 158, 11, 0.12);
      color: #b45309;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
    }

    .salary-section {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      padding: 24px;
      border-radius: 16px;
      margin-bottom: 24px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.06);
      border: 1px solid rgba(153, 107, 47, 0.2);
    }
    .salary-section .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
      flex-wrap: wrap;
      gap: 12px;
    }
    .salary-section h3 {
      font-size: 16px;
      color: #996b2f;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .att-summary {
      display: flex;
      gap: 20px;
      margin-top: 12px;
      flex-wrap: wrap;
    }
    .att-summary .att-chip {
      padding: 8px 16px;
      border-radius: 10px;
      font-size: 13px;
      font-weight: 600;
    }
    .att-chip.chip-days { background: rgba(99, 102, 241, 0.1); color: #4338ca; }
    .att-chip.chip-present { background: rgba(16, 185, 129, 0.1); color: #059669; }
    .att-chip.chip-absent { background: rgba(239, 68, 68, 0.1); color: #dc2626; }

    /* Global dark theme overrides for inputs/selects not covered by specific selectors */
    input, select, textarea {
      background: #ffffff;
      color: #2c2a26;
      border-color: rgba(153, 107, 47, 0.3);
    }

    input:focus, select:focus, textarea:focus {
      border-color: #996b2f;
      outline: none;
    }

    /* Scrollbar styling for dark theme */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    ::-webkit-scrollbar-track {
      background: #f0ede6;
    }
    ::-webkit-scrollbar-thumb {
      background: rgba(153, 107, 47, 0.25);
      border-radius: 4px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: rgba(153, 107, 47, 0.4);
    }

    /* Print styles */
    @media print {
      .btn, .actions, .filters-card, .header-actions {
        display: none !important;
      }

      .header {
        background: #1c2038 !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }

      .stat-card::before {
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }
    }

    /* Loading Overlay */
    .loading-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(255, 255, 255, 0.92);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }
    .loading-overlay .spinner {
      width: 48px; height: 48px;
      border: 4px solid #e0dbd0;
      border-top-color: #996b2f;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    .loading-overlay p {
      margin-top: 16px;
      color: #996b2f;
      font-size: 16px;
      font-weight: 600;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>

<body>

  <!-- ===== AUTH: Login Screen ===== -->
  <div id="login-screen" class="auth-screen">
    <div class="auth-card">
      <div class="auth-logo">üè®</div>
      <h2>Login</h2>
      <p>Enter your email and password</p>
      <input type="text" id="loginEmail" placeholder="Email or Phone" onkeydown="if(event.key==='Enter')document.getElementById('loginPassword').focus()">
      <input type="password" id="loginPassword" placeholder="Password" maxlength="4" inputmode="numeric" onkeydown="if(event.key==='Enter')doLogin()">
      <button class="auth-btn" onclick="doLogin()">Login</button>
      <p class="auth-link" onclick="showScreen('forgot-screen')">Forgot Password?</p>
      <p id="loginError" class="error-text" style="display:none"></p>
    </div>
  </div>

  <!-- ===== AUTH: Forgot Password Screen ===== -->
  <div id="forgot-screen" class="auth-screen auth-hidden">
    <div class="auth-card">
      <div class="auth-logo">üîë</div>
      <h2>Forgot Password</h2>
      <p>Enter your registered email address</p>
      <input type="email" id="forgotEmail" placeholder="Email address" onkeydown="if(event.key==='Enter')doForgotPassword()">
      <button class="auth-btn" onclick="doForgotPassword()">Send OTP</button>
      <p class="auth-link" onclick="showScreen('login-screen')">Back to Login</p>
      <p id="forgotError" class="error-text" style="display:none"></p>
    </div>
  </div>

  <!-- ===== AUTH: OTP + Reset Password Screen ===== -->
  <div id="otp-screen" class="auth-screen auth-hidden">
    <div class="auth-card">
      <div class="auth-logo">üîê</div>
      <h2>Reset Password</h2>
      <p>Enter the OTP sent to your email</p>
      <input type="text" id="otpCode" maxlength="6" placeholder="6-digit OTP" inputmode="numeric">
      <input type="password" id="otpNewPin" maxlength="4" placeholder="New 4-digit PIN" inputmode="numeric">
      <input type="password" id="otpConfirmPin" maxlength="4" placeholder="Confirm PIN" inputmode="numeric" onkeydown="if(event.key==='Enter')doVerifyOtp()">
      <button class="auth-btn" onclick="doVerifyOtp()">Reset Password</button>
      <p class="auth-link" onclick="doResendOtp()">Resend OTP</p>
      <p class="auth-link" onclick="showScreen('login-screen')">Back to Login</p>
      <p id="otpError" class="error-text" style="display:none"></p>
    </div>
  </div>

  <div class="app-container" style="display:none">
    <!-- Header -->
    <div class="header">
      <div class="header-brand">
        <span class="icon">üè®</span>
        <div>
          <h1>The Neelkanth Grand</h1>
          <p>by Aks Hospitality &mdash; CRM</p>
        </div>
      </div>
      <div class="header-actions">
        <button class="btn btn-primary" id="btnNewBooking" onclick="openBookingModal()">
          <span class="material-icons">add</span> New Booking
        </button>
        <button class="btn btn-secondary" onclick="exportData()">
          <span class="material-icons">download</span> Export
        </button>
        <button class="btn btn-secondary" onclick="window.print()">
          <span class="material-icons">print</span>
        </button>
        <div class="header-user" id="headerUser">
          <span class="user-name" id="headerUserName"></span>
          <button class="logout-btn" onclick="openChangePassword()">Change PIN</button>
          <button class="logout-btn" onclick="doLogout()">Logout</button>
        </div>
      </div>
    </div>

    <!-- Navigation Tabs -->
    <div class="nav-tabs">
      <button class="active" onclick="switchTab('dashboard')">
        <span class="material-icons">dashboard</span> Dashboard
      </button>
      <button onclick="switchTab('inventory')">
        <span class="material-icons">meeting_room</span> Inventory
      </button>
      <button onclick="switchTab('ledger')">
        <span class="material-icons">account_balance</span> Ledger
      </button>
      <button onclick="switchTab('reports')">
        <span class="material-icons">assessment</span> Reports
      </button>
      <button onclick="switchTab('daybook')">
        <span class="material-icons">menu_book</span> Day Book
      </button>
      <button onclick="switchTab('salary')">
        <span class="material-icons">badge</span> Salary
      </button>
      <button id="tab-btn-users" onclick="switchTab('users')" style="display:none">
        <span class="material-icons">people</span> Users
      </button>
      <button id="tab-btn-audit" onclick="switchTab('audit')" style="display:none">
        <span class="material-icons">history</span> Audit Log
      </button>
    </div>

    <!-- ==================== DASHBOARD TAB ==================== -->
    <div class="tab-content active" id="tab-dashboard">

      <!-- Dashboard Guest Lists -->
      <div class="guest-lists">
        <!-- Today Check-in -->
        <div class="guest-list-section checkin-section">
          <div class="section-title">
            <span class="material-icons">login</span>
            Today Check-in <span id="checkinCount" style="opacity:0.8;font-size:13px;margin-left:4px;">(0)</span>
          </div>
          <div id="checkinGuestList"></div>
        </div>

        <!-- In-House Guests -->
        <div class="guest-list-section inhouse-section">
          <div class="section-title">
            <span class="material-icons">hotel</span>
            In-House Guests <span id="inhouseCount" style="opacity:0.8;font-size:13px;margin-left:4px;">(0)</span>
          </div>
          <div id="inhouseGuestList"></div>
        </div>

        <!-- Today Check-out -->
        <div class="guest-list-section checkout-section">
          <div class="section-title">
            <span class="material-icons">logout</span>
            Today Check-out <span id="checkoutCount" style="opacity:0.8;font-size:13px;margin-left:4px;">(0)</span>
          </div>
          <div id="checkoutGuestList"></div>
        </div>
      </div>

      <!-- Summary Stats -->
      <div class="dashboard">
        <div class="stat-card blue">
          <div class="label">Today Collection</div>
          <div class="value" id="todayCollection">&#8377;0</div>
        </div>
        <div class="stat-card green">
          <div class="label">Today Collected</div>
          <div class="value" id="todayCollected">&#8377;0</div>
        </div>
        <div class="stat-card red">
          <div class="label">Today Pending</div>
          <div class="value" id="todayPending">&#8377;0</div>
        </div>
        <div class="stat-card orange">
          <div class="label">Ledger Due</div>
          <div class="value" id="ledgerDue">&#8377;0</div>
        </div>
      </div>

      <!-- Alert Box -->
      <div class="alert-box" id="alertBox" style="display: none;">
        <span class="material-icons">warning</span>
        <div>
          <h4>Attention Required</h4>
          <p id="alertText"></p>
        </div>
      </div>

      <!-- Summary -->
      <div class="monthly-summary">
        <div class="section-header">
          <h3><span class="material-icons">calendar_month</span> Summary</h3>
          <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
            <label style="font-size:13px;font-weight:600;color:#5c5040;">From</label>
            <input type="date" id="summaryStartDate" onchange="updateMonthlySummary()" style="padding:8px 14px;border:2px solid #e5e7eb;border-radius:10px;font-size:13px;font-family:inherit;">
            <label style="font-size:13px;font-weight:600;color:#5c5040;">To</label>
            <input type="date" id="summaryEndDate" onchange="updateMonthlySummary()" style="padding:8px 14px;border:2px solid #e5e7eb;border-radius:10px;font-size:13px;font-family:inherit;">
            <div style="display:flex;gap:6px;margin-left:8px;">
              <button class="btn btn-secondary btn-small" onclick="downloadSummaryData('csv')" title="Download CSV">
                <span class="material-icons" style="font-size:14px">download</span> CSV
              </button>
              <button class="btn btn-secondary btn-small" onclick="downloadSummaryData('excel')" title="Download Excel">
                <span class="material-icons" style="font-size:14px">table_view</span> Excel
              </button>
              <button class="btn btn-secondary btn-small" onclick="downloadSummaryData('pdf')" title="Download PDF">
                <span class="material-icons" style="font-size:14px">picture_as_pdf</span> PDF
              </button>
            </div>
          </div>
        </div>
        <div class="monthly-grid" id="monthlyGrid" style="grid-template-columns:repeat(auto-fit,minmax(150px,1fr));">
          <div class="monthly-card">
            <div class="mc-label">Bookings</div>
            <div class="mc-value blue" id="monthlyBookings">0</div>
          </div>
          <div class="monthly-card">
            <div class="mc-label">Room Charge</div>
            <div class="mc-value blue" id="summaryRoomCharge">&#8377;0</div>
          </div>
          <div class="monthly-card">
            <div class="mc-label">KOT</div>
            <div class="mc-value blue" id="summaryKot">&#8377;0</div>
          </div>
          <div class="monthly-card">
            <div class="mc-label">Add-On</div>
            <div class="mc-value blue" id="summaryAddOn">&#8377;0</div>
          </div>
          <div class="monthly-card">
            <div class="mc-label">Total Collection</div>
            <div class="mc-value blue" id="monthlyCollection">&#8377;0</div>
          </div>
          <div class="monthly-card">
            <div class="mc-label">Collected</div>
            <div class="mc-value green" id="monthlyCollected">&#8377;0</div>
          </div>
          <div class="monthly-card">
            <div class="mc-label">Pending</div>
            <div class="mc-value red" id="monthlyPending">&#8377;0</div>
          </div>
        </div>
      </div>

      <!-- Ledger Summary removed from dashboard -->

      <!-- Filters -->
      <div class="filters-card">
        <div class="filters-row">
          <div class="filter-group">
            <label>View By</label>
            <select id="filterViewBy" onchange="applyFilters()">
              <option value="checkout">Check-out</option>
              <option value="checkin">Check-in</option>
              <option value="sameday">Same Day</option>
            </select>
          </div>
          <div class="filter-group">
            <label>Date</label>
            <input type="date" id="filterDate" onchange="applyFilters()">
          </div>
          <div class="filter-group">
            <label>Status</label>
            <select id="filterStatus" onchange="applyFilters()">
              <option value="">All Status</option>
              <option value="PENDING">Pending</option>
              <option value="PARTIAL">Partial</option>
              <option value="COLLECTED">Collected</option>
              <option value="CANCELLED">Cancelled</option>
              <option value="RESCHEDULED">Rescheduled</option>
            </select>
          </div>
          <div class="filter-group">
            <label>Payment Type</label>
            <select id="filterPaymentType" onchange="applyFilters()">
              <option value="">All Types</option>
              <option value="Prepaid">Prepaid</option>
              <option value="Pay at Check-in">Pay at Check-in</option>
              <option value="Postpaid">Postpaid</option>
              <option value="Ledger">Ledger</option>
            </select>
          </div>
          <div class="filter-group">
            <label>Source</label>
            <select id="filterSource" onchange="applyFilters()">
              <option value="">All Sources</option>
              <option value="Walk-in">Walk-in</option>
              <option value="OTA">OTA</option>
              <option value="Agent">Agent</option>
            </select>
          </div>
          <div class="filter-group">
            <label>Agent</label>
            <select id="filterAgent" onchange="applyFilters()">
              <option value="">All Agents</option>
              <option value="Focus">Focus</option>
              <option value="Global">Global</option>
              <option value="Globe India">Globe India</option>
              <option value="Holiday7">Holiday7</option>
              <option value="Ultimate">Ultimate</option>
              <option value="Minto">Minto</option>
              <option value="Jatin TA">Jatin TA</option>
              <option value="Himalayan Queen">Himalayan Queen</option>
              <option value="MMT">MMT</option>
              <option value="My Vacation">My Vacation</option>
              <option value="MIH">MIH</option>
              <option value="Royal Sunshine">Royal Sunshine</option>
              <option value="Gyanrachanatour">Gyanrachanatour</option>
              <option value="Self">Self</option>
              <option value="Walking">Walking</option>
              <option value="AKS">AKS</option>
              <option value="Raisooone">Raisooone</option>
              <option value="Legendyatri">Legendyatri</option>
              <option value="AKS Office">AKS Office</option>
            </select>
          </div>
          <div class="filter-group">
            <label>&nbsp;</label>
            <button class="btn btn-secondary btn-small" onclick="clearFilters()">
              <span class="material-icons">clear</span> Clear
            </button>
          </div>
          <div class="filter-group">
            <label>&nbsp;</label>
            <button class="btn btn-warning btn-small" onclick="showTodayPending()">
              <span class="material-icons">today</span> Today's Pending
            </button>
          </div>
        </div>
      </div>

      <!-- Bookings Table -->
      <div class="table-card">
        <div class="table-header">
          <h2>Bookings</h2>
          <span class="record-count" id="recordCount">0 records</span>
        </div>
        <div class="table-wrapper" id="tableWrapper">
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Guest</th>
                <th>Pax</th>
                <th>Room</th>
                <th>Source</th>
                <th>Check-in</th>
                <th>Checkout</th>
                <th>Nights</th>
                <th>Type</th>
                <th>Room Rent</th>
                <th>Collection</th>
                <th>Received</th>
                <th>Pending</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="bookingsTable"></tbody>
          </table>
        </div>
        <div class="empty-state" id="emptyState" style="display: none;">
          <span class="material-icons">inbox</span>
          <h3>No bookings found</h3>
          <p>Add your first booking or adjust filters</p>
        </div>
      </div>

    </div><!-- end tab-dashboard -->

    <!-- ==================== INVENTORY TAB ==================== -->
    <div class="tab-content" id="tab-inventory">
      <div class="inventory-section">
        <div class="section-header">
          <h3><span class="material-icons">meeting_room</span> Room Inventory</h3>
          <div class="report-filters">
            <input type="date" id="inventoryDate" onchange="renderInventory()">
            <input type="month" class="month-selector" id="inventoryMonth" onchange="renderInventory()">
          </div>
        </div>
        <div class="inv-summary-row">
          <div class="inv-chip"><span class="dot dot-vacant"></span> Vacant</div>
          <div class="inv-chip"><span class="dot dot-occupied"></span> Occupied</div>
          <div class="inv-chip" id="invTodaySummary" style="font-weight:700;color:#996b2f;"></div>
        </div>
        <!-- Day view -->
        <div id="inventoryDayView" style="margin-bottom:24px;"></div>
        <!-- Month grid -->
        <div class="inv-table-wrap" id="inventoryTableWrap"></div>
      </div>

      <!-- Occupancy Report -->
      <div class="inventory-section">
        <div class="section-header">
          <h3><span class="material-icons">bar_chart</span> Occupancy Report</h3>
          <div class="report-filters">
            <select id="occViewType" onchange="toggleOccFilters();renderOccupancyReport()" style="padding:8px 14px;border:2px solid #e5e7eb;border-radius:10px;font-size:13px;font-family:inherit;">
              <option value="month">Monthly</option>
              <option value="year">Yearly</option>
              <option value="custom">Custom Dates</option>
            </select>
            <input type="month" id="occMonth" onchange="renderOccupancyReport()" style="padding:8px 14px;border:2px solid #e5e7eb;border-radius:10px;font-size:13px;font-family:inherit;">
            <select id="occYear" onchange="renderOccupancyReport()" style="padding:8px 14px;border:2px solid #e5e7eb;border-radius:10px;font-size:13px;font-family:inherit;display:none;"></select>
            <input type="date" id="occFrom" onchange="renderOccupancyReport()" style="padding:8px 14px;border:2px solid #e5e7eb;border-radius:10px;font-size:13px;font-family:inherit;display:none;">
            <span id="occToLabel" style="color:#6b7280;font-size:13px;display:none;">to</span>
            <input type="date" id="occTo" onchange="renderOccupancyReport()" style="padding:8px 14px;border:2px solid #e5e7eb;border-radius:10px;font-size:13px;font-family:inherit;display:none;">
          </div>
        </div>
        <div id="occupancyReportContent"></div>
      </div>
    </div>

    <!-- ==================== LEDGER TAB ==================== -->
    <div class="tab-content" id="tab-ledger">
      <div class="reports-section">
        <div class="section-header">
          <h3><span class="material-icons">account_balance</span> Agent Ledger Report</h3>
          <div class="report-filters">
            <select id="ledgerAgent" onchange="renderLedgerReport()">
              <option value="">All Agents</option>
              <option value="Focus">Focus</option>
              <option value="Global">Global</option>
              <option value="Globe India">Globe India</option>
              <option value="Holiday7">Holiday7</option>
              <option value="Ultimate">Ultimate</option>
              <option value="Minto">Minto</option>
              <option value="Jatin TA">Jatin TA</option>
              <option value="Himalayan Queen">Himalayan Queen</option>
              <option value="MMT">MMT</option>
              <option value="My Vacation">My Vacation</option>
              <option value="MIH">MIH</option>
              <option value="Royal Sunshine">Royal Sunshine</option>
              <option value="Gyanrachanatour">Gyanrachanatour</option>
              <option value="Self">Self</option>
              <option value="Walking">Walking</option>
              <option value="AKS">AKS</option>
              <option value="Raisooone">Raisooone</option>
              <option value="Legendyatri">Legendyatri</option>
              <option value="AKS Office">AKS Office</option>
            </select>
            <input type="date" id="ledgerFrom" onchange="renderLedgerReport()">
            <span style="color:#6b7280;font-size:13px;">to</span>
            <input type="date" id="ledgerTo" onchange="renderLedgerReport()">
            <button class="btn btn-secondary btn-small" onclick="exportLedgerCSV()">
              <span class="material-icons" style="font-size:14px">download</span> Export
            </button>
          </div>
        </div>
        <!-- Summary cards -->
        <div class="monthly-grid" id="ledgerSummaryCards" style="margin-bottom:20px;"></div>
        <!-- Detail table -->
        <div id="ledgerReportContent"></div>
      </div>
    </div>

    <!-- ==================== REPORTS TAB ==================== -->
    <div class="tab-content" id="tab-reports">

      <!-- Source-wise Report -->
      <div class="reports-section">
        <div class="section-header">
          <h3><span class="material-icons">pie_chart</span> Source-wise Report</h3>
          <div class="report-filters">
            <input type="date" id="reportDateFrom" onchange="renderSourceReport()">
            <span style="color:#6b7280;font-size:13px;">to</span>
            <input type="date" id="reportDateTo" onchange="renderSourceReport()">
          </div>
        </div>
        <div id="sourceReportContent"></div>
      </div>

      <!-- Day-wise Payment Report -->
      <div class="reports-section">
        <div class="section-header">
          <h3><span class="material-icons">payments</span> Day-wise Payment Collection</h3>
          <div class="report-filters">
            <input type="date" id="payReportFrom" onchange="renderPaymentReport()">
            <span style="color:#6b7280;font-size:13px;">to</span>
            <input type="date" id="payReportTo" onchange="renderPaymentReport()">
          </div>
        </div>
        <div id="paymentReportContent"></div>
      </div>

      <!-- Monthly Report -->
      <div class="reports-section">
        <div class="section-header">
          <h3><span class="material-icons">calendar_month</span> Monthly Report</h3>
          <div class="report-filters">
            <input type="month" id="reportMonth" onchange="renderMonthlyReport()">
          </div>
        </div>
        <div id="monthlyReportContent"></div>
      </div>

      <!-- Profit & Loss Report -->
      <div class="reports-section">
        <div class="section-header">
          <h3><span class="material-icons">account_balance</span> Monthly Profit & Loss</h3>
        </div>
        <div class="report-filters" style="display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end;margin-bottom:16px;">
          <div class="filter-group">
            <label>View</label>
            <select id="pnlFilterType" onchange="updatePnlFilterInputs()">
              <option value="calendar">Calendar Year (Jan-Dec)</option>
              <option value="financial">Financial Year (Apr-Mar)</option>
              <option value="custom">Custom Range</option>
            </select>
          </div>
          <div class="filter-group" id="pnlCalYearGroup">
            <label>Calendar Year</label>
            <select id="pnlCalYear">
              <option value="2025">2025</option>
              <option value="2026" selected>2026</option>
              <option value="2027">2027</option>
              <option value="2028">2028</option>
              <option value="2029">2029</option>
              <option value="2030">2030</option>
            </select>
          </div>
          <div class="filter-group" id="pnlFYGroup" style="display:none;">
            <label>Financial Year</label>
            <select id="pnlFY">
              <option value="2025">FY 2025-26</option>
              <option value="2026" selected>FY 2026-27</option>
              <option value="2027">FY 2027-28</option>
              <option value="2028">FY 2028-29</option>
              <option value="2029">FY 2029-30</option>
            </select>
          </div>
          <div class="filter-group" id="pnlCustomFromGroup" style="display:none;">
            <label>From</label>
            <input type="date" id="pnlCustomFrom">
          </div>
          <div class="filter-group" id="pnlCustomToGroup" style="display:none;">
            <label>To</label>
            <input type="date" id="pnlCustomTo">
          </div>
          <button class="btn btn-primary btn-small" onclick="renderPnlReport()">
            <span class="material-icons" style="font-size:14px">search</span> Generate
          </button>
        </div>
        <div id="pnlReportContent" style="overflow-x:auto;"></div>
      </div>

    </div><!-- end tab-reports -->

    <!-- ==================== DAY BOOK TAB ==================== -->
    <div class="tab-content" id="tab-daybook">
      <!-- Date Bar -->
      <div class="daybook-date-bar">
        <div class="filter-group">
          <label>Date</label>
          <input type="date" id="daybookDate" onchange="renderDayBook()">
        </div>
        <button class="btn btn-secondary btn-small" id="btnSetOpeningBalance" onclick="openSetBalanceModal()">
          <span class="material-icons" style="font-size:14px">account_balance_wallet</span> Set Opening Balance
        </button>
      </div>

      <!-- Balance Cards -->
      <div class="balance-cards">
        <div class="balance-card" id="cardCashOpening">
          <div class="bc-label">Cash Opening</div>
          <div class="bc-value blue" id="dbCashOpening">&#8377;0</div>
        </div>
        <div class="balance-card" id="cardBankOpening">
          <div class="bc-label">Bank (SBI Neelkanth) Opening</div>
          <div class="bc-value blue" id="dbBankOpening">&#8377;0</div>
        </div>
        <div class="balance-card">
          <div class="bc-label">Cash Closing</div>
          <div class="bc-value green" id="dbCashClosing">&#8377;0</div>
        </div>
        <div class="balance-card">
          <div class="bc-label">Bank (SBI Neelkanth) Closing</div>
          <div class="bc-value green" id="dbBankClosing">&#8377;0</div>
        </div>
      </div>

      <!-- Income Section -->
      <div class="daybook-section">
        <div class="section-header">
          <h3><span class="material-icons">arrow_downward</span> Income</h3>
          <div style="display:flex;gap:8px;flex-wrap:wrap;">
            <button class="btn btn-primary btn-small" onclick="autoCollectDayBookIncome()">
              <span class="material-icons" style="font-size:14px">sync</span> Auto-Collect from Bookings
            </button>
            <button class="btn btn-secondary btn-small" onclick="openManualIncomeModal()">
              <span class="material-icons" style="font-size:14px">add</span> Add Manual Income
            </button>
          </div>
        </div>
        <div class="table-wrapper">
          <table class="report-table">
            <thead>
              <tr>
                <th>Source</th>
                <th>Description</th>
                <th>Amount</th>
                <th>Mode</th>
                <th>Received In</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="dayBookIncomeTable"></tbody>
          </table>
        </div>
        <div style="padding:12px 16px;background:rgba(201,169,110,0.1);border-radius:8px;margin-top:12px;display:flex;justify-content:space-between;font-weight:700;color:#996b2f;">
          <span>Total Income</span>
          <span id="dbTotalIncome">&#8377;0</span>
        </div>
      </div>

      <!-- Expense Section -->
      <div class="daybook-section">
        <div class="section-header">
          <h3><span class="material-icons">arrow_upward</span> Expenses</h3>
          <button class="btn btn-danger btn-small" onclick="openAddExpenseModal()">
            <span class="material-icons" style="font-size:14px">add</span> Add Expense
          </button>
        </div>
        <div class="table-wrapper">
          <table class="report-table">
            <thead>
              <tr>
                <th>Category</th>
                <th>Sub-Item</th>
                <th>Description</th>
                <th>Amount</th>
                <th>Payment From</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="dayBookExpenseTable"></tbody>
          </table>
        </div>
        <div style="padding:12px 16px;background:#fee2e2;border-radius:8px;margin-top:12px;display:flex;justify-content:space-between;font-weight:700;color:#991b1b;">
          <span>Total Expenses</span>
          <span id="dbTotalExpense">&#8377;0</span>
        </div>
      </div>

      <!-- Daily Closing Report -->
      <div class="daybook-section">
        <div class="section-header">
          <h3><span class="material-icons">summarize</span> Daily Closing Balance</h3>
        </div>
        <div class="table-wrapper">
          <table class="report-table" id="dayBookClosingTable">
            <thead>
              <tr>
                <th></th>
                <th>Cash</th>
                <th>Bank Transfer</th>
                <th>Total</th>
              </tr>
            </thead>
            <tbody id="dayBookClosingBody"></tbody>
          </table>
        </div>
      </div>
    </div><!-- end tab-daybook -->

    <!-- ==================== SALARY TAB ==================== -->
    <div class="tab-content" id="tab-salary">

      <!-- Staff List -->
      <div class="salary-section">
        <div class="section-header">
          <h3><span class="material-icons">people</span> Staff List</h3>
          <button class="btn btn-primary btn-small" onclick="openAddStaffModal()">
            <span class="material-icons" style="font-size:14px">person_add</span> New Joining
          </button>
        </div>
        <div class="table-wrapper">
          <table class="report-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Designation</th>
                <th>Monthly Salary</th>
                <th>Date of Joining</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="staffListTable"></tbody>
          </table>
        </div>
      </div>

      <!-- Attendance Section -->
      <div class="salary-section">
        <div class="section-header">
          <h3><span class="material-icons">event_available</span> Attendance</h3>
          <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
            <select id="attEmployee" onchange="renderAttendance()" style="padding:8px 14px;border:2px solid #e5e7eb;border-radius:10px;font-size:13px;font-family:inherit;">
              <option value="">Select Employee</option>
            </select>
            <input type="month" id="attMonth" onchange="renderAttendance()" style="padding:8px 14px;border:2px solid #e5e7eb;border-radius:10px;font-size:13px;font-family:inherit;">
          </div>
        </div>
        <div id="attendanceCalendar"></div>
        <div class="att-summary" id="attendanceSummary"></div>
      </div>

      <!-- Salary Advance Section -->
      <div class="salary-section">
        <div class="section-header">
          <h3><span class="material-icons">money</span> Salary Advances</h3>
          <button class="btn btn-warning btn-small" onclick="openAddAdvanceModal()">
            <span class="material-icons" style="font-size:14px">add</span> Record Advance
          </button>
        </div>
        <div class="table-wrapper">
          <table class="report-table">
            <thead>
              <tr>
                <th>Employee</th>
                <th>Amount</th>
                <th>Date</th>
                <th>Deduct From Month</th>
                <th>Remarks</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="advanceListTable"></tbody>
          </table>
        </div>
      </div>

      <!-- Salary Calculation -->
      <div class="salary-section">
        <div class="section-header">
          <h3><span class="material-icons">calculate</span> Salary Calculation</h3>
          <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
            <input type="month" id="salaryCalcMonth" onchange="renderSalaryCalculation()" style="padding:8px 14px;border:2px solid #e5e7eb;border-radius:10px;font-size:13px;font-family:inherit;">
          </div>
        </div>
        <div class="table-wrapper">
          <table class="report-table">
            <thead>
              <tr>
                <th>Employee</th>
                <th>Designation</th>
                <th>Monthly Salary</th>
                <th>Days</th>
                <th>Present</th>
                <th>Absent</th>
                <th>Per Day</th>
                <th>Gross</th>
                <th>Advance</th>
                <th>Net Payable</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="salaryCalcTable"></tbody>
          </table>
        </div>
      </div>

    </div><!-- end tab-salary -->

    <!-- ==================== USERS TAB (Admin Only) ==================== -->
    <div class="tab-content" id="tab-users">
      <div class="section-card" style="padding:24px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
          <h2>User Management</h2>
          <button class="btn btn-primary" onclick="openUserModal()"><span class="material-icons">person_add</span> Add User</button>
        </div>
        <table class="data-table" style="width:100%">
          <thead><tr><th>Name</th><th>Email</th><th>Phone</th><th>Role</th><th>Status</th><th>Permissions</th><th>Actions</th></tr></thead>
          <tbody id="usersTableBody"></tbody>
        </table>
      </div>
    </div>

    <!-- ==================== AUDIT TAB (Admin Only) ==================== -->
    <div class="tab-content" id="tab-audit">
      <div class="section-card" style="padding:24px">
        <h2 style="margin-bottom:16px">Audit Log</h2>
        <div style="display:flex;gap:12px;margin-bottom:20px;flex-wrap:wrap">
          <select id="auditEntityFilter" onchange="loadAuditLogs()" style="padding:8px 12px;border-radius:8px;border:1px solid #ddd">
            <option value="">All Types</option>
            <option value="booking">Bookings</option>
            <option value="daybook">Daybook</option>
            <option value="staff">Staff</option>
            <option value="attendance">Attendance</option>
            <option value="salary_advance">Advances</option>
            <option value="user">Users</option>
          </select>
          <input type="date" id="auditFrom" onchange="loadAuditLogs()" style="padding:8px 12px;border-radius:8px;border:1px solid #ddd">
          <input type="date" id="auditTo" onchange="loadAuditLogs()" style="padding:8px 12px;border-radius:8px;border:1px solid #ddd">
        </div>
        <table class="data-table" style="width:100%">
          <thead><tr><th>Time</th><th>User</th><th>Action</th><th>Type</th><th>ID</th><th>Description</th></tr></thead>
          <tbody id="auditTableBody"></tbody>
        </table>
        <div id="auditPagination" style="margin-top:16px;text-align:center"></div>
      </div>
    </div>

    <!-- User Modal -->
    <div class="modal-overlay" id="userModal">
      <div class="modal" style="max-width:500px">
        <div class="modal-header">
          <h3 id="userModalTitle">Add User</h3>
          <button class="modal-close" onclick="closeModal('userModal')">&times;</button>
        </div>
        <div class="modal-body">
          <div class="form-group"><label>Name</label><input type="text" id="userName" placeholder="Full name"></div>
          <div class="form-group"><label>Email</label><input type="email" id="userEmail" placeholder="user@email.com"></div>
          <div class="form-group"><label>Phone</label><input type="text" id="userPhone" placeholder="Phone (optional)"></div>
          <div class="form-group"><label>Role</label>
            <select id="userRole"><option value="staff">Staff</option><option value="admin">Admin</option></select>
          </div>
          <div class="form-group" id="permissionsGroup">
            <label>Permissions (select sections this user can access)</label>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px" id="permCheckboxes">
              <label><input type="checkbox" data-section="dashboard" checked> Dashboard</label>
              <label><input type="checkbox" data-section="bookings"> Bookings</label>
              <label><input type="checkbox" data-section="inventory"> Inventory</label>
              <label><input type="checkbox" data-section="ledger"> Ledger</label>
              <label><input type="checkbox" data-section="reports"> Reports</label>
              <label><input type="checkbox" data-section="daybook"> Day Book</label>
              <label><input type="checkbox" data-section="salary"> Salary</label>
              <label><input type="checkbox" data-section="staff"> Staff</label>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="closeModal('userModal')">Cancel</button>
          <button class="btn btn-primary" onclick="saveUser()">Save User</button>
        </div>
      </div>
    </div>

    <!-- Change Password Modal -->
    <div class="modal-overlay" id="changePinModal">
      <div class="modal" style="max-width:400px">
        <div class="modal-header">
          <h3>Change Password</h3>
          <button class="modal-close" onclick="closeModal('changePinModal')">&times;</button>
        </div>
        <div class="modal-body">
          <div class="form-group"><label>Current Password</label><input type="password" id="cpOldPin" maxlength="4" inputmode="numeric" placeholder="Current 4-digit PIN"></div>
          <div class="form-group"><label>New Password</label><input type="password" id="cpNewPin" maxlength="4" inputmode="numeric" placeholder="New 4-digit PIN"></div>
          <div class="form-group"><label>Confirm New Password</label><input type="password" id="cpConfirmPin" maxlength="4" inputmode="numeric" placeholder="Confirm new PIN"></div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="closeModal('changePinModal')">Cancel</button>
          <button class="btn btn-primary" onclick="doChangePassword()">Change Password</button>
        </div>
      </div>
    </div>

  </div>

  <!-- Booking Modal -->
  <div class="modal-overlay" id="bookingModal">
    <div class="modal">
      <div class="modal-header">
        <h3 id="modalTitle">New Booking</h3>
        <button class="modal-close" onclick="closeBookingModal()">
          <span class="material-icons">close</span>
        </button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="editBookingId">

        <div class="form-row">
          <div class="form-group">
            <label>Guest Name *</label>
            <input type="text" id="guestName" placeholder="Enter guest name">
          </div>
          <div class="form-group">
            <label>Phone</label>
            <input type="tel" id="guestPhone" placeholder="Mobile number">
          </div>
          <div class="form-group">
            <label>Pax</label>
            <input type="number" id="pax" placeholder="No. of guests" min="1" value="1">
          </div>
          <div class="form-group">
            <label>KOT</label>
            <select id="kot">
              <option value="">None</option>
              <option value="Yes">Yes</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>No. of Rooms</label>
            <input type="number" id="noOfRooms" min="1" value="1" onchange="updateRoomSelects()">
          </div>
          <div class="form-group">
            <label>Room Category</label>
            <select id="roomCategory">
              <option value="">Select</option>
              <option value="Non-Balcony">Non-Balcony</option>
              <option value="Balcony">Balcony</option>
              <option value="Royal Suite Duplex">Royal Suite Duplex</option>
              <option value="Mini Duplex">Mini Duplex</option>
            </select>
          </div>
          <div class="form-group" id="roomSelectGroup" style="grid-column: span 2; display:none;">
            <label>Room Number(s)</label>
            <div id="roomSelectContainer" style="display:flex;flex-wrap:wrap;gap:8px;">
              <select id="roomNo" style="min-width:160px;">
                <option value="">Not Assigned</option>
              </select>
            </div>
            <div class="room-avail-hint" id="roomAvailHint"></div>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Check-in *</label>
            <input type="date" id="checkIn" onchange="updateRoomAvailability();updateNightsDisplay()">
          </div>
          <div class="form-group">
            <label>Checkout *</label>
            <input type="date" id="checkOut" onchange="updateRoomAvailability();updateNightsDisplay()">
          </div>
          <div class="form-group">
            <label>Nights</label>
            <div id="nightsDisplay" style="font-size:20px;font-weight:700;color:#996b2f;background:rgba(201,169,110,0.15);padding:10px 14px;border-radius:10px;text-align:center;">-</div>
          </div>
          <div class="form-group">
            <label>Plan</label>
            <select id="mealPlan">
              <option value="">Select</option>
              <option value="EP">EP (Room Only)</option>
              <option value="CP">CP (Breakfast)</option>
              <option value="MAP">MAP (Breakfast + Dinner)</option>
              <option value="AP">AP (All Meals)</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Booking Source *</label>
            <select id="bookingSource" onchange="toggleSourceName()">
              <option value="Walk-in">Walk-in</option>
              <option value="OTA">OTA</option>
              <option value="Agent">Agent</option>
            </select>
          </div>
          <div class="form-group" id="sourceNameGroup" style="display: none;">
            <label>Agent / Source Name *</label>
            <select id="sourceName">
              <option value="">Select</option>
              <option value="Focus">Focus</option>
              <option value="Global">Global</option>
              <option value="Globe India">Globe India</option>
              <option value="Holiday7">Holiday7</option>
              <option value="Ultimate">Ultimate</option>
              <option value="Minto">Minto</option>
              <option value="Jatin TA">Jatin TA</option>
              <option value="Himalayan Queen">Himalayan Queen</option>
              <option value="MMT">MMT</option>
              <option value="My Vacation">My Vacation</option>
              <option value="MIH">MIH</option>
              <option value="Royal Sunshine">Royal Sunshine</option>
              <option value="Gyanrachanatour">Gyanrachanatour</option>
              <option value="Self">Self</option>
              <option value="Walking">Walking</option>
              <option value="AKS">AKS</option>
              <option value="Raisooone">Raisooone</option>
              <option value="Legendyatri">Legendyatri</option>
              <option value="AKS Office">AKS Office</option>
              <option value="Other">Other (type below)</option>
            </select>
            <input type="text" id="sourceNameOther" placeholder="Type name if Other..." style="display:none;margin-top:6px;">
          </div>
          <div class="form-group">
            <label>Add-On</label>
            <select id="complimentary">
              <option value="">None</option>
              <option value="HM">HM (Honeymoon)</option>
              <option value="BF">BF (Birthday)</option>
              <option value="BF+DJ">BF+DJ (Birthday + DJ)</option>
              <option value="Only Cake">Only Cake</option>
              <option value="Heater">Heater</option>
              <option value="Bonfire">Bonfire</option>
              <option value="BJ">BJ (Bonfire + Jalebi)</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Actual Room Rent</label>
            <input type="number" id="actualRoomRent" placeholder="&#8377;" min="0">
          </div>
          <div class="form-group">
            <label>Collection Amount *</label>
            <input type="number" id="totalAmount" placeholder="&#8377;" min="0">
          </div>
          <div class="form-group">
            <label>Payment Type *</label>
            <select id="paymentType">
              <option value="Prepaid">Prepaid (Paid in advance)</option>
              <option value="Pay at Check-in">Pay at Check-in</option>
              <option value="Postpaid">Postpaid (Pay at checkout)</option>
              <option value="Ledger">Ledger (Agent credit)</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Advance Received</label>
            <input type="number" id="advanceReceived" placeholder="&#8377;" min="0" value="0">
          </div>
          <div class="form-group">
            <label>Payment Mode</label>
            <select id="paymentMode">
              <option value="">Select</option>
              <option value="Cash">Cash</option>
              <option value="Card">Card</option>
              <option value="Bank Transfer">Bank Transfer (SBI Neelkanth)</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label>Remarks</label>
          <input type="text" id="remarks" placeholder="Any notes...">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeBookingModal()">Cancel</button>
        <button class="btn btn-primary" onclick="saveBooking()" id="saveBtn">
          <span class="material-icons">save</span> Save Booking
        </button>
      </div>
    </div>
  </div>

  <!-- Collect Payment Modal -->
  <div class="modal-overlay" id="collectModal">
    <div class="modal" style="max-width: 420px;">
      <div class="modal-header">
        <h3>Collect Payment</h3>
        <button class="modal-close" onclick="closeCollectModal()">
          <span class="material-icons">close</span>
        </button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="collectBookingId">
        <p style="margin-bottom: 20px; font-size: 16px;">
          Pending Amount: <strong style="color: #ef4444;" id="collectPendingAmount">&#8377;0</strong>
        </p>
        <div class="form-group" style="margin-bottom: 16px;">
          <label>Amount Collecting *</label>
          <input type="number" id="collectAmount" min="0" placeholder="&#8377;">
        </div>
        <div class="form-group">
          <label>Payment Mode *</label>
          <select id="collectPaymentMode">
            <option value="Cash">Cash</option>
            <option value="Card">Card</option>
            <option value="Bank Transfer">Bank Transfer (SBI Neelkanth)</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeCollectModal()">Cancel</button>
        <button class="btn btn-primary" onclick="collectPayment()">
          <span class="material-icons">payments</span> Collect
        </button>
      </div>
    </div>
  </div>

  <!-- Cancel / Reschedule Modal -->
  <div class="modal-overlay" id="cancelModal">
    <div class="modal" style="max-width: 480px;">
      <div class="modal-header">
        <h3>Cancel / Reschedule Booking</h3>
        <button class="modal-close" onclick="closeCancelModal()">
          <span class="material-icons">close</span>
        </button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="cancelBookingId">
        <p style="margin-bottom:8px;font-size:15px;">
          Booking: <strong id="cancelBookingName"></strong>
        </p>
        <p style="margin-bottom:20px;font-size:14px;color:#6b7280;">
          Current Checkout: <strong id="cancelBookingDate"></strong>
        </p>

        <div class="form-group" style="margin-bottom:16px;">
          <label>Action</label>
          <select id="cancelAction" onchange="toggleRescheduleDate()">
            <option value="cancel">Cancel Booking</option>
            <option value="reschedule">Reschedule (New Date)</option>
          </select>
        </div>

        <div class="form-group" id="rescheduleDateGroup" style="display:none;">
          <label>New Checkout Date *</label>
          <input type="date" id="rescheduleDate">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeCancelModal()">Back</button>
        <button class="btn btn-danger" id="cancelConfirmBtn" onclick="confirmCancelOrReschedule()">
          <span class="material-icons">cancel</span> Cancel Booking
        </button>
      </div>
    </div>
  </div>

  <!-- Check-in / Room Allotment Modal -->
  <div class="modal-overlay" id="checkinModal">
    <div class="modal" style="max-width: 500px;">
      <div class="modal-header">
        <h3>Check-in &amp; Room Allotment</h3>
        <button class="modal-close" onclick="closeCheckinModal()">
          <span class="material-icons">close</span>
        </button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="checkinBookingId">
        <div id="checkinGuestInfo" style="margin-bottom:20px;padding:16px;background:rgba(20,20,40,0.6);border-radius:12px;"></div>
        <div class="form-row">
          <div class="form-group">
            <label>No. of Rooms</label>
            <input type="number" id="checkinNoOfRooms" min="1" value="1" onchange="updateCheckinRoomSelects()">
          </div>
          <div class="form-group">
            <label>Room Category</label>
            <div id="checkinRoomCategory" style="font-weight:600;padding:10px 0;"></div>
          </div>
        </div>
        <div class="form-group" style="margin-bottom:16px;">
          <label>Allot Room Number(s) *</label>
          <div id="checkinRoomSelectContainer" style="display:flex;flex-wrap:wrap;gap:8px;margin-top:6px;"></div>
          <div class="room-avail-hint" id="checkinRoomHint" style="margin-top:6px;"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeCheckinModal()">Cancel</button>
        <button class="btn btn-primary" onclick="confirmCheckin()">
          <span class="material-icons">login</span> Check-in Done
        </button>
      </div>
    </div>
  </div>

  <!-- Checkout Modal -->
  <div class="modal-overlay" id="checkoutModal">
    <div class="modal" style="max-width: 560px;">
      <div class="modal-header">
        <h3>Guest Check-out</h3>
        <button class="modal-close" onclick="closeCheckoutModal()">
          <span class="material-icons">close</span>
        </button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="checkoutBookingId">
        <div id="checkoutGuestInfo" style="margin-bottom:20px;padding:16px;background:rgba(20,20,40,0.6);border-radius:12px;"></div>

        <div class="form-row">
          <div class="form-group">
            <label>KOT Amount</label>
            <input type="number" id="checkoutKotAmount" placeholder="&#8377;" min="0" value="0" oninput="updateCheckoutTotals()">
          </div>
        </div>

        <div style="margin-bottom:16px;">
          <label style="font-size:13px;font-weight:600;color:#5c5040;display:block;margin-bottom:8px;">Add-On Charges</label>
          <div id="addOnChargesContainer"></div>
          <button class="btn btn-secondary btn-small" onclick="addAddOnRow()" style="margin-top:8px;">
            <span class="material-icons" style="font-size:14px">add</span> Add Item
          </button>
        </div>

        <div style="padding:16px;background:rgba(20,20,40,0.6);border-radius:12px;">
          <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
            <span>Original Total:</span>
            <strong id="checkoutOrigTotal">&#8377;0</strong>
          </div>
          <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
            <span>+ KOT Amount:</span>
            <strong id="checkoutKotDisplay">&#8377;0</strong>
          </div>
          <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
            <span>+ Add-On Total:</span>
            <strong id="checkoutAddOnDisplay">&#8377;0</strong>
          </div>
          <div style="display:flex;justify-content:space-between;border-top:2px solid #1e3a5f;padding-top:8px;font-size:16px;">
            <span>Grand Total:</span>
            <strong style="color:#996b2f" id="checkoutGrandTotal">&#8377;0</strong>
          </div>
          <div style="display:flex;justify-content:space-between;margin-top:8px;">
            <span>Already Received:</span>
            <strong style="color:#10b981" id="checkoutReceived">&#8377;0</strong>
          </div>
          <div style="display:flex;justify-content:space-between;margin-top:8px;font-size:16px;">
            <span>Balance Due:</span>
            <strong style="color:#ef4444" id="checkoutBalance">&#8377;0</strong>
          </div>
        </div>

        <div class="form-row" style="margin-top:16px;">
          <div class="form-group">
            <label>Collect Balance - Payment Mode</label>
            <select id="checkoutPayMode">
              <option value="">No Collection Now</option>
              <option value="Cash">Cash</option>
              <option value="Card">Card</option>
              <option value="Bank Transfer">Bank Transfer (SBI Neelkanth)</option>
            </select>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeCheckoutModal()">Cancel</button>
        <button class="btn btn-primary" onclick="processCheckout()">
          <span class="material-icons">logout</span> Check Out
        </button>
      </div>
    </div>
  </div>

  <!-- Set Opening Balance Modal -->
  <div class="modal-overlay" id="setBalanceModal">
    <div class="modal" style="max-width: 460px;">
      <div class="modal-header">
        <h3>Set Opening Balance</h3>
        <button class="modal-close" onclick="closeModal('setBalanceModal')">
          <span class="material-icons">close</span>
        </button>
      </div>
      <div class="modal-body">
        <p style="margin-bottom:16px;font-size:13px;color:#6b7280;">Set opening balance for: <strong id="balanceModalDate"></strong></p>
        <div class="form-group" style="margin-bottom:16px;">
          <label>Cash Opening (&#8377;)</label>
          <input type="number" id="balCashOpening" min="0" placeholder="0">
        </div>
        <div class="form-group">
          <label>Bank (SBI Neelkanth) Opening (&#8377;)</label>
          <input type="number" id="balBankOpening" min="0" placeholder="0">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('setBalanceModal')">Cancel</button>
        <button class="btn btn-primary" onclick="saveOpeningBalance()">
          <span class="material-icons">save</span> Save
        </button>
      </div>
    </div>
  </div>

  <!-- Add Expense Modal -->
  <div class="modal-overlay" id="addExpenseModal">
    <div class="modal" style="max-width: 520px;">
      <div class="modal-header">
        <h3 id="expenseModalTitle">Add Expense</h3>
        <button class="modal-close" onclick="closeModal('addExpenseModal')">
          <span class="material-icons">close</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-group" style="margin-bottom:16px;">
          <label>Category *</label>
          <select id="expenseCategory" onchange="updateExpenseSubItems()">
            <option value="">Select Category</option>
            <option value="Grocery">Grocery</option>
            <option value="Electricity">Electricity</option>
            <option value="Salary">Salary</option>
            <option value="Recharges">Recharges</option>
            <option value="Deco Items">Deco Items</option>
            <option value="Bakery">Bakery</option>
            <option value="Housekeeping">Housekeeping</option>
            <option value="Butchery">Butchery</option>
            <option value="Fuel">Fuel</option>
            <option value="Cylinder">Cylinder</option>
            <option value="Laundry">Laundry</option>
            <option value="Garbage">Garbage</option>
            <option value="Maintenance">Maintenance</option>
            <option value="Others">Others</option>
          </select>
        </div>
        <div class="form-group" style="margin-bottom:16px;display:none;" id="expenseSubItemGroup">
          <label>Sub-Item</label>
          <select id="expenseSubItem">
            <option value="">Select Sub-Item</option>
          </select>
        </div>
        <div class="form-group" style="margin-bottom:16px;display:none;" id="expenseEmployeeGroup">
          <label>Employee *</label>
          <select id="expenseEmployee">
            <option value="">Select Employee</option>
          </select>
        </div>
        <div class="form-group" style="margin-bottom:16px;">
          <label>Amount *</label>
          <input type="number" id="expenseAmount" min="0" placeholder="&#8377;">
        </div>
        <div class="form-group" style="margin-bottom:16px;">
          <label>Payment From *</label>
          <select id="expensePayFrom">
            <option value="Cash">Cash</option>
            <option value="Bank Transfer">Bank Transfer (SBI Neelkanth)</option>
          </select>
        </div>
        <div class="form-group">
          <label>Description</label>
          <input type="text" id="expenseDescription" placeholder="Notes...">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('addExpenseModal')">Cancel</button>
        <button class="btn btn-primary" onclick="saveExpense()">
          <span class="material-icons">save</span> Save Expense
        </button>
      </div>
    </div>
  </div>

  <!-- Add Manual Income Modal -->
  <div class="modal-overlay" id="addIncomeModal">
    <div class="modal" style="max-width: 480px;">
      <div class="modal-header">
        <h3>Add Manual Income</h3>
        <button class="modal-close" onclick="closeModal('addIncomeModal')">
          <span class="material-icons">close</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-group" style="margin-bottom:16px;">
          <label>Income Source *</label>
          <select id="incomeSource">
            <option value="Room Rent">Room Rent</option>
            <option value="KOT">KOT</option>
            <option value="Other Collection">Other Collection</option>
          </select>
        </div>
        <div class="form-group" style="margin-bottom:16px;">
          <label>Amount *</label>
          <input type="number" id="incomeAmount" min="0" placeholder="&#8377;">
        </div>
        <div class="form-group" style="margin-bottom:16px;">
          <label>Payment Mode *</label>
          <select id="incomePayMode">
            <option value="Cash">Cash</option>
            <option value="Card">Card</option>
            <option value="Bank Transfer">Bank Transfer (SBI Neelkanth)</option>
          </select>
        </div>
        <div class="form-group" style="margin-bottom:16px;">
          <label>Received In *</label>
          <select id="incomeReceivedIn">
            <option value="Cash">Cash</option>
            <option value="Bank Transfer">Bank Transfer (SBI Neelkanth)</option>
          </select>
        </div>
        <div class="form-group">
          <label>Description</label>
          <input type="text" id="incomeDescription" placeholder="Notes...">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('addIncomeModal')">Cancel</button>
        <button class="btn btn-primary" onclick="saveManualIncome()">
          <span class="material-icons">save</span> Save Income
        </button>
      </div>
    </div>
  </div>

  <!-- Add Staff Modal -->
  <div class="modal-overlay" id="addStaffModal">
    <div class="modal" style="max-width: 520px;">
      <div class="modal-header">
        <h3 id="staffModalTitle">Add Staff</h3>
        <button class="modal-close" onclick="closeModal('addStaffModal')">
          <span class="material-icons">close</span>
        </button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="editStaffId">
        <div class="form-group" style="margin-bottom:16px;">
          <label>Name *</label>
          <input type="text" id="staffName" placeholder="Employee name">
        </div>
        <div class="form-group" style="margin-bottom:16px;">
          <label>Designation *</label>
          <select id="staffDesignation">
            <option value="">Select</option>
            <option value="Service">Service</option>
            <option value="HK">HK</option>
            <option value="Houseman">Houseman</option>
            <option value="Reception">Reception</option>
            <option value="Manager">Manager</option>
            <option value="Chef">Chef</option>
            <option value="Cook">Cook</option>
            <option value="Assistant Cook">Assistant Cook</option>
            <option value="Assistant">Assistant</option>
            <option value="UT">UT</option>
          </select>
        </div>
        <div class="form-group" style="margin-bottom:16px;">
          <label>Monthly Salary (&#8377;) *</label>
          <input type="number" id="staffSalary" min="0" placeholder="&#8377;">
        </div>
        <div class="form-group">
          <label>Date of Joining *</label>
          <input type="date" id="staffDoj">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('addStaffModal')">Cancel</button>
        <button class="btn btn-primary" onclick="saveStaffMember()">
          <span class="material-icons">save</span> Save
        </button>
      </div>
    </div>
  </div>

  <!-- Record Advance Modal -->
  <div class="modal-overlay" id="addAdvanceModal">
    <div class="modal" style="max-width: 480px;">
      <div class="modal-header">
        <h3>Record Salary Advance</h3>
        <button class="modal-close" onclick="closeModal('addAdvanceModal')">
          <span class="material-icons">close</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-group" style="margin-bottom:16px;">
          <label>Employee *</label>
          <select id="advanceEmployee">
            <option value="">Select Employee</option>
          </select>
        </div>
        <div class="form-group" style="margin-bottom:16px;">
          <label>Amount *</label>
          <input type="number" id="advanceAmount" min="0" placeholder="&#8377;">
        </div>
        <div class="form-group" style="margin-bottom:16px;">
          <label>Date *</label>
          <input type="date" id="advanceDate">
        </div>
        <div class="form-group" style="margin-bottom:16px;">
          <label>Deduct from Month *</label>
          <input type="month" id="advanceDeductMonth">
        </div>
        <div class="form-group">
          <label>Remarks</label>
          <input type="text" id="advanceRemarks" placeholder="Notes...">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('addAdvanceModal')">Cancel</button>
        <button class="btn btn-primary" onclick="saveAdvance()">
          <span class="material-icons">save</span> Save Advance
        </button>
      </div>
    </div>
  </div>

  <!-- Mark Absent Modal -->
  <div class="modal-overlay" id="markAbsentModal">
    <div class="modal" style="max-width: 400px;">
      <div class="modal-header">
        <h3>Mark Absent</h3>
        <button class="modal-close" onclick="closeModal('markAbsentModal')">
          <span class="material-icons">close</span>
        </button>
      </div>
      <div class="modal-body">
        <p style="margin-bottom:16px;font-size:14px;">
          Employee: <strong id="absentEmpName"></strong><br>
          Date: <strong id="absentDateDisplay"></strong>
        </p>
        <input type="hidden" id="absentEmpId">
        <input type="hidden" id="absentDate">
        <div class="form-group">
          <label>Remark</label>
          <input type="text" id="absentRemark" placeholder="Reason for absence...">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('markAbsentModal')">Cancel</button>
        <button class="btn btn-danger" onclick="saveAbsent()">
          <span class="material-icons">event_busy</span> Mark Absent
        </button>
      </div>
    </div>
  </div>

  <!-- FnF Settlement Modal -->
  <div class="modal-overlay" id="fnfModal">
    <div class="modal" style="max-width: 560px;">
      <div class="modal-header">
        <h3>Full &amp; Final Settlement</h3>
        <button class="modal-close" onclick="closeModal('fnfModal')">
          <span class="material-icons">close</span>
        </button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="fnfEmpId">
        <div id="fnfEmployeeInfo" style="padding:16px;background:rgba(20,20,40,0.6);border-radius:12px;margin-bottom:16px;"></div>
        <div class="form-group" style="margin-bottom:16px;">
          <label>Last Working Date *</label>
          <input type="date" id="fnfLastDate" onchange="calculateFnf()">
        </div>
        <div id="fnfBreakdown" style="padding:16px;background:rgba(20,20,40,0.6);border-radius:12px;"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('fnfModal')">Cancel</button>
        <button class="btn btn-danger" onclick="processFnf()">
          <span class="material-icons">gavel</span> Process FnF
        </button>
      </div>
    </div>
  </div>

  <script>
    // ========== AUTH STATE ==========
    var authToken = null;
    var currentUser = null;

    function getStoredAuth() {
      try {
        var t = sessionStorage.getItem('auth_token');
        var u = sessionStorage.getItem('auth_user');
        if (t && u) { authToken = t; currentUser = JSON.parse(u); return true; }
      } catch(e) {}
      return false;
    }
    function setStoredAuth(token, user) {
      authToken = token; currentUser = user;
      sessionStorage.setItem('auth_token', token);
      sessionStorage.setItem('auth_user', JSON.stringify(user));
    }
    function clearAuth() {
      authToken = null; currentUser = null;
      sessionStorage.removeItem('auth_token');
      sessionStorage.removeItem('auth_user');
    }
    function hasPermission(section, action) {
      if (!currentUser) return false;
      if (currentUser.role === 'admin') return true;
      var p = currentUser.permissions || {};
      return (p[section] || []).includes(action);
    }

    // ========== AUTH SCREENS ==========
    function showScreen(id) {
      ['login-screen','forgot-screen','otp-screen'].forEach(function(s) {
        document.getElementById(s).classList.add('auth-hidden');
      });
      document.querySelector('.app-container').style.display = 'none';
      if (id === 'app') {
        document.querySelector('.app-container').style.display = 'block';
      } else {
        document.getElementById(id).classList.remove('auth-hidden');
      }
    }

    async function checkStoredLogin() {
      if (getStoredAuth()) {
        try {
          var profile = await apiFetch('/auth/profile');
          currentUser = profile;
          sessionStorage.setItem('auth_user', JSON.stringify(profile));
          showScreen('app');
          initializeApp();
        } catch(e) { clearAuth(); showScreen('login-screen'); }
      } else {
        showScreen('login-screen');
      }
    }

    var _pendingOtpUserId = null;

    async function doLogin() {
      var email = document.getElementById('loginEmail').value;
      var pass = document.getElementById('loginPassword').value;
      if (!email || !pass) return;
      try {
        document.getElementById('loginError').style.display = 'none';
        var r = await apiFetch('/auth/login', { method: 'POST', body: { emailOrPhone: email, password: pass } });
        setStoredAuth(r.token, r.user);
        showScreen('app');
        initializeApp();
      } catch(e) {
        document.getElementById('loginError').textContent = e.message || 'Login failed';
        document.getElementById('loginError').style.display = 'block';
      }
    }

    async function doForgotPassword() {
      var email = document.getElementById('forgotEmail').value;
      if (!email) return;
      try {
        document.getElementById('forgotError').style.display = 'none';
        var r = await apiFetch('/auth/forgot-password', { method: 'POST', body: { email: email } });
        if (r.userId) {
          _pendingOtpUserId = r.userId;
          showScreen('otp-screen');
          showToast('OTP bheja gaya hai aapki email pe', 'success');
        } else {
          document.getElementById('forgotError').textContent = r.message || 'Email not found';
          document.getElementById('forgotError').style.display = 'block';
        }
      } catch(e) {
        document.getElementById('forgotError').textContent = e.message || 'Something went wrong';
        document.getElementById('forgotError').style.display = 'block';
      }
    }

    async function doVerifyOtp() {
      var code = document.getElementById('otpCode').value;
      var newPin = document.getElementById('otpNewPin').value;
      var confirmPin = document.getElementById('otpConfirmPin').value;
      if (!code || !newPin) return;
      if (!/^\d{4}$/.test(newPin)) {
        document.getElementById('otpError').textContent = 'Password must be exactly 4 digits';
        document.getElementById('otpError').style.display = 'block';
        return;
      }
      if (newPin !== confirmPin) {
        document.getElementById('otpError').textContent = 'Passwords do not match';
        document.getElementById('otpError').style.display = 'block';
        return;
      }
      try {
        document.getElementById('otpError').style.display = 'none';
        var r = await apiFetch('/auth/verify-otp', { method: 'POST', body: { userId: _pendingOtpUserId, code: code, newPassword: newPin } });
        setStoredAuth(r.token, r.user);
        showScreen('app');
        initializeApp();
        showToast('Password reset successful!', 'success');
      } catch(e) {
        document.getElementById('otpError').textContent = e.message || 'Invalid OTP';
        document.getElementById('otpError').style.display = 'block';
      }
    }

    async function doResendOtp() {
      if (!_pendingOtpUserId) return;
      try {
        await apiFetch('/auth/resend-otp', { method: 'POST', body: { userId: _pendingOtpUserId } });
        showToast('OTP resent to your email', 'success');
      } catch(e) {}
    }

    function doLogout() {
      clearAuth();
      showScreen('login-screen');
      document.getElementById('loginEmail').value = '';
      document.getElementById('loginPassword').value = '';
    }

    function openChangePassword() {
      document.getElementById('cpOldPin').value = '';
      document.getElementById('cpNewPin').value = '';
      document.getElementById('cpConfirmPin').value = '';
      document.getElementById('changePinModal').classList.add('active');
    }

    async function doChangePassword() {
      var oldPin = document.getElementById('cpOldPin').value;
      var newPin = document.getElementById('cpNewPin').value;
      var confirmPin = document.getElementById('cpConfirmPin').value;
      if (!/^\d{4}$/.test(oldPin)) { showToast('Current password must be 4 digits', 'error'); return; }
      if (!/^\d{4}$/.test(newPin)) { showToast('New password must be 4 digits', 'error'); return; }
      if (newPin !== confirmPin) { showToast('New passwords do not match', 'error'); return; }
      try {
        await apiFetch('/auth/change-password', { method: 'POST', body: { oldPassword: oldPin, newPassword: newPin } });
        showToast('Password changed successfully', 'success');
        closeModal('changePinModal');
      } catch(e) {
        showToast(e.message || 'Failed to change password', 'error');
      }
    }

    function updateUIForPermissions() {
      // Header user info
      if (currentUser) {
        document.getElementById('headerUserName').textContent = currentUser.name;
      }
      // Tab visibility
      var tabSections = ['dashboard','inventory','ledger','reports','daybook','salary'];
      var navBtns = document.querySelectorAll('.nav-tabs button');
      navBtns.forEach(function(btn) {
        var onclick = btn.getAttribute('onclick') || '';
        var match = onclick.match(/switchTab\('(\w+)'\)/);
        if (match) {
          var tabName = match[1];
          if (tabName === 'users' || tabName === 'audit') {
            btn.style.display = (currentUser && currentUser.role === 'admin') ? '' : 'none';
          } else if (tabSections.includes(tabName)) {
            btn.style.display = hasPermission(tabName, 'view') ? '' : 'none';
          }
        }
      });
      // New Booking button
      var nbBtn = document.getElementById('btnNewBooking');
      if (nbBtn) nbBtn.style.display = hasPermission('bookings', 'create') ? '' : 'none';
      // Opening Balance button - admin only (cards visible to all)
      var isAdmin = currentUser && currentUser.role === 'admin';
      var obBtn = document.getElementById('btnSetOpeningBalance');
      if (obBtn) obBtn.style.display = isAdmin ? '' : 'none';
    }

    // ========== USER MANAGEMENT (Admin) ==========
    var _editUserId = null;

    function openUserModal(userId) {
      _editUserId = userId || null;
      document.getElementById('userModalTitle').textContent = userId ? 'Edit User' : 'Add User';
      document.getElementById('userName').value = '';
      document.getElementById('userEmail').value = '';
      document.getElementById('userPhone').value = '';
      document.getElementById('userRole').value = 'staff';
      document.querySelectorAll('#permCheckboxes input').forEach(function(cb) { cb.checked = cb.dataset.section === 'dashboard'; });

      if (userId) {
        apiFetch('/users').then(function(users) {
          var u = users.find(function(x) { return x.id === userId; });
          if (u) {
            document.getElementById('userName').value = u.name;
            document.getElementById('userEmail').value = u.email;
            document.getElementById('userPhone').value = u.phone || '';
            document.getElementById('userRole').value = u.role;
            var p = u.permissions || {};
            document.querySelectorAll('#permCheckboxes input').forEach(function(cb) {
              cb.checked = (p[cb.dataset.section] || []).length > 0;
            });
          }
        });
      }
      document.getElementById('userModal').classList.add('active');
    }

    async function saveUser() {
      var name = document.getElementById('userName').value;
      var email = document.getElementById('userEmail').value;
      var phone = document.getElementById('userPhone').value;
      var role = document.getElementById('userRole').value;
      if (!name || !email) { showToast('Name and email required', 'error'); return; }

      var perms = {};
      document.querySelectorAll('#permCheckboxes input').forEach(function(cb) {
        if (cb.checked) perms[cb.dataset.section] = ['view','create','edit','delete'];
        else perms[cb.dataset.section] = [];
      });

      try {
        if (_editUserId) {
          await apiFetch('/users/' + _editUserId, { method: 'PUT', body: { name: name, email: email, phone: phone, role: role, permissions: perms } });
          showToast('User updated', 'success');
        } else {
          await apiFetch('/users', { method: 'POST', body: { name: name, email: email, phone: phone, role: role, permissions: perms } });
          showToast('User created! Default PIN: 1234', 'success');
        }
        closeModal('userModal');
        loadUsersTable();
      } catch(e) {}
    }

    async function loadUsersTable() {
      try {
        var users = await apiFetch('/users');
        var tbody = document.getElementById('usersTableBody');
        tbody.innerHTML = users.map(function(u) {
          var permLabels = Object.keys(u.permissions || {}).filter(function(k) { return (u.permissions[k] || []).length > 0; }).join(', ') || 'None';
          return '<tr>' +
            '<td>' + escapeHtml(u.name) + '</td>' +
            '<td>' + escapeHtml(u.email) + '</td>' +
            '<td>' + escapeHtml(u.phone || '-') + '</td>' +
            '<td><span class="badge ' + (u.role === 'admin' ? 'badge-info' : 'badge-default') + '">' + u.role.toUpperCase() + '</span></td>' +
            '<td><span class="badge ' + (u.isActive ? 'badge-success' : 'badge-danger') + '">' + (u.isActive ? 'Active' : 'Inactive') + '</span></td>' +
            '<td style="font-size:12px">' + (u.role === 'admin' ? 'All Access' : permLabels) + '</td>' +
            '<td>' +
              '<button class="btn btn-sm btn-secondary" onclick="openUserModal(' + u.id + ')" title="Edit"><span class="material-icons" style="font-size:16px">edit</span></button> ' +
              (u.role !== 'admin' ? '<button class="btn btn-sm btn-secondary" onclick="resetUserPw(' + u.id + ')" title="Reset Password"><span class="material-icons" style="font-size:16px">lock_reset</span></button> ' : '') +
              (u.role !== 'admin' ? '<button class="btn btn-sm btn-danger" onclick="deleteUserConfirm(' + u.id + ')" title="Delete"><span class="material-icons" style="font-size:16px">delete</span></button>' : '') +
            '</td></tr>';
        }).join('');
      } catch(e) {}
    }

    async function resetUserPw(id) {
      if (!confirm('Reset password to default 1234?')) return;
      try { await apiFetch('/users/' + id + '/reset-password', { method: 'POST' }); showToast('Password reset to 1234', 'success'); } catch(e) {}
    }

    async function deleteUserConfirm(id) {
      if (!confirm('Delete this user permanently?')) return;
      try { await apiFetch('/users/' + id, { method: 'DELETE' }); showToast('User deleted', 'success'); loadUsersTable(); } catch(e) {}
    }

    // ========== AUDIT LOG (Admin) ==========
    var _auditPage = 1;

    async function loadAuditLogs(page) {
      _auditPage = page || 1;
      var entityType = document.getElementById('auditEntityFilter').value;
      var from = document.getElementById('auditFrom').value;
      var to = document.getElementById('auditTo').value;
      var q = '?page=' + _auditPage + '&limit=30';
      if (entityType) q += '&entityType=' + entityType;
      if (from) q += '&from=' + from;
      if (to) q += '&to=' + to;
      try {
        var r = await apiFetch('/audit' + q);
        var tbody = document.getElementById('auditTableBody');
        if (!r.data || r.data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:20px;color:#999">No audit entries found</td></tr>';
        } else {
          tbody.innerHTML = r.data.map(function(l) {
            var dt = new Date(l.createdAt);
            var timeStr = dt.toLocaleDateString('en-IN', {day:'2-digit',month:'short'}) + ' ' + dt.toLocaleTimeString('en-IN', {hour:'2-digit',minute:'2-digit'});
            return '<tr>' +
              '<td style="font-size:12px;white-space:nowrap">' + timeStr + '</td>' +
              '<td>' + escapeHtml(l.userName || '-') + '</td>' +
              '<td><span class="badge badge-default">' + escapeHtml(l.action) + '</span></td>' +
              '<td>' + escapeHtml(l.entityType) + '</td>' +
              '<td>' + escapeHtml(l.entityId || '-') + '</td>' +
              '<td style="font-size:13px">' + escapeHtml(l.description || '-') + '</td>' +
            '</tr>';
          }).join('');
        }
        // Pagination
        var totalPages = Math.ceil(r.total / r.limit);
        var pagHtml = '';
        if (totalPages > 1) {
          if (_auditPage > 1) pagHtml += '<button class="btn btn-sm btn-secondary" onclick="loadAuditLogs(' + (_auditPage-1) + ')">Prev</button> ';
          pagHtml += 'Page ' + _auditPage + ' of ' + totalPages;
          if (_auditPage < totalPages) pagHtml += ' <button class="btn btn-sm btn-secondary" onclick="loadAuditLogs(' + (_auditPage+1) + ')">Next</button>';
        }
        document.getElementById('auditPagination').innerHTML = pagHtml;
      } catch(e) {}
    }

    // ========== API LAYER ==========
    var API_BASE = '/api';

    // ID mapping: frontend string IDs ‚Üî backend numeric IDs
    var _bookingIdMap = {};  // { 'NKH-0001': 5 }
    var _staffIdMap = {};    // { 'EMP-001': 3 }
    var _advanceIdMap = {};  // { 'ADV-123': 7 }

    function getBackendBookingId(frontendId) {
      return _bookingIdMap[frontendId];
    }
    function getBackendStaffId(frontendId) {
      return _staffIdMap[frontendId];
    }
    function getBackendAdvanceId(frontendId) {
      return _advanceIdMap[frontendId];
    }

    async function apiFetch(path, options) {
      options = options || {};
      if (!options.headers) options.headers = {};
      if (authToken) {
        options.headers['Authorization'] = 'Bearer ' + authToken;
      }
      if (options.body && typeof options.body === 'object' && !(options.body instanceof FormData)) {
        options.headers['Content-Type'] = 'application/json';
        options.body = JSON.stringify(options.body);
      }
      try {
        var resp = await fetch(API_BASE + path, options);
        if (resp.status === 401) {
          clearAuth();
          showScreen('login-screen');
          throw new Error('Session expired. Please login again.');
        }
        if (!resp.ok) {
          var errBody = null;
          try { errBody = await resp.json(); } catch(e) {}
          var msg = (errBody && errBody.message) ? errBody.message : ('API error ' + resp.status);
          throw new Error(msg);
        }
        var text = await resp.text();
        return text ? JSON.parse(text) : null;
      } catch(e) {
        if (e.message !== 'Session expired. Please login again.') {
          showToast('API Error: ' + e.message, 'error');
        }
        throw e;
      }
    }

    // Data mapping: backend ‚Üí frontend shape
    function mapBackendBookingToFrontend(b) {
      return {
        id: b.bookingId || ('NKH-TEMP-' + b.id),
        _backendId: b.id,
        guestName: b.guestName || '',
        phone: b.phone || '',
        pax: b.pax || 1,
        kot: b.kot || '',
        roomNo: b.roomNo || '',
        noOfRooms: b.noOfRooms || 1,
        roomCategory: b.roomCategory || '',
        checkIn: b.checkIn || '',
        checkOut: b.checkOut || '',
        mealPlan: b.mealPlan || '',
        source: b.source || '',
        sourceName: b.sourceName || '',
        complimentary: b.complimentary || '',
        actualRoomRent: parseFloat(b.actualRoomRent) || 0,
        totalAmount: parseFloat(b.totalAmount) || 0,
        paymentType: b.paymentType || '',
        advanceReceived: parseFloat(b.advanceReceived) || 0,
        advanceDate: b.advanceDate || '',
        balanceReceived: parseFloat(b.balanceReceived) || 0,
        balanceDate: b.balanceDate || '',
        balancePaymentMode: b.balancePaymentMode || '',
        paymentMode: b.paymentMode || '',
        status: b.status || 'PENDING',
        remarks: b.remarks || '',
        kotAmount: parseFloat(b.kotAmount) || 0,
        addOns: b.addOns || [],
        checkedIn: b.checkedIn || false,
        checkedInTime: b.checkedInTime || '',
        checkedOut: b.checkedOut || false,
        checkedOutTime: b.checkedOutTime || '',
        rescheduledFrom: b.rescheduledFrom || '',
        createdAt: b.createdAt || ''
      };
    }

    function mapBackendStaffToFrontend(s) {
      return {
        id: s.staffCode || ('EMP-TEMP-' + s.id),
        _backendId: s.id,
        name: s.name || '',
        designation: s.designation || '',
        salary: parseFloat(s.salary) || 0,
        doj: s.doj || '',
        status: s.status || 'active',
        lastWorkingDate: s.lastWorkingDate || '',
        createdAt: s.createdAt || ''
      };
    }

    function mapBackendAdvanceToFrontend(a) {
      return {
        id: 'ADV-' + a.id,
        _backendId: a.id,
        employeeId: a.staff ? (a.staff.staffCode || ('EMP-TEMP-' + a.staffId)) : ('EMP-TEMP-' + a.staffId),
        amount: parseFloat(a.amount) || 0,
        date: a.date || '',
        deductMonth: a.deductMonth || '',
        remarks: a.remarks || '',
        deducted: a.deducted || false,
        createdAt: a.createdAt || ''
      };
    }

    function mapBackendDaybookEntryToFrontend(e) {
      return {
        id: String(e.id),
        _backendId: e.id,
        date: e.date || '',
        type: e.type || '',
        category: e.category || '',
        subItem: e.subItem || '',
        description: e.description || '',
        amount: parseFloat(e.amount) || 0,
        paymentSource: e.paymentSource || '',
        incomeSource: e.incomeSource || '',
        bookingId: e.refBookingId || '',
        guestName: e.guestName || '',
        paymentMode: e.paymentMode || '',
        receivedIn: e.receivedIn || '',
        employeeId: e.employeeId ? String(e.employeeId) : '',
        employeeName: e.employeeName || '',
        createdAt: e.createdAt || ''
      };
    }

    // Loading overlay
    function showLoadingOverlay() {
      if (document.getElementById('loadingOverlay')) return;
      var ov = document.createElement('div');
      ov.id = 'loadingOverlay';
      ov.className = 'loading-overlay';
      ov.innerHTML = '<div class="spinner"></div><p>Loading data...</p>';
      document.body.appendChild(ov);
    }
    function hideLoadingOverlay() {
      var ov = document.getElementById('loadingOverlay');
      if (ov) ov.remove();
    }

    // ========== DATA STORAGE (API-backed in-memory cache) ==========
    var STORAGE_KEY = 'hotelBookings';

    function loadBookings() { return bookings; }
    function saveBookings() { /* no-op ‚Äî cache only */ }

    var _staffData = [];
    var _attendanceCache = {};
    var _advancesData = [];

    function loadStaffData() { return _staffData; }
    function saveStaffData() { /* no-op */ }
    function loadAttendance() { return _attendanceCache; }
    function saveAttendance() { /* no-op */ }
    function loadAdvances() { return _advancesData; }
    function saveAdvances() { /* no-op */ }
    function loadDayBook() { return []; }
    function saveDayBook() { /* no-op */ }
    function loadDayBookBalances() { return {}; }
    function saveDayBookBalances() { /* no-op */ }

    // Async API loaders
    async function loadBookingsFromAPI() {
      var data = await apiFetch('/bookings');
      bookings = data.map(mapBackendBookingToFrontend);
      _bookingIdMap = {};
      bookings.forEach(function(b) { _bookingIdMap[b.id] = b._backendId; });
      return bookings;
    }

    async function loadStaffFromAPI() {
      var data = await apiFetch('/staff');
      _staffData = data.map(mapBackendStaffToFrontend);
      _staffIdMap = {};
      _staffData.forEach(function(s) { _staffIdMap[s.id] = s._backendId; });
      return _staffData;
    }

    async function loadAdvancesFromAPI() {
      var data = await apiFetch('/advances');
      _advancesData = data.map(mapBackendAdvanceToFrontend);
      _advanceIdMap = {};
      _advancesData.forEach(function(a) { _advanceIdMap[a.id] = a._backendId; });
      return _advancesData;
    }

    async function loadDayBookEntriesForDate(date) {
      var data = await apiFetch('/daybook/entries?date=' + encodeURIComponent(date));
      return data.map(mapBackendDaybookEntryToFrontend);
    }

    async function loadDayBookBalanceForDate(date) {
      var data = await apiFetch('/daybook/balance?date=' + encodeURIComponent(date));
      return data || { cashOpening: 0, bankSbiOpening: 0 };
    }

    async function loadDayBookClosingForDate(date) {
      var data = await apiFetch('/daybook/closing?date=' + encodeURIComponent(date));
      return data || { cashOpening: 0, bankOpening: 0, cashIncome: 0, bankIncome: 0, cashExpense: 0, bankExpense: 0, cashClosing: 0, bankClosing: 0 };
    }

    async function loadAttendanceForEmployee(empId, month) {
      var backendId = getBackendStaffId(empId);
      if (!backendId) return {};
      var data = await apiFetch('/attendance?staffId=' + backendId + '&month=' + encodeURIComponent(month));
      var result = {};
      if (Array.isArray(data)) {
        data.forEach(function(rec) {
          if (rec.absent) {
            result[rec.date] = { absent: true, remark: rec.remark || '' };
          }
        });
      }
      return result;
    }

    var bookings = [];
    // dashboardView removed - dashboard now always shows 3 guest lists

    // ========== INITIALIZE ==========
    async function initializeApp() {
      showLoadingOverlay();
      try {
        updateUIForPermissions();

        // Set default date selectors
        var now = new Date();
        var currentMonth = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0');
        document.getElementById('summaryStartDate').value = currentMonth + '-01';
        document.getElementById('summaryEndDate').value = getToday();
        document.getElementById('inventoryMonth').value = currentMonth;
        document.getElementById('inventoryDate').value = getToday();
        document.getElementById('reportMonth').value = currentMonth;

        // Set report date range to current month
        var firstDay = currentMonth + '-01';
        var lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
        var lastDayStr = toLocalDateStr(lastDay);
        document.getElementById('reportDateFrom').value = firstDay;
        document.getElementById('reportDateTo').value = lastDayStr;
        document.getElementById('payReportFrom').value = firstDay;
        document.getElementById('payReportTo').value = lastDayStr;
        document.getElementById('ledgerFrom').value = firstDay;
        document.getElementById('ledgerTo').value = lastDayStr;

        document.getElementById('filterDate').value = getToday();
        document.getElementById('checkIn').value = getToday();

        await Promise.all([loadBookingsFromAPI(), loadStaffFromAPI(), loadAdvancesFromAPI()]);
        renderBookings();
        updateDashboard();
      } catch(e) {
        showToast('Failed to load data from server: ' + e.message, 'error');
      } finally {
        hideLoadingOverlay();
      }
    }

    document.addEventListener('DOMContentLoaded', function() {
      // Check if already logged in, otherwise show login screen
      checkStoredLogin();
    });

    // ========== TABS ==========
    function switchTab(tab) {
      // Toggle tab buttons
      var btns = document.querySelectorAll('.nav-tabs button');
      btns.forEach(function(btn) { btn.classList.remove('active'); });
      event.currentTarget.classList.add('active');

      // Toggle tab content
      document.querySelectorAll('.tab-content').forEach(function(el) {
        el.classList.remove('active');
      });
      document.getElementById('tab-' + tab).classList.add('active');

      if (tab === 'inventory') {
        renderInventory();
      }
      if (tab === 'ledger') {
        renderLedgerReport();
      }
      if (tab === 'reports') {
        renderSourceReport();
        renderPaymentReport();
        renderMonthlyReport();
      }
      if (tab === 'daybook') {
        if (!document.getElementById('daybookDate').value) {
          document.getElementById('daybookDate').value = getToday();
        }
        renderDayBook();
      }
      if (tab === 'salary') {
        initSalaryTab();
      }
      if (tab === 'users') {
        loadUsersTable();
      }
      if (tab === 'audit') {
        loadAuditLogs();
      }
    }

    // Dashboard view toggle removed - now shows 3 colored guest lists

    // ========== HELPERS ==========
    function toLocalDateStr(d) {
      var y = d.getFullYear();
      var m = String(d.getMonth() + 1).padStart(2, '0');
      var day = String(d.getDate()).padStart(2, '0');
      return y + '-' + m + '-' + day;
    }

    function getToday() {
      return toLocalDateStr(new Date());
    }

    function formatCurrency(amount) {
      return '\u20B9' + Number(amount || 0).toLocaleString('en-IN');
    }

    function formatDate(dateStr) {
      if (!dateStr) return '-';
      var date = new Date(dateStr + 'T00:00:00');
      return date.toLocaleDateString('en-IN', { day: '2-digit', month: 'short' });
    }

    function generateBookingId() {
      var maxNum = 0;
      bookings.forEach(function(b) {
        var parts = b.id.split('-');
        if (parts.length === 2) {
          var num = parseInt(parts[1], 10);
          if (num > maxNum) maxNum = num;
        }
      });
      return 'NKH-' + String(maxNum + 1).padStart(4, '0');
    }

    function formatRoomDisplay(roomNo) {
      if (!roomNo) return '<em style="color:#f59e0b;font-size:12px">Not assigned</em>';
      var rooms = roomNo.split(',').map(function(r) { return r.trim(); });
      var roomStr = '<strong>' + rooms.join(' / ') + '</strong>';
      var types = rooms.map(function(r) { return ROOM_TYPE[r] || ''; }).filter(function(t) { return t; });
      var uniqueTypes = types.filter(function(v, i, a) { return a.indexOf(v) === i; });
      if (uniqueTypes.length > 0) roomStr += '<br><small style="color:#6b7280">' + uniqueTypes.join(', ') + '</small>';
      return roomStr;
    }

    function escapeHtml(str) {
      if (!str) return '';
      var div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    // ========== TOAST NOTIFICATION ==========
    function showToast(message, type) {
      type = type || 'success';
      var toast = document.createElement('div');
      toast.className = 'toast ' + type;
      var icon = type === 'success' ? 'check_circle' : 'error';
      toast.innerHTML = '<span class="material-icons">' + icon + '</span> ' + escapeHtml(message);
      document.body.appendChild(toast);
      setTimeout(function() {
        toast.remove();
      }, 3000);
    }

    // ========== FILTERS ==========
    function applyFilters() {
      renderBookings();
    }

    function clearFilters() {
      document.getElementById('filterViewBy').value = 'checkout';
      document.getElementById('filterDate').value = '';
      document.getElementById('filterStatus').value = '';
      document.getElementById('filterPaymentType').value = '';
      document.getElementById('filterSource').value = '';
      document.getElementById('filterAgent').value = '';
      renderBookings();
    }

    function showTodayPending() {
      document.getElementById('filterDate').value = getToday();
      document.getElementById('filterStatus').value = 'PENDING';
      document.getElementById('filterPaymentType').value = '';
      document.getElementById('filterSource').value = '';
      renderBookings();
    }

    function getFilteredBookings() {
      var filterViewBy = document.getElementById('filterViewBy').value;
      var filterDate = document.getElementById('filterDate').value;
      var filterStatus = document.getElementById('filterStatus').value;
      var filterPaymentType = document.getElementById('filterPaymentType').value;
      var filterSource = document.getElementById('filterSource').value;
      var filterAgent = document.getElementById('filterAgent').value;

      return bookings.filter(function(b) {
        if (filterDate) {
          if (filterViewBy === 'checkin' && b.checkIn !== filterDate) return false;
          if (filterViewBy === 'checkout' && b.checkOut !== filterDate) return false;
          if (filterViewBy === 'sameday' && !(b.checkIn === filterDate && b.checkOut === filterDate)) return false;
        }
        if (filterStatus && b.status !== filterStatus) return false;
        if (filterPaymentType && b.paymentType !== filterPaymentType) return false;
        if (filterSource && b.source !== filterSource) return false;
        if (filterAgent && b.sourceName !== filterAgent) return false;
        return true;
      });
    }

    // ========== RENDER BOOKINGS TABLE ==========
    function renderBookings() {
      var filtered = getFilteredBookings();
      var tbody = document.getElementById('bookingsTable');
      var emptyState = document.getElementById('emptyState');
      var tableWrapper = document.getElementById('tableWrapper');

      document.getElementById('recordCount').textContent = filtered.length + ' records';

      if (filtered.length === 0) {
        tableWrapper.style.display = 'none';
        emptyState.style.display = 'block';
        return;
      }

      tableWrapper.style.display = 'block';
      emptyState.style.display = 'none';

      // Sort by checkout date
      filtered.sort(function(a, b) {
        return new Date(a.checkOut) - new Date(b.checkOut);
      });

      tbody.innerHTML = filtered.map(function(b) {
        var totalReceived = (parseFloat(b.advanceReceived) || 0) + (parseFloat(b.balanceReceived) || 0);
        var pending = (parseFloat(b.totalAmount) || 0) - totalReceived;

        var sourceClass = b.source === 'Walk-in' ? 'badge-walkin' :
                          b.source === 'OTA' ? 'badge-ota' : 'badge-agent';

        var statusClass = b.status === 'COLLECTED' ? 'badge-collected' :
                          b.status === 'PARTIAL' ? 'badge-partial' :
                          b.status === 'CANCELLED' ? 'badge-cancelled' :
                          b.status === 'RESCHEDULED' ? 'badge-rescheduled' : 'badge-pending';

        var isCancelledOrRescheduled = (b.status === 'CANCELLED' || b.status === 'RESCHEDULED');

        return '<tr' + (isCancelledOrRescheduled ? ' style="opacity:0.6"' : '') + '>' +
          '<td><strong>' + escapeHtml(b.id) + '</strong></td>' +
          '<td><div class="guest-info"><div class="name">' + escapeHtml(b.guestName) +
            (b.kot === 'Yes' ? ' <span class="badge-kot">KOT</span>' : '') +
          '</div>' +
            (b.phone ? '<div class="phone">' + escapeHtml(b.phone) + '</div>' : '') +
          '</div></td>' +
          '<td>' + (b.pax || 1) + '</td>' +
          '<td>' + formatRoomDisplay(b.roomNo) + '</td>' +
          '<td><span class="badge ' + sourceClass + '">' + escapeHtml(b.source) + '</span>' +
            (b.sourceName ? '<br><small style="color:#6b7280">' + escapeHtml(b.sourceName) + '</small>' : '') +
          '</td>' +
          '<td>' + formatDate(b.checkIn) + '</td>' +
          '<td><strong>' + formatDate(b.checkOut) + '</strong>' +
            (b.rescheduledFrom ? '<br><small style="color:#6b7280">was ' + formatDate(b.rescheduledFrom) + '</small>' : '') +
          '</td>' +
          '<td><strong>' + calculateNights(b.checkIn, b.checkOut) + '</strong></td>' +
          '<td><span class="payment-type">' + escapeHtml(b.paymentType) + '</span></td>' +
          '<td class="amount">' + formatCurrency(b.actualRoomRent) + '</td>' +
          '<td class="amount">' + formatCurrency(b.totalAmount) + '</td>' +
          '<td class="amount amount-received">' + formatCurrency(totalReceived) + '</td>' +
          '<td class="amount ' + (pending > 0 ? 'amount-pending' : '') + '">' + formatCurrency(pending) + '</td>' +
          '<td><span class="badge ' + statusClass + '">' + escapeHtml(b.status) + '</span>' +
            (b.lastModifiedBy ? '<br><small style="color:#6b7280">by ' + escapeHtml(b.lastModifiedBy) + '</small>' : '') +
          '</td>' +
          '<td><div class="actions">' +
            (!isCancelledOrRescheduled && pending > 0 ? '<button class="btn btn-primary btn-small" onclick="openCollectModalById(\'' + b.id + '\')">Collect</button>' : '') +
            (!isCancelledOrRescheduled ? '<button class="btn btn-warning btn-small" onclick="openCheckoutModal(\'' + b.id + '\')"><span class="material-icons" style="font-size:14px">logout</span> Checkout</button>' : '') +
            '<button class="btn btn-secondary btn-small" onclick="generateBill(\'' + b.id + '\')" title="Generate Bill"><span class="material-icons" style="font-size:14px">receipt</span> Bill</button>' +
            (!isCancelledOrRescheduled ? '<button class="btn btn-secondary btn-small" onclick="openEditModalById(\'' + b.id + '\')">Edit</button>' : '') +
            (!isCancelledOrRescheduled ? '<button class="btn btn-danger btn-small" onclick="openCancelModal(\'' + b.id + '\')">Cancel</button>' : '') +
          '</div></td>' +
        '</tr>';
      }).join('');
    }

    // ========== DASHBOARD ==========
    function updateDashboard() {
      var today = getToday();

      var checkinGuests = [];
      var inhouseGuests = [];
      var checkoutGuests = [];

      var todayCollectionAmt = 0;
      var todayCollectedAmt = 0;
      var todayPendingAmt = 0;
      var ledgerDueAmt = 0;
      var ledgerByAgent = {};

      bookings.forEach(function(b) {
        if (b.status === 'CANCELLED') return;
        var totalReceived = (parseFloat(b.advanceReceived) || 0) + (parseFloat(b.balanceReceived) || 0);
        var pending = (parseFloat(b.totalAmount) || 0) - totalReceived;

        // Today check-in: only if NOT yet checked in
        if (b.checkIn === today && !b.checkedIn) {
          checkinGuests.push(b);
        }
        // In-house: checked in (flag set) and checking out after today, OR checked in before today
        if (b.checkedIn && b.checkIn <= today && b.checkOut > today) {
          inhouseGuests.push(b);
        }
        // Also include guests who checked in before today (auto in-house)
        if (!b.checkedIn && b.checkIn < today && b.checkOut > today) {
          inhouseGuests.push(b);
        }
        // Today check-out: not yet checked out
        if (b.checkOut === today && !b.checkedOut) {
          checkoutGuests.push(b);
          todayCollectionAmt += (parseFloat(b.totalAmount) || 0);
          todayCollectedAmt += totalReceived;
          if (pending > 0) todayPendingAmt += pending;
        }

        if (pending > 0 && b.paymentType === 'Ledger') {
          ledgerDueAmt += pending;
          var agent = b.sourceName || 'Unknown Agent';
          ledgerByAgent[agent] = (ledgerByAgent[agent] || 0) + pending;
        }
      });

      // Render guest lists
      renderCheckinList('checkinGuestList', checkinGuests);
      renderInhouseList('inhouseGuestList', inhouseGuests);
      renderCheckoutList('checkoutGuestList', checkoutGuests);
      document.getElementById('checkinCount').textContent = '(' + checkinGuests.length + ')';
      document.getElementById('inhouseCount').textContent = '(' + inhouseGuests.length + ')';
      document.getElementById('checkoutCount').textContent = '(' + checkoutGuests.length + ')';

      // Stat cards
      document.getElementById('todayCollection').textContent = formatCurrency(todayCollectionAmt);
      document.getElementById('todayCollected').textContent = formatCurrency(todayCollectedAmt);
      document.getElementById('todayPending').textContent = formatCurrency(todayPendingAmt);
      document.getElementById('ledgerDue').textContent = formatCurrency(ledgerDueAmt);

      // Alert box
      var alertBox = document.getElementById('alertBox');
      if (todayPendingAmt > 0) {
        alertBox.style.display = 'flex';
        document.getElementById('alertText').textContent =
          'Checkout today: ' + formatCurrency(todayPendingAmt) + ' pending collection';
      } else {
        alertBox.style.display = 'none';
      }

      updateMonthlySummary();
    }

    // === CHECK-IN LIST: with Check-in Done + Room Allot ===
    function renderCheckinList(containerId, guests) {
      var container = document.getElementById(containerId);
      if (guests.length === 0) {
        container.innerHTML = '<div class="guest-list-empty">No check-ins today</div>';
        return;
      }
      var html = '<div style="overflow-x:auto;"><table class="guest-list-table"><thead><tr>' +
        '<th>Guest</th><th>Pax</th><th>Room</th><th>Source</th><th>Checkout</th>' +
        '<th>Collection</th><th>Pending</th><th>Status</th><th>Actions</th><th>Remarks</th>' +
        '</tr></thead><tbody>';

      guests.forEach(function(b) {
        var totalReceived = (parseFloat(b.advanceReceived) || 0) + (parseFloat(b.balanceReceived) || 0);
        var pending = (parseFloat(b.totalAmount) || 0) - totalReceived;
        var statusClass = b.status === 'COLLECTED' ? 'badge-collected' :
                          b.status === 'PARTIAL' ? 'badge-partial' : 'badge-pending';
        html += '<tr>' +
          '<td><strong>' + escapeHtml(b.guestName) + '</strong>' +
            (b.phone ? '<br><small style="color:#6b7280">' + escapeHtml(b.phone) + '</small>' : '') +
          '</td>' +
          '<td>' + (b.pax || 1) + '</td>' +
          '<td>' + formatRoomDisplay(b.roomNo) + '</td>' +
          '<td>' + escapeHtml(b.source) + (b.sourceName ? '<br><small>' + escapeHtml(b.sourceName) + '</small>' : '') + '</td>' +
          '<td>' + formatDate(b.checkOut) + '</td>' +
          '<td class="amount">' + formatCurrency(b.totalAmount) + '</td>' +
          '<td class="amount ' + (pending > 0 ? 'amount-pending' : '') + '">' + formatCurrency(pending) + '</td>' +
          '<td><span class="badge ' + statusClass + '">' + escapeHtml(b.status) + '</span></td>' +
          '<td><div style="display:flex;gap:6px;flex-wrap:wrap;">' +
            '<button class="btn btn-primary btn-small" onclick="markCheckedIn(\'' + b.id + '\')" title="Check-in &amp; Allot Room">' +
              '<span class="material-icons" style="font-size:14px">login</span> Check-in &amp; Room</button>' +
            (pending > 0 ? '<button class="btn btn-secondary btn-small" onclick="openCollectModalById(\'' + b.id + '\')">Collect</button>' : '') +
          '</div></td>' +
          '<td><small style="color:#6b7280;font-style:italic;">' + escapeHtml(b.remarks || '-') + '</small></td>' +
          '</tr>';
      });
      html += '</tbody></table></div>';
      container.innerHTML = html;
    }

    // === IN-HOUSE LIST ===
    function renderInhouseList(containerId, guests) {
      var container = document.getElementById(containerId);
      if (guests.length === 0) {
        container.innerHTML = '<div class="guest-list-empty">No in-house guests</div>';
        return;
      }
      var html = '<div style="overflow-x:auto;"><table class="guest-list-table"><thead><tr>' +
        '<th>Guest</th><th>Pax</th><th>Room</th><th>Source</th><th>Check-in</th><th>Checkout</th>' +
        '<th>Collection</th><th>Received</th><th>Pending</th><th>Status</th>' +
        '</tr></thead><tbody>';

      guests.forEach(function(b) {
        var totalReceived = (parseFloat(b.advanceReceived) || 0) + (parseFloat(b.balanceReceived) || 0);
        var pending = (parseFloat(b.totalAmount) || 0) - totalReceived;
        var statusClass = b.status === 'COLLECTED' ? 'badge-collected' :
                          b.status === 'PARTIAL' ? 'badge-partial' : 'badge-pending';
        html += '<tr>' +
          '<td><strong>' + escapeHtml(b.guestName) + '</strong>' +
            (b.phone ? '<br><small style="color:#6b7280">' + escapeHtml(b.phone) + '</small>' : '') +
            (b.kot === 'Yes' ? ' <span class="badge-kot">KOT</span>' : '') +
          '</td>' +
          '<td>' + (b.pax || 1) + '</td>' +
          '<td>' + formatRoomDisplay(b.roomNo) + '</td>' +
          '<td>' + escapeHtml(b.source) + (b.sourceName ? '<br><small>' + escapeHtml(b.sourceName) + '</small>' : '') + '</td>' +
          '<td>' + formatDate(b.checkIn) + '</td>' +
          '<td>' + formatDate(b.checkOut) + '</td>' +
          '<td class="amount">' + formatCurrency(b.totalAmount) + '</td>' +
          '<td class="amount amount-received">' + formatCurrency(totalReceived) + '</td>' +
          '<td class="amount ' + (pending > 0 ? 'amount-pending' : '') + '">' + formatCurrency(pending) + '</td>' +
          '<td><span class="badge ' + statusClass + '">' + escapeHtml(b.status) + '</span></td>' +
          '</tr>';
      });
      html += '</tbody></table></div>';
      container.innerHTML = html;
    }

    // === CHECK-OUT LIST: with Checkout, Bill, Add-On, KOT ===
    function renderCheckoutList(containerId, guests) {
      var container = document.getElementById(containerId);
      if (guests.length === 0) {
        container.innerHTML = '<div class="guest-list-empty">No check-outs today</div>';
        return;
      }
      var html = '<div style="overflow-x:auto;"><table class="guest-list-table"><thead><tr>' +
        '<th>Guest</th><th>Pax</th><th>Room</th><th>Source</th><th>Check-in</th><th>Nights</th>' +
        '<th>Collection</th><th>Received</th><th>Pending</th><th>Status</th><th>Actions</th>' +
        '</tr></thead><tbody>';

      guests.forEach(function(b) {
        var totalReceived = (parseFloat(b.advanceReceived) || 0) + (parseFloat(b.balanceReceived) || 0);
        var pending = (parseFloat(b.totalAmount) || 0) - totalReceived;
        var statusClass = b.status === 'COLLECTED' ? 'badge-collected' :
                          b.status === 'PARTIAL' ? 'badge-partial' : 'badge-pending';
        var nights = calculateNights(b.checkIn, b.checkOut);
        html += '<tr>' +
          '<td><strong>' + escapeHtml(b.guestName) + '</strong>' +
            (b.phone ? '<br><small style="color:#6b7280">' + escapeHtml(b.phone) + '</small>' : '') +
            (b.kot === 'Yes' ? ' <span class="badge-kot">KOT</span>' : '') +
          '</td>' +
          '<td>' + (b.pax || 1) + '</td>' +
          '<td>' + formatRoomDisplay(b.roomNo) + '</td>' +
          '<td>' + escapeHtml(b.source) + (b.sourceName ? '<br><small>' + escapeHtml(b.sourceName) + '</small>' : '') + '</td>' +
          '<td>' + formatDate(b.checkIn) + '</td>' +
          '<td><strong>' + nights + '</strong></td>' +
          '<td class="amount">' + formatCurrency(b.totalAmount) + '</td>' +
          '<td class="amount amount-received">' + formatCurrency(totalReceived) + '</td>' +
          '<td class="amount ' + (pending > 0 ? 'amount-pending' : '') + '">' + formatCurrency(pending) + '</td>' +
          '<td><span class="badge ' + statusClass + '">' + escapeHtml(b.status) + '</span></td>' +
          '<td><div style="display:flex;gap:6px;flex-wrap:wrap;">' +
            '<button class="btn btn-warning btn-small" onclick="openCheckoutModal(\'' + b.id + '\')" title="Check Out with KOT + Add-On">' +
              '<span class="material-icons" style="font-size:14px">logout</span> Checkout</button>' +
            '<button class="btn btn-secondary btn-small" onclick="generateBill(\'' + b.id + '\')" title="Generate Bill">' +
              '<span class="material-icons" style="font-size:14px">receipt</span> Bill</button>' +
            (pending > 0 ? '<button class="btn btn-primary btn-small" onclick="openCollectModalById(\'' + b.id + '\')">Collect</button>' : '') +
          '</div></td>' +
          '</tr>';
      });
      html += '</tbody></table></div>';
      container.innerHTML = html;
    }

    function updateMonthlySummary() {
      var startInput = document.getElementById('summaryStartDate');
      var endInput = document.getElementById('summaryEndDate');

      // Default: current month start to today
      if (!startInput.value) {
        var now = new Date();
        startInput.value = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0') + '-01';
      }
      if (!endInput.value) {
        endInput.value = getToday();
      }

      var startDate = startInput.value;
      var endDate = endInput.value;

      var mBookings = 0;
      var mRoomCharge = 0;
      var mKot = 0;
      var mAddOn = 0;
      var mCollection = 0;
      var mCollected = 0;
      var mPending = 0;

      bookings.forEach(function(b) {
        if (b.status === 'CANCELLED') return;
        // Match bookings whose checkout falls within the date range (inclusive)
        var match = b.checkOut && b.checkOut >= startDate && b.checkOut <= endDate;
        if (match) {
          mBookings++;
          var roomCharge = parseFloat(b.totalAmount) || 0;
          var kotAmt = parseFloat(b.kotAmount) || 0;
          var addOnAmt = 0;
          if (b.addOns && b.addOns.length > 0) {
            b.addOns.forEach(function(a) { addOnAmt += parseFloat(a.amount) || 0; });
          }
          // Room charge is total minus KOT and add-on (they get added at checkout)
          var baseRoom = roomCharge - kotAmt - addOnAmt;
          if (baseRoom < 0) baseRoom = roomCharge; // fallback if not yet checked out

          mRoomCharge += baseRoom;
          mKot += kotAmt;
          mAddOn += addOnAmt;
          mCollection += roomCharge;

          var totalReceived = (parseFloat(b.advanceReceived) || 0) + (parseFloat(b.balanceReceived) || 0);
          mCollected += totalReceived;
          var pending = roomCharge - totalReceived;
          if (pending > 0) mPending += pending;
        }
      });

      document.getElementById('monthlyBookings').textContent = mBookings;
      document.getElementById('summaryRoomCharge').textContent = formatCurrency(mRoomCharge);
      document.getElementById('summaryKot').textContent = formatCurrency(mKot);
      document.getElementById('summaryAddOn').textContent = formatCurrency(mAddOn);
      document.getElementById('monthlyCollection').textContent = formatCurrency(mCollection);
      document.getElementById('monthlyCollected').textContent = formatCurrency(mCollected);
      document.getElementById('monthlyPending').textContent = formatCurrency(mPending);
    }

    // ========== SUMMARY DOWNLOAD ==========
    function getSummaryFilteredBookings() {
      var startDate = document.getElementById('summaryStartDate').value;
      var endDate = document.getElementById('summaryEndDate').value;
      if (!startDate || !endDate) return [];
      return bookings.filter(function(b) {
        if (b.status === 'CANCELLED') return false;
        return b.checkOut && b.checkOut >= startDate && b.checkOut <= endDate;
      }).sort(function(a, b) {
        if (a.checkOut < b.checkOut) return -1;
        if (a.checkOut > b.checkOut) return 1;
        if (a.source < b.source) return -1;
        if (a.source > b.source) return 1;
        return 0;
      });
    }

    function buildSummaryHeaders() {
      return [
        'Checkout Date', 'Booking ID', 'Guest Name', 'Phone', 'Pax',
        'Room No', 'Room Category', 'No of Rooms', 'Nights',
        'Check-in', 'Checkout', 'Meal Plan',
        'Source', 'Agent Name', 'Payment Type',
        'Room Charge', 'KOT Amount', 'Add-On Details', 'Add-On Amount', 'Total Amount',
        'Advance Received', 'Advance Date', 'Advance Mode',
        'Balance Received', 'Balance Date', 'Balance Mode',
        'Total Collected', 'Pending Amount', 'Status', 'Remarks'
      ];
    }

    function buildSummaryRow(b) {
      var kotAmt = parseFloat(b.kotAmount) || 0;
      var addOnAmt = 0;
      var addOnDetails = '';
      if (b.addOns && b.addOns.length > 0) {
        b.addOns.forEach(function(a) { addOnAmt += parseFloat(a.amount) || 0; });
        addOnDetails = b.addOns.map(function(a) { return a.type + ': ' + a.amount; }).join('; ');
      }
      var totalAmt = parseFloat(b.totalAmount) || 0;
      var baseRoom = totalAmt - kotAmt - addOnAmt;
      if (baseRoom < 0) baseRoom = totalAmt;
      var totalReceived = (parseFloat(b.advanceReceived) || 0) + (parseFloat(b.balanceReceived) || 0);
      var pending = totalAmt - totalReceived;
      if (pending < 0) pending = 0;
      var nights = calculateNights(b.checkIn, b.checkOut);

      return [
        b.checkOut,
        b.id,
        b.guestName,
        b.phone || '',
        b.pax || 1,
        (b.roomNo || '').replace(/,/g, ' / '),
        b.roomCategory || '',
        b.noOfRooms || 1,
        nights,
        b.checkIn,
        b.checkOut,
        b.mealPlan || '',
        b.source || '',
        b.sourceName || '',
        b.paymentType || '',
        baseRoom,
        kotAmt,
        addOnDetails,
        addOnAmt,
        totalAmt,
        parseFloat(b.advanceReceived) || 0,
        b.advanceDate || '',
        b.paymentMode || '',
        parseFloat(b.balanceReceived) || 0,
        b.balanceDate || '',
        b.balancePaymentMode || '',
        totalReceived,
        pending,
        b.status,
        b.remarks || ''
      ];
    }

    function buildSummaryTotalsRow(filtered) {
      var t = { room: 0, kot: 0, addOn: 0, total: 0, adv: 0, bal: 0, collected: 0, pending: 0 };
      filtered.forEach(function(b) {
        var kotAmt = parseFloat(b.kotAmount) || 0;
        var addOnAmt = 0;
        if (b.addOns && b.addOns.length > 0) {
          b.addOns.forEach(function(a) { addOnAmt += parseFloat(a.amount) || 0; });
        }
        var totalAmt = parseFloat(b.totalAmount) || 0;
        var baseRoom = totalAmt - kotAmt - addOnAmt;
        if (baseRoom < 0) baseRoom = totalAmt;
        t.room += baseRoom;
        t.kot += kotAmt;
        t.addOn += addOnAmt;
        t.total += totalAmt;
        t.adv += parseFloat(b.advanceReceived) || 0;
        t.bal += parseFloat(b.balanceReceived) || 0;
        t.collected += (parseFloat(b.advanceReceived) || 0) + (parseFloat(b.balanceReceived) || 0);
        var pend = totalAmt - ((parseFloat(b.advanceReceived) || 0) + (parseFloat(b.balanceReceived) || 0));
        if (pend > 0) t.pending += pend;
      });
      return ['', '', 'TOTAL (' + filtered.length + ' bookings)', '', '', '', '', '', '',
        '', '', '', '', '', '',
        t.room, t.kot, '', t.addOn, t.total, t.adv, '', '', t.bal, '', '', t.collected, t.pending, '', ''];
    }

    function downloadSummaryData(format) {
      var filtered = getSummaryFilteredBookings();
      if (filtered.length === 0) {
        showToast('No bookings in selected date range', 'error');
        return;
      }
      var startDate = document.getElementById('summaryStartDate').value;
      var endDate = document.getElementById('summaryEndDate').value;
      var fileName = 'Neelkanth-Summary-' + startDate + '-to-' + endDate;

      if (format === 'csv') {
        downloadSummaryCSV(filtered, fileName);
      } else if (format === 'excel') {
        downloadSummaryExcel(filtered, fileName);
      } else if (format === 'pdf') {
        downloadSummaryPDF(filtered, fileName, startDate, endDate);
      }
    }

    // --- CSV ---
    function downloadSummaryCSV(filtered, fileName) {
      var headers = buildSummaryHeaders();
      var rows = filtered.map(buildSummaryRow);
      rows.push(buildSummaryTotalsRow(filtered));
      var csvContent = [headers].concat(rows).map(function(row) {
        return row.map(function(cell) {
          return '"' + String(cell).replace(/"/g, '""') + '"';
        }).join(',');
      }).join('\n');
      var blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
      var url = URL.createObjectURL(blob);
      var link = document.createElement('a');
      link.href = url;
      link.download = fileName + '.csv';
      link.click();
      URL.revokeObjectURL(url);
      showToast('CSV downloaded', 'success');
    }

    // --- EXCEL (HTML table-based .xls) ---
    function downloadSummaryExcel(filtered, fileName) {
      var headers = buildSummaryHeaders();
      var rows = filtered.map(buildSummaryRow);
      var totals = buildSummaryTotalsRow(filtered);

      var html = '<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel">';
      html += '<head><meta charset="UTF-8"><!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet>';
      html += '<x:Name>Summary</x:Name><x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions>';
      html += '</x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]--></head><body>';
      html += '<table border="1" cellpadding="4" cellspacing="0" style="border-collapse:collapse;font-family:Arial,sans-serif;font-size:11px;">';

      // Title row
      html += '<tr><td colspan="' + headers.length + '" style="font-size:14px;font-weight:bold;text-align:center;background:#1e3a5f;color:white;padding:10px;">';
      html += 'The Neelkanth Grand - Booking Summary</td></tr>';
      html += '<tr><td colspan="' + headers.length + '" style="font-size:11px;text-align:center;background:#e8ecf1;padding:6px;">';
      html += 'Period: ' + formatDate(document.getElementById('summaryStartDate').value) + ' to ' + formatDate(document.getElementById('summaryEndDate').value) + '</td></tr>';

      // Headers
      html += '<tr>';
      headers.forEach(function(h) {
        html += '<th style="background:#2d5a87;color:white;padding:6px 8px;font-size:10px;white-space:nowrap;">' + h + '</th>';
      });
      html += '</tr>';

      // Data rows
      var lastDate = '';
      rows.forEach(function(row) {
        var isNewDate = row[0] !== lastDate;
        lastDate = row[0];
        html += '<tr' + (isNewDate ? ' style="border-top:2px solid #1e3a5f;"' : '') + '>';
        row.forEach(function(cell, ci) {
          var style = 'padding:4px 6px;font-size:10px;';
          // Number columns: right align
          if ([4,7,8,15,16,18,19,20,23,26,27].indexOf(ci) !== -1) {
            style += 'text-align:right;';
            if (typeof cell === 'number') cell = cell.toLocaleString('en-IN');
          }
          html += '<td style="' + style + '">' + escapeHtml(String(cell)) + '</td>';
        });
        html += '</tr>';
      });

      // Totals row
      html += '<tr>';
      totals.forEach(function(cell, ci) {
        var style = 'padding:6px 8px;font-weight:bold;font-size:11px;background:#f0f4f8;border-top:2px solid #1e3a5f;';
        if ([4,7,8,15,16,18,19,20,23,26,27].indexOf(ci) !== -1) {
          style += 'text-align:right;';
          if (typeof cell === 'number') cell = cell.toLocaleString('en-IN');
        }
        html += '<td style="' + style + '">' + escapeHtml(String(cell)) + '</td>';
      });
      html += '</tr>';

      html += '</table></body></html>';

      var blob = new Blob([html], { type: 'application/vnd.ms-excel;charset=utf-8;' });
      var url = URL.createObjectURL(blob);
      var link = document.createElement('a');
      link.href = url;
      link.download = fileName + '.xls';
      link.click();
      URL.revokeObjectURL(url);
      showToast('Excel downloaded', 'success');
    }

    // --- PDF (printable HTML window) ---
    function downloadSummaryPDF(filtered, fileName, startDate, endDate) {
      var headers = buildSummaryHeaders();
      var rows = filtered.map(buildSummaryRow);
      var totals = buildSummaryTotalsRow(filtered);

      // Compute summary totals
      var sT = { room: 0, kot: 0, addOn: 0, total: 0, collected: 0, pending: 0 };
      filtered.forEach(function(b) {
        var kotAmt = parseFloat(b.kotAmount) || 0;
        var addOnAmt = 0;
        if (b.addOns && b.addOns.length > 0) b.addOns.forEach(function(a) { addOnAmt += parseFloat(a.amount) || 0; });
        var totalAmt = parseFloat(b.totalAmount) || 0;
        var baseRoom = totalAmt - kotAmt - addOnAmt;
        if (baseRoom < 0) baseRoom = totalAmt;
        sT.room += baseRoom; sT.kot += kotAmt; sT.addOn += addOnAmt; sT.total += totalAmt;
        var recv = (parseFloat(b.advanceReceived) || 0) + (parseFloat(b.balanceReceived) || 0);
        sT.collected += recv;
        var pend = totalAmt - recv; if (pend > 0) sT.pending += pend;
      });

      var pdfHtml = '<!DOCTYPE html><html><head><title>' + fileName + '</title>';
      pdfHtml += '<style>';
      pdfHtml += 'body{font-family:Arial,sans-serif;margin:20px;color:#1c2038;}';
      pdfHtml += '.header{text-align:center;margin-bottom:20px;}';
      pdfHtml += '.header h1{font-size:18px;margin:0;color:#1e3a5f;}';
      pdfHtml += '.header p{font-size:12px;color:#6b7280;margin:4px 0;}';
      pdfHtml += '.summary-cards{display:flex;gap:12px;margin-bottom:20px;flex-wrap:wrap;}';
      pdfHtml += '.s-card{flex:1;min-width:100px;padding:12px;border-radius:8px;text-align:center;border:1px solid #e5e7eb;}';
      pdfHtml += '.s-card .label{font-size:10px;color:#6b7280;margin-bottom:4px;}';
      pdfHtml += '.s-card .val{font-size:16px;font-weight:700;}';
      pdfHtml += '.blue{color:#1e3a5f;} .green{color:#059669;} .red{color:#dc2626;}';
      pdfHtml += 'table{width:100%;border-collapse:collapse;font-size:9px;margin-top:10px;}';
      pdfHtml += 'th{background:#1e3a5f;color:white;padding:5px 4px;text-align:left;white-space:nowrap;}';
      pdfHtml += 'td{padding:4px;border-bottom:1px solid #e5e7eb;}';
      pdfHtml += 'tr.date-break{border-top:2px solid #1e3a5f;}';
      pdfHtml += '.totals td{font-weight:bold;background:#f0f4f8;border-top:2px solid #1e3a5f;font-size:10px;}';
      pdfHtml += '.right{text-align:right;}';
      pdfHtml += '@media print{body{margin:10px;} .no-print{display:none;}}';
      pdfHtml += '</style></head><body>';

      // Header
      pdfHtml += '<div class="header">';
      pdfHtml += '<h1>The Neelkanth Grand - by AKS Hospitality</h1>';
      pdfHtml += '<p>Booking Summary: ' + formatDate(startDate) + ' to ' + formatDate(endDate) + '</p>';
      pdfHtml += '<p>Total Bookings: ' + filtered.length + '</p>';
      pdfHtml += '</div>';

      // Summary cards
      pdfHtml += '<div class="summary-cards">';
      pdfHtml += '<div class="s-card"><div class="label">Room Charge</div><div class="val blue">' + formatCurrency(sT.room) + '</div></div>';
      pdfHtml += '<div class="s-card"><div class="label">KOT</div><div class="val blue">' + formatCurrency(sT.kot) + '</div></div>';
      pdfHtml += '<div class="s-card"><div class="label">Add-On</div><div class="val blue">' + formatCurrency(sT.addOn) + '</div></div>';
      pdfHtml += '<div class="s-card"><div class="label">Total</div><div class="val blue">' + formatCurrency(sT.total) + '</div></div>';
      pdfHtml += '<div class="s-card"><div class="label">Collected</div><div class="val green">' + formatCurrency(sT.collected) + '</div></div>';
      pdfHtml += '<div class="s-card"><div class="label">Pending</div><div class="val red">' + formatCurrency(sT.pending) + '</div></div>';
      pdfHtml += '</div>';

      // Print/Save button
      pdfHtml += '<div class="no-print" style="text-align:center;margin-bottom:15px;">';
      pdfHtml += '<button onclick="window.print()" style="padding:10px 30px;background:#1e3a5f;color:white;border:none;border-radius:8px;font-size:14px;cursor:pointer;font-weight:600;">';
      pdfHtml += 'Print / Save as PDF</button></div>';

      // Table
      // Use a reduced set of columns for PDF readability
      var pdfHeaders = ['Date', 'ID', 'Guest', 'Room', 'Category', 'Nights', 'Source', 'Agent',
        'Payment Type', 'Room Charge', 'KOT', 'Add-On', 'Total', 'Collected', 'Pending', 'Status'];
      pdfHtml += '<table><thead><tr>';
      pdfHeaders.forEach(function(h) { pdfHtml += '<th>' + h + '</th>'; });
      pdfHtml += '</tr></thead><tbody>';

      var lastDate = '';
      rows.forEach(function(row) {
        var isNewDate = row[0] !== lastDate;
        lastDate = row[0];
        pdfHtml += '<tr' + (isNewDate ? ' class="date-break"' : '') + '>';
        // Map: [0]=checkoutDate, [1]=id, [2]=guest, [5]=room, [6]=category, [8]=nights, [12]=source, [13]=agent,
        //       [14]=payType, [15]=roomCharge, [16]=kot, [18]=addOnAmt, [19]=totalAmt, [26]=collected, [27]=pending, [28]=status
        var pdfCols = [0,1,2,5,6,8,12,13,14,15,16,18,19,26,27,28];
        pdfCols.forEach(function(ci) {
          var cell = row[ci];
          var cls = '';
          if ([5,7,8,9,10,11,12,13,14,15].indexOf(pdfCols.indexOf(ci)) !== -1 &&
              typeof cell === 'number') {
            cls = ' class="right"';
            cell = cell.toLocaleString('en-IN');
          }
          // Format dates in the Date column
          if (ci === 0 && cell) cell = formatDate(cell);
          pdfHtml += '<td' + cls + '>' + escapeHtml(String(cell)) + '</td>';
        });
        pdfHtml += '</tr>';
      });

      // Totals row
      pdfHtml += '<tr class="totals">';
      pdfHtml += '<td colspan="2"></td><td>TOTAL</td><td colspan="6"></td>';
      pdfHtml += '<td class="right">' + sT.room.toLocaleString('en-IN') + '</td>';
      pdfHtml += '<td class="right">' + sT.kot.toLocaleString('en-IN') + '</td>';
      pdfHtml += '<td class="right">' + sT.addOn.toLocaleString('en-IN') + '</td>';
      pdfHtml += '<td class="right">' + sT.total.toLocaleString('en-IN') + '</td>';
      pdfHtml += '<td class="right">' + sT.collected.toLocaleString('en-IN') + '</td>';
      pdfHtml += '<td class="right">' + sT.pending.toLocaleString('en-IN') + '</td>';
      pdfHtml += '<td></td>';
      pdfHtml += '</tr>';

      pdfHtml += '</tbody></table></body></html>';

      var win = window.open('', '_blank');
      win.document.write(pdfHtml);
      win.document.close();
      showToast('PDF ready - use Print / Save as PDF', 'success');
    }

    // ========== ROOM INVENTORY ==========
    var ALL_ROOMS = [
      '101','102','103','104','105',
      '201','202','203','204','205','206',
      '301','302','303','304','305','306',
      '401','402','403'
    ];

    var ROOM_TYPE = {
      '101':'Non-Balcony','102':'Non-Balcony','104':'Non-Balcony','105':'Non-Balcony',
      '201':'Non-Balcony','202':'Non-Balcony','206':'Non-Balcony','303':'Non-Balcony',
      '103':'Balcony','203':'Balcony','204':'Balcony','205':'Balcony',
      '301':'Balcony','302':'Balcony','305':'Balcony','306':'Balcony',
      '304':'Mini Family','401':'Mini Family',
      '402':'Royal Suite Duplex','403':'Royal Suite Duplex'
    };

    function getBookingRooms(b) {
      if (!b.roomNo) return [];
      return b.roomNo.split(',').map(function(r) { return r.trim(); });
    }

    function isRoomOccupied(room, dateStr, excludeId) {
      return bookings.some(function(b) {
        if (b.status === 'CANCELLED') return false;
        if (excludeId && b.id === excludeId) return false;
        var bRooms = getBookingRooms(b);
        if (bRooms.indexOf(room) === -1) return false;
        return b.checkIn <= dateStr && b.checkOut > dateStr;
      });
    }

    function getOccupantBooking(room, dateStr) {
      return bookings.find(function(bk) {
        if (bk.status === 'CANCELLED') return false;
        var bRooms = getBookingRooms(bk);
        if (bRooms.indexOf(room) === -1) return false;
        return bk.checkIn <= dateStr && bk.checkOut > dateStr;
      }) || null;
    }

    function getOccupantName(room, dateStr) {
      var b = getOccupantBooking(room, dateStr);
      return b ? b.guestName : '';
    }

    function renderInventory() {
      renderInventoryDayView();
      renderInventoryMonthGrid();
      // Init occupancy if not set
      if (!document.getElementById('occMonth').value) {
        var now = new Date();
        var cm = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0');
        document.getElementById('occMonth').value = cm;
        // Populate year dropdown
        var yearSel = document.getElementById('occYear');
        if (yearSel.options.length <= 1) {
          yearSel.innerHTML = '';
          for (var y = now.getFullYear() - 1; y <= now.getFullYear() + 1; y++) {
            var opt = document.createElement('option');
            opt.value = y; opt.textContent = y;
            if (y === now.getFullYear()) opt.selected = true;
            yearSel.appendChild(opt);
          }
        }
      }
      renderOccupancyReport();
    }

    // Day-wise detailed view
    function renderInventoryDayView() {
      var dateStr = document.getElementById('inventoryDate').value;
      if (!dateStr) dateStr = getToday();
      var container = document.getElementById('inventoryDayView');

      var occupied = [];
      var vacant = [];

      ALL_ROOMS.forEach(function(rm) {
        var type = ROOM_TYPE[rm] || '';
        if (isRoomOccupied(rm, dateStr)) {
          var bk = getOccupantBooking(rm, dateStr);
          occupied.push({ room: rm, type: type, guest: bk ? bk.guestName : '', pax: bk ? (bk.pax || 1) : 0 });
        } else {
          vacant.push({ room: rm, type: type });
        }
      });

      var html = '<h4 style="margin-bottom:12px;color:#1e3a5f;">Date: <strong>' + formatDate(dateStr) + '</strong> &mdash; ' +
        '<span style="color:#065f46">' + vacant.length + ' Vacant</span> | ' +
        '<span style="color:#991b1b">' + occupied.length + ' Occupied</span> (of ' + ALL_ROOMS.length + ')</h4>';

      html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">';

      // Vacant rooms
      html += '<div><h5 style="color:#065f46;margin-bottom:8px;font-size:13px;text-transform:uppercase;letter-spacing:0.5px;">Vacant Rooms (' + vacant.length + ')</h5>';
      html += '<table class="report-table" style="margin:0"><thead><tr><th>Room</th><th>Type</th></tr></thead><tbody>';
      if (vacant.length === 0) {
        html += '<tr><td colspan="2" style="text-align:center;color:#6b7280">No vacant rooms</td></tr>';
      } else {
        vacant.forEach(function(v) {
          html += '<tr><td><strong>' + v.room + '</strong></td><td>' + escapeHtml(v.type) + '</td></tr>';
        });
      }
      html += '</tbody></table></div>';

      // Occupied rooms
      html += '<div><h5 style="color:#991b1b;margin-bottom:8px;font-size:13px;text-transform:uppercase;letter-spacing:0.5px;">Occupied Rooms (' + occupied.length + ')</h5>';
      html += '<table class="report-table" style="margin:0"><thead><tr><th>Room</th><th>Type</th><th>Guest</th><th>Adults</th></tr></thead><tbody>';
      if (occupied.length === 0) {
        html += '<tr><td colspan="4" style="text-align:center;color:#6b7280">No occupied rooms</td></tr>';
      } else {
        occupied.forEach(function(o) {
          html += '<tr><td><strong>' + o.room + '</strong></td><td>' + escapeHtml(o.type) + '</td><td>' + escapeHtml(o.guest) + '</td><td>' + o.pax + '</td></tr>';
        });
      }
      html += '</tbody></table></div>';

      html += '</div>';
      container.innerHTML = html;

      // Update summary chip
      document.getElementById('invTodaySummary').textContent =
        'Today: ' + occupied.length + ' Occupied | ' + vacant.length + ' Vacant (of ' + ALL_ROOMS.length + ')';
    }

    // Month grid
    function renderInventoryMonthGrid() {
      var monthStr = document.getElementById('inventoryMonth').value;
      if (!monthStr) return;

      var parts = monthStr.split('-');
      var year = parseInt(parts[0]);
      var month = parseInt(parts[1]) - 1;
      var daysInMonth = new Date(year, month + 1, 0).getDate();
      var today = getToday();

      var dates = [];
      for (var d = 1; d <= daysInMonth; d++) {
        dates.push(monthStr + '-' + String(d).padStart(2, '0'));
      }

      var html = '<table class="inv-table"><thead><tr>';
      html += '<th class="room-col">Room</th><th class="room-col" style="min-width:80px">Type</th>';
      dates.forEach(function(dt, idx) {
        var dayNum = idx + 1;
        var isToday = dt === today;
        html += '<th' + (isToday ? ' class="cell-today"' : '') + '>' + dayNum + '</th>';
      });
      html += '</tr></thead><tbody>';

      var daySummary = dates.map(function() { return { occ: 0, vac: 0 }; });

      ALL_ROOMS.forEach(function(rm) {
        var type = ROOM_TYPE[rm] || '';
        html += '<tr><td class="room-col">' + rm + '</td><td class="room-col" style="font-size:10px;font-weight:400;color:#6b7280">' + type + '</td>';
        dates.forEach(function(dt, idx) {
          var isToday = dt === today;
          var occ = isRoomOccupied(rm, dt);
          if (occ) {
            daySummary[idx].occ++;
            var bk = getOccupantBooking(rm, dt);
            var guest = bk ? bk.guestName : '';
            var pax = bk ? (bk.pax || 1) : 0;
            var initials = guest.split(' ').map(function(w) { return w[0]; }).join('').toUpperCase().substring(0, 2);
            html += '<td class="cell-occupied' + (isToday ? ' cell-today' : '') + '" title="' + escapeHtml(guest) + ' (' + pax + ' adults)">' + initials + '</td>';
          } else {
            daySummary[idx].vac++;
            html += '<td class="cell-vacant' + (isToday ? ' cell-today' : '') + '"></td>';
          }
        });
        html += '</tr>';
      });

      // Summary rows
      html += '<tr style="font-weight:700;background:#f0f4f8"><td class="room-col" style="background:#f0f4f8">Occ</td><td style="background:#f0f4f8"></td>';
      daySummary.forEach(function(s, idx) {
        var isToday = dates[idx] === today;
        html += '<td' + (isToday ? ' class="cell-today"' : '') + ' style="color:#991b1b">' + s.occ + '</td>';
      });
      html += '</tr>';

      html += '<tr style="font-weight:700;background:#f0f4f8"><td class="room-col" style="background:#f0f4f8">Vac</td><td style="background:#f0f4f8"></td>';
      daySummary.forEach(function(s, idx) {
        var isToday = dates[idx] === today;
        html += '<td' + (isToday ? ' class="cell-today"' : '') + ' style="color:#065f46">' + s.vac + '</td>';
      });
      html += '</tr>';

      html += '</tbody></table>';
      document.getElementById('inventoryTableWrap').innerHTML = html;
    }

    // ========== OCCUPANCY REPORT ==========
    function toggleOccFilters() {
      var vt = document.getElementById('occViewType').value;
      document.getElementById('occMonth').style.display = vt === 'month' ? 'block' : 'none';
      document.getElementById('occYear').style.display = vt === 'year' ? 'block' : 'none';
      document.getElementById('occFrom').style.display = vt === 'custom' ? 'block' : 'none';
      document.getElementById('occToLabel').style.display = vt === 'custom' ? 'inline' : 'none';
      document.getElementById('occTo').style.display = vt === 'custom' ? 'block' : 'none';
    }

    function getOccDateRange() {
      var vt = document.getElementById('occViewType').value;
      var startDate, endDate;
      if (vt === 'month') {
        var m = document.getElementById('occMonth').value;
        if (!m) return null;
        var p = m.split('-');
        startDate = m + '-01';
        endDate = toLocalDateStr(new Date(parseInt(p[0]), parseInt(p[1]), 0));
      } else if (vt === 'year') {
        var y = document.getElementById('occYear').value;
        if (!y) return null;
        startDate = y + '-01-01';
        endDate = y + '-12-31';
      } else {
        startDate = document.getElementById('occFrom').value;
        endDate = document.getElementById('occTo').value;
        if (!startDate || !endDate) return null;
      }
      return { start: startDate, end: endDate };
    }

    function getDatesInRange(start, end) {
      var dates = [];
      var dt = start;
      var safety = 0;
      while (dt <= end && safety < 400) {
        dates.push(dt);
        var next = new Date(dt + 'T00:00:00');
        next.setDate(next.getDate() + 1);
        dt = toLocalDateStr(next);
        safety++;
      }
      return dates;
    }

    function renderOccupancyReport() {
      var range = getOccDateRange();
      var container = document.getElementById('occupancyReportContent');
      if (!range) {
        container.innerHTML = '<p style="color:#6b7280;text-align:center;padding:20px;">Select a period</p>';
        return;
      }

      var dates = getDatesInRange(range.start, range.end);
      var totalSlots = ALL_ROOMS.length * dates.length; // max possible room-nights
      var totalOccupied = 0;
      var agentOccupied = {}; // agent => room-nights count

      dates.forEach(function(dt) {
        ALL_ROOMS.forEach(function(rm) {
          var bk = getOccupantBooking(rm, dt);
          if (bk) {
            totalOccupied++;
            var agentKey = 'Walk-in';
            if (bk.source === 'Agent' || bk.source === 'OTA') {
              agentKey = bk.sourceName || bk.source;
            }
            agentOccupied[agentKey] = (agentOccupied[agentKey] || 0) + 1;
          }
        });
      });

      var occPct = totalSlots > 0 ? ((totalOccupied / totalSlots) * 100).toFixed(1) : '0.0';

      // Build report
      var html = '';

      // Overall occupancy card
      html += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:16px;margin-bottom:24px;">';
      html += '<div class="monthly-card"><div class="mc-label">Total Room-Nights</div><div class="mc-value blue">' + totalSlots + '</div></div>';
      html += '<div class="monthly-card"><div class="mc-label">Occupied Room-Nights</div><div class="mc-value orange">' + totalOccupied + '</div></div>';
      html += '<div class="monthly-card"><div class="mc-label">Vacant Room-Nights</div><div class="mc-value green">' + (totalSlots - totalOccupied) + '</div></div>';
      html += '<div class="monthly-card" style="border:2px solid #1e3a5f;"><div class="mc-label">Occupancy %</div><div class="mc-value" style="color:#1e3a5f;font-size:32px;">' + occPct + '%</div></div>';
      html += '</div>';

      // Occupancy progress bar
      html += '<div style="margin-bottom:24px;">';
      html += '<div style="background:#e5e7eb;border-radius:10px;height:28px;overflow:hidden;position:relative;">';
      html += '<div style="background:linear-gradient(135deg,#1e3a5f,#2d5a87);height:100%;width:' + occPct + '%;border-radius:10px;transition:width 0.5s;display:flex;align-items:center;justify-content:center;">';
      html += '<span style="color:white;font-size:12px;font-weight:700;">' + occPct + '%</span>';
      html += '</div></div></div>';

      // Agent-wise breakup
      var agents = Object.keys(agentOccupied).sort(function(a, b) { return agentOccupied[b] - agentOccupied[a]; });

      html += '<h4 style="color:#1e3a5f;margin-bottom:12px;display:flex;align-items:center;gap:8px;">' +
        '<span class="material-icons" style="font-size:20px;">group</span> Agent-wise Occupancy Contribution</h4>';

      html += '<table class="report-table"><thead><tr>' +
        '<th>Source / Agent</th><th>Room-Nights</th><th>Contribution %</th><th>Share of Occupied</th><th>Visual</th>' +
        '</tr></thead><tbody>';

      agents.forEach(function(agent) {
        var rn = agentOccupied[agent];
        var contribPct = totalSlots > 0 ? ((rn / totalSlots) * 100).toFixed(1) : '0.0';
        var sharePct = totalOccupied > 0 ? ((rn / totalOccupied) * 100).toFixed(1) : '0.0';

        html += '<tr>' +
          '<td><strong>' + escapeHtml(agent) + '</strong></td>' +
          '<td>' + rn + '</td>' +
          '<td class="amount">' + contribPct + '%</td>' +
          '<td class="amount" style="color:#1e3a5f;font-weight:700;">' + sharePct + '%</td>' +
          '<td style="min-width:120px;"><div style="background:#e5e7eb;border-radius:6px;height:16px;overflow:hidden;">' +
            '<div style="background:#3b82f6;height:100%;width:' + sharePct + '%;border-radius:6px;"></div>' +
          '</div></td>' +
          '</tr>';
      });

      if (agents.length === 0) {
        html += '<tr><td colspan="5" style="text-align:center;color:#6b7280;">No occupancy data</td></tr>';
      }

      html += '<tr class="total-row">' +
        '<td>TOTAL</td>' +
        '<td>' + totalOccupied + '</td>' +
        '<td class="amount">' + occPct + '%</td>' +
        '<td class="amount" style="font-weight:700;">100%</td>' +
        '<td></td></tr>';

      html += '</tbody></table>';
      container.innerHTML = html;
    }

    // ========== ROOM AVAILABILITY IN BOOKING FORM ==========
    function getAvailableAndOccupiedRooms() {
      var checkIn = document.getElementById('checkIn').value;
      var checkOut = document.getElementById('checkOut').value;
      var editId = document.getElementById('editBookingId').value;
      var availableRooms = [];
      var occupiedRooms = [];

      ALL_ROOMS.forEach(function(rm) {
        var occupied = false;
        if (checkIn && checkOut) {
          var dt = checkIn;
          while (dt < checkOut) {
            if (isRoomOccupied(rm, dt, editId)) { occupied = true; break; }
            var next = new Date(dt + 'T00:00:00');
            next.setDate(next.getDate() + 1);
            dt = toLocalDateStr(next);
          }
        } else if (checkIn) {
          occupied = isRoomOccupied(rm, checkIn, editId);
        }
        if (occupied) occupiedRooms.push(rm);
        else availableRooms.push(rm);
      });
      return { available: availableRooms, occupied: occupiedRooms };
    }

    function populateRoomSelect(selectEl, availableRooms, occupiedRooms) {
      var currentVal = selectEl.value;
      selectEl.innerHTML = '<option value="">Not Assigned</option>';
      availableRooms.forEach(function(rm) {
        var opt = document.createElement('option');
        opt.value = rm;
        opt.textContent = rm + ' - ' + (ROOM_TYPE[rm] || '') + ' (Available)';
        opt.style.color = '#065f46';
        selectEl.appendChild(opt);
      });
      occupiedRooms.forEach(function(rm) {
        var opt = document.createElement('option');
        opt.value = rm;
        opt.textContent = rm + ' - ' + (ROOM_TYPE[rm] || '') + ' (Occupied)';
        opt.style.color = '#991b1b';
        selectEl.appendChild(opt);
      });
      if (currentVal) selectEl.value = currentVal;
    }

    function updateRoomAvailability() {
      var checkIn = document.getElementById('checkIn').value;
      var hint = document.getElementById('roomAvailHint');
      if (!checkIn) { hint.textContent = ''; return; }

      var rooms = getAvailableAndOccupiedRooms();
      var container = document.getElementById('roomSelectContainer');
      var selects = container.querySelectorAll('select');
      selects.forEach(function(sel) {
        populateRoomSelect(sel, rooms.available, rooms.occupied);
      });

      hint.textContent = rooms.available.length + ' rooms available, ' + rooms.occupied.length + ' occupied';
      hint.className = 'room-avail-hint' + (rooms.available.length === 0 ? ' warn' : '');
    }

    function updateRoomSelects() {
      var count = parseInt(document.getElementById('noOfRooms').value) || 1;
      var container = document.getElementById('roomSelectContainer');
      var existing = container.querySelectorAll('select');
      var currentValues = [];
      existing.forEach(function(sel) { currentValues.push(sel.value); });

      container.innerHTML = '';
      for (var i = 0; i < count; i++) {
        var sel = document.createElement('select');
        sel.style.cssText = 'padding:10px 12px;border:2px solid #e5e7eb;border-radius:10px;font-size:13px;font-family:inherit;min-width:160px;';
        if (i === 0) sel.id = 'roomNo';
        sel.innerHTML = '<option value="">Not Assigned</option>';
        container.appendChild(sel);
      }
      updateRoomAvailability();
      // Restore values
      var newSelects = container.querySelectorAll('select');
      for (var i = 0; i < newSelects.length && i < currentValues.length; i++) {
        if (currentValues[i]) newSelects[i].value = currentValues[i];
      }
    }

    function getAllSelectedRooms() {
      var container = document.getElementById('roomSelectContainer');
      var selects = container.querySelectorAll('select');
      var rooms = [];
      selects.forEach(function(sel) { if (sel.value) rooms.push(sel.value); });
      return rooms.join(',');
    }

    // ========== BOOKING MODAL ==========
    function openBookingModal() {
      document.getElementById('bookingModal').classList.add('active');
      document.getElementById('modalTitle').textContent = 'New Booking';
      document.getElementById('editBookingId').value = '';
      document.getElementById('guestName').value = '';
      document.getElementById('guestPhone').value = '';
      document.getElementById('pax').value = '1';
      document.getElementById('kot').value = '';
      document.getElementById('noOfRooms').value = '1';
      document.getElementById('roomCategory').value = '';
      document.getElementById('checkIn').value = getToday();
      document.getElementById('checkOut').value = '';
      document.getElementById('roomSelectGroup').style.display = 'none';
      updateRoomSelects();
      document.getElementById('mealPlan').value = '';
      document.getElementById('bookingSource').value = 'Walk-in';
      document.getElementById('sourceName').value = '';
      document.getElementById('sourceNameOther').value = '';
      document.getElementById('sourceNameOther').style.display = 'none';
      document.getElementById('complimentary').value = '';
      document.getElementById('actualRoomRent').value = '';
      document.getElementById('totalAmount').value = '';
      document.getElementById('paymentType').value = 'Postpaid';
      document.getElementById('advanceReceived').value = '0';
      document.getElementById('paymentMode').value = '';
      document.getElementById('remarks').value = '';
      toggleSourceName();
      resetSaveBtn();
      updateNightsDisplay();
    }

    function openEditModalById(id) {
      var booking = bookings.find(function(b) { return b.id === id; });
      if (!booking) return;

      document.getElementById('bookingModal').classList.add('active');
      document.getElementById('modalTitle').textContent = 'Edit Booking';
      document.getElementById('editBookingId').value = booking.id;
      document.getElementById('guestName').value = booking.guestName;
      document.getElementById('guestPhone').value = booking.phone || '';
      document.getElementById('pax').value = booking.pax || 1;
      document.getElementById('kot').value = booking.kot || '';
      document.getElementById('noOfRooms').value = booking.noOfRooms || 1;
      document.getElementById('roomCategory').value = booking.roomCategory || '';
      document.getElementById('checkIn').value = booking.checkIn;
      document.getElementById('checkOut').value = booking.checkOut;
      // Show room selects in edit mode
      document.getElementById('roomSelectGroup').style.display = 'block';
      updateRoomSelects();
      var roomValues = (booking.roomNo || '').split(',').map(function(r) { return r.trim(); });
      var container = document.getElementById('roomSelectContainer');
      var selects = container.querySelectorAll('select');
      for (var ri = 0; ri < selects.length && ri < roomValues.length; ri++) {
        selects[ri].value = roomValues[ri];
      }
      document.getElementById('mealPlan').value = booking.mealPlan || '';
      document.getElementById('bookingSource').value = booking.source;
      // Set source name - check if it's a known agent or Other
      var knownAgents = Array.from(document.getElementById('sourceName').options).map(function(o){return o.value;});
      if (booking.sourceName && knownAgents.indexOf(booking.sourceName) === -1) {
        document.getElementById('sourceName').value = 'Other';
        document.getElementById('sourceNameOther').value = booking.sourceName;
        document.getElementById('sourceNameOther').style.display = 'block';
      } else {
        document.getElementById('sourceName').value = booking.sourceName || '';
        document.getElementById('sourceNameOther').value = '';
        document.getElementById('sourceNameOther').style.display = 'none';
      }
      document.getElementById('complimentary').value = booking.complimentary || '';
      document.getElementById('actualRoomRent').value = booking.actualRoomRent || '';
      document.getElementById('totalAmount').value = booking.totalAmount;
      document.getElementById('paymentType').value = booking.paymentType;
      document.getElementById('advanceReceived').value = booking.advanceReceived || 0;
      document.getElementById('paymentMode').value = booking.paymentMode || '';
      document.getElementById('remarks').value = booking.remarks || '';
      toggleSourceName();
      resetSaveBtn();
      updateRoomAvailability();
      updateNightsDisplay();
    }

    function closeBookingModal() {
      document.getElementById('bookingModal').classList.remove('active');
    }

    function toggleSourceName() {
      var source = document.getElementById('bookingSource').value;
      document.getElementById('sourceNameGroup').style.display =
        (source === 'OTA' || source === 'Agent') ? 'flex' : 'none';
      toggleOtherSource();
    }

    function toggleOtherSource() {
      var val = document.getElementById('sourceName').value;
      document.getElementById('sourceNameOther').style.display = val === 'Other' ? 'block' : 'none';
    }

    // Attach onchange to sourceName dropdown
    document.addEventListener('DOMContentLoaded', function() {
      var sn = document.getElementById('sourceName');
      if (sn) sn.addEventListener('change', toggleOtherSource);
    });

    function resetSaveBtn() {
      var btn = document.getElementById('saveBtn');
      btn.disabled = false;
      btn.innerHTML = '<span class="material-icons">save</span> Save Booking';
    }

    async function saveBooking() {
      var editId = document.getElementById('editBookingId').value;
      var guestName = document.getElementById('guestName').value.trim();
      var phone = document.getElementById('guestPhone').value.trim();
      var pax = parseInt(document.getElementById('pax').value) || 1;
      var kot = document.getElementById('kot').value;
      var roomNo = getAllSelectedRooms();
      var noOfRooms = parseInt(document.getElementById('noOfRooms').value) || 1;
      var roomCategory = document.getElementById('roomCategory').value;
      var checkIn = document.getElementById('checkIn').value;
      var checkOut = document.getElementById('checkOut').value;
      var mealPlan = document.getElementById('mealPlan').value;
      var source = document.getElementById('bookingSource').value;
      var sourceNameVal = document.getElementById('sourceName').value;
      var sourceName = sourceNameVal === 'Other' ? document.getElementById('sourceNameOther').value.trim() : sourceNameVal;
      var complimentary = document.getElementById('complimentary').value;
      var actualRoomRent = parseFloat(document.getElementById('actualRoomRent').value) || 0;
      var totalAmount = parseFloat(document.getElementById('totalAmount').value) || 0;
      var paymentType = document.getElementById('paymentType').value;
      var advanceReceived = parseFloat(document.getElementById('advanceReceived').value) || 0;
      var paymentMode = document.getElementById('paymentMode').value;
      var remarks = document.getElementById('remarks').value.trim();

      // Validation
      if (!guestName || !checkIn || !checkOut || !totalAmount) {
        showToast('Please fill all required fields', 'error');
        return;
      }

      if ((source === 'OTA' || source === 'Agent') && !sourceName) {
        showToast('Please enter source name', 'error');
        return;
      }

      try {
        if (editId) {
          // Update existing booking
          var backendId = getBackendBookingId(editId);
          if (!backendId) { showToast('Booking not found', 'error'); return; }

          var dto = {
            guestName: guestName, phone: phone, pax: pax, kot: kot,
            roomNo: roomNo, noOfRooms: noOfRooms, roomCategory: roomCategory,
            checkIn: checkIn, checkOut: checkOut, mealPlan: mealPlan,
            source: source, sourceName: (source === 'OTA' || source === 'Agent') ? sourceName : '',
            complimentary: complimentary, actualRoomRent: actualRoomRent,
            totalAmount: totalAmount, paymentType: paymentType,
            advanceReceived: advanceReceived, paymentMode: paymentMode, remarks: remarks
          };

          await apiFetch('/bookings/' + backendId, { method: 'PUT', body: dto });
          await loadBookingsFromAPI();
          closeBookingModal();
          renderBookings();
          updateDashboard();
          showToast('Booking updated!', 'success');
        } else {
          // New booking
          var dto = {
            guestName: guestName, phone: phone, pax: pax, kot: kot,
            roomNo: roomNo, noOfRooms: noOfRooms, roomCategory: roomCategory,
            checkIn: checkIn, checkOut: checkOut, mealPlan: mealPlan,
            source: source, sourceName: (source === 'OTA' || source === 'Agent') ? sourceName : '',
            complimentary: complimentary, actualRoomRent: actualRoomRent,
            totalAmount: totalAmount, paymentType: paymentType,
            advanceReceived: advanceReceived, paymentMode: paymentMode, remarks: remarks
          };

          await apiFetch('/bookings', { method: 'POST', body: dto });
          await loadBookingsFromAPI();
          closeBookingModal();
          renderBookings();
          updateDashboard();
          showToast('Booking added!', 'success');
        }
      } catch(e) {
        // toast already shown by apiFetch
      }
    }

    // ========== COLLECT PAYMENT ==========
    function openCollectModalById(id) {
      var booking = bookings.find(function(b) { return b.id === id; });
      if (!booking) return;

      var totalReceived = (parseFloat(booking.advanceReceived) || 0) + (parseFloat(booking.balanceReceived) || 0);
      var pending = (parseFloat(booking.totalAmount) || 0) - totalReceived;

      document.getElementById('collectModal').classList.add('active');
      document.getElementById('collectBookingId').value = booking.id;
      document.getElementById('collectPendingAmount').textContent = formatCurrency(pending);
      document.getElementById('collectAmount').value = pending > 0 ? pending : 0;
    }

    function closeCollectModal() {
      document.getElementById('collectModal').classList.remove('active');
    }

    async function collectPayment() {
      var id = document.getElementById('collectBookingId').value;
      var amount = parseFloat(document.getElementById('collectAmount').value) || 0;
      var mode = document.getElementById('collectPaymentMode').value;

      if (amount <= 0) {
        showToast('Please enter a valid amount', 'error');
        return;
      }

      var backendId = getBackendBookingId(id);
      if (!backendId) { showToast('Booking not found', 'error'); return; }

      try {
        await apiFetch('/bookings/' + backendId + '/collect', {
          method: 'POST',
          body: { amount: amount, paymentMode: mode }
        });
        await loadBookingsFromAPI();
        closeCollectModal();
        renderBookings();
        updateDashboard();
        showToast('Payment collected!', 'success');
      } catch(e) { /* toast shown */ }
    }

    // ========== CANCEL / RESCHEDULE ==========
    function openCancelModal(id) {
      var booking = bookings.find(function(b) { return b.id === id; });
      if (!booking) return;

      document.getElementById('cancelModal').classList.add('active');
      document.getElementById('cancelBookingId').value = booking.id;
      document.getElementById('cancelBookingName').textContent = booking.guestName + ' (' + booking.id + ')';
      document.getElementById('cancelBookingDate').textContent = formatDate(booking.checkOut);
      document.getElementById('cancelAction').value = 'cancel';
      document.getElementById('rescheduleDate').value = '';
      toggleRescheduleDate();
    }

    function closeCancelModal() {
      document.getElementById('cancelModal').classList.remove('active');
    }

    function toggleRescheduleDate() {
      var action = document.getElementById('cancelAction').value;
      document.getElementById('rescheduleDateGroup').style.display = action === 'reschedule' ? 'flex' : 'none';
      var btn = document.getElementById('cancelConfirmBtn');
      if (action === 'reschedule') {
        btn.innerHTML = '<span class="material-icons">event</span> Reschedule';
        btn.className = 'btn btn-warning';
      } else {
        btn.innerHTML = '<span class="material-icons">cancel</span> Cancel Booking';
        btn.className = 'btn btn-danger';
      }
    }

    async function confirmCancelOrReschedule() {
      var id = document.getElementById('cancelBookingId').value;
      var action = document.getElementById('cancelAction').value;
      var backendId = getBackendBookingId(id);
      if (!backendId) return;

      try {
        if (action === 'cancel') {
          await apiFetch('/bookings/' + backendId + '/cancel', { method: 'POST' });
          await loadBookingsFromAPI();
          closeCancelModal();
          renderBookings();
          updateDashboard();
          showToast('Booking cancelled', 'success');
        } else {
          var newDate = document.getElementById('rescheduleDate').value;
          if (!newDate) {
            showToast('Please select new checkout date', 'error');
            return;
          }
          await apiFetch('/bookings/' + backendId + '/reschedule', {
            method: 'POST',
            body: { newCheckOut: newDate }
          });
          await loadBookingsFromAPI();
          closeCancelModal();
          renderBookings();
          updateDashboard();
          showToast('Booking rescheduled to ' + formatDate(newDate), 'success');
        }
      } catch(e) { /* toast shown */ }
    }

    // ========== DELETE BOOKING ==========
    async function deleteBooking(id) {
      if (!confirm('Permanently delete this booking? This cannot be undone.')) return;

      var backendId = getBackendBookingId(id);
      if (!backendId) { showToast('Booking not found', 'error'); return; }

      try {
        await apiFetch('/bookings/' + backendId, { method: 'DELETE' });
        await loadBookingsFromAPI();
        renderBookings();
        updateDashboard();
        showToast('Booking deleted', 'success');
      } catch(e) { /* toast shown */ }
    }

    // ========== CHECK-IN ==========
    var checkinBookingData = null;

    function markCheckedIn(id) {
      var b = bookings.find(function(bk) { return bk.id === id; });
      if (!b) return;
      checkinBookingData = b;

      document.getElementById('checkinModal').classList.add('active');
      document.getElementById('checkinBookingId').value = b.id;
      document.getElementById('checkinNoOfRooms').value = b.noOfRooms || 1;
      document.getElementById('checkinRoomCategory').textContent = b.roomCategory || '-';

      var nights = calculateNights(b.checkIn, b.checkOut);
      document.getElementById('checkinGuestInfo').innerHTML =
        '<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">' +
        '<div><small style="color:#6b7280">Guest</small><br><strong>' + escapeHtml(b.guestName) + '</strong></div>' +
        '<div><small style="color:#6b7280">Pax</small><br><strong>' + (b.pax || 1) + '</strong></div>' +
        '<div><small style="color:#6b7280">Check-in</small><br>' + formatDate(b.checkIn) + '</div>' +
        '<div><small style="color:#6b7280">Check-out</small><br>' + formatDate(b.checkOut) + ' (' + nights + ' nights)</div>' +
        '<div><small style="color:#6b7280">Category</small><br>' + escapeHtml(b.roomCategory || '-') + '</div>' +
        '<div><small style="color:#6b7280">No. of Rooms</small><br>' + (b.noOfRooms || 1) + '</div>' +
        '</div>';

      updateCheckinRoomSelects();
    }

    function closeCheckinModal() {
      document.getElementById('checkinModal').classList.remove('active');
      checkinBookingData = null;
    }

    function updateCheckinRoomSelects() {
      if (!checkinBookingData) return;
      var count = parseInt(document.getElementById('checkinNoOfRooms').value) || 1;
      var container = document.getElementById('checkinRoomSelectContainer');
      container.innerHTML = '';

      // Get available rooms for this booking's dates
      var b = checkinBookingData;
      var availableRooms = [];
      var occupiedRooms = [];
      ALL_ROOMS.forEach(function(rm) {
        var occupied = false;
        if (b.checkIn && b.checkOut) {
          var dt = b.checkIn;
          var safety = 0;
          while (dt < b.checkOut && safety < 400) {
            if (isRoomOccupied(rm, dt, b.id)) { occupied = true; break; }
            var next = new Date(dt + 'T00:00:00');
            next.setDate(next.getDate() + 1);
            dt = toLocalDateStr(next);
            safety++;
          }
        }
        if (occupied) occupiedRooms.push(rm);
        else availableRooms.push(rm);
      });

      var existingRooms = (b.roomNo || '').split(',').map(function(r) { return r.trim(); }).filter(function(r) { return r; });

      for (var i = 0; i < count; i++) {
        var sel = document.createElement('select');
        sel.style.cssText = 'padding:10px 12px;border:2px solid #e5e7eb;border-radius:10px;font-size:13px;font-family:inherit;min-width:160px;';
        sel.innerHTML = '<option value="">Select Room</option>';
        availableRooms.forEach(function(rm) {
          var opt = document.createElement('option');
          opt.value = rm;
          opt.textContent = rm + ' - ' + (ROOM_TYPE[rm] || '') + ' (Available)';
          opt.style.color = '#065f46';
          sel.appendChild(opt);
        });
        occupiedRooms.forEach(function(rm) {
          var opt = document.createElement('option');
          opt.value = rm;
          opt.textContent = rm + ' - ' + (ROOM_TYPE[rm] || '') + ' (Occupied)';
          opt.style.color = '#991b1b';
          sel.appendChild(opt);
        });
        if (existingRooms[i]) sel.value = existingRooms[i];
        container.appendChild(sel);
      }

      var hint = document.getElementById('checkinRoomHint');
      hint.textContent = availableRooms.length + ' available, ' + occupiedRooms.length + ' occupied';
      hint.className = 'room-avail-hint' + (availableRooms.length === 0 ? ' warn' : '');
    }

    async function confirmCheckin() {
      var id = document.getElementById('checkinBookingId').value;
      var backendId = getBackendBookingId(id);
      if (!backendId) return;

      var container = document.getElementById('checkinRoomSelectContainer');
      var selects = container.querySelectorAll('select');
      var rooms = [];
      selects.forEach(function(sel) { if (sel.value) rooms.push(sel.value); });

      if (rooms.length === 0) {
        showToast('Please select at least one room', 'error');
        return;
      }

      try {
        await apiFetch('/bookings/' + backendId + '/checkin', {
          method: 'POST',
          body: {
            roomNo: rooms.join(','),
            noOfRooms: parseInt(document.getElementById('checkinNoOfRooms').value) || rooms.length
          }
        });
        await loadBookingsFromAPI();
        closeCheckinModal();
        renderBookings();
        updateDashboard();
        var bk = bookings.find(function(b) { return b.id === id; });
        showToast((bk ? bk.guestName : 'Guest') + ' checked in to Room ' + rooms.join('/') + '!', 'success');
      } catch(e) { /* toast shown */ }
    }

    // ========== CHECKOUT ==========
    var checkoutBookingData = null;

    function openCheckoutModal(id) {
      var b = bookings.find(function(bk) { return bk.id === id; });
      if (!b) return;
      checkoutBookingData = b;

      document.getElementById('checkoutModal').classList.add('active');
      document.getElementById('checkoutBookingId').value = b.id;

      var nights = calculateNights(b.checkIn, b.checkOut);
      document.getElementById('checkoutGuestInfo').innerHTML =
        '<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">' +
        '<div><small style="color:#6b7280">Guest</small><br><strong>' + escapeHtml(b.guestName) + '</strong></div>' +
        '<div><small style="color:#6b7280">Room</small><br><strong>' + escapeHtml(b.roomNo || 'N/A') + '</strong></div>' +
        '<div><small style="color:#6b7280">Check-in</small><br>' + formatDate(b.checkIn) + '</div>' +
        '<div><small style="color:#6b7280">Check-out</small><br>' + formatDate(b.checkOut) + ' (' + nights + ' nights)</div>' +
        '<div><small style="color:#6b7280">Pax</small><br>' + (b.pax || 1) + '</div>' +
        '<div><small style="color:#6b7280">Plan</small><br>' + escapeHtml(b.mealPlan || '-') + '</div>' +
        '</div>';

      document.getElementById('checkoutKotAmount').value = b.kotAmount || 0;
      document.getElementById('addOnChargesContainer').innerHTML = '';
      document.getElementById('checkoutPayMode').value = '';

      // Restore existing add-ons if any
      if (b.addOns && b.addOns.length > 0) {
        b.addOns.forEach(function(ao) {
          addAddOnRow(ao.type, ao.amount);
        });
      }

      updateCheckoutTotals();
    }

    function closeCheckoutModal() {
      document.getElementById('checkoutModal').classList.remove('active');
      checkoutBookingData = null;
    }

    function addAddOnRow(type, amount) {
      var container = document.getElementById('addOnChargesContainer');
      var row = document.createElement('div');
      row.style.cssText = 'display:flex;gap:8px;margin-bottom:8px;align-items:center;';
      row.innerHTML =
        '<select style="padding:8px 12px;border:2px solid #e5e7eb;border-radius:8px;font-size:13px;font-family:inherit;flex:1;">' +
          '<option value="">Select</option>' +
          '<option value="Heater"' + (type === 'Heater' ? ' selected' : '') + '>Heater</option>' +
          '<option value="Bonfire"' + (type === 'Bonfire' ? ' selected' : '') + '>Bonfire</option>' +
          '<option value="BJ"' + (type === 'BJ' ? ' selected' : '') + '>BJ (Bonfire + Jalebi)</option>' +
          '<option value="Honeymoon"' + (type === 'Honeymoon' ? ' selected' : '') + '>Honeymoon Decoration</option>' +
          '<option value="Birthday"' + (type === 'Birthday' ? ' selected' : '') + '>Birthday Decoration</option>' +
          '<option value="DJ"' + (type === 'DJ' ? ' selected' : '') + '>DJ</option>' +
          '<option value="Cake"' + (type === 'Cake' ? ' selected' : '') + '>Cake</option>' +
          '<option value="Other"' + (type === 'Other' ? ' selected' : '') + '>Other</option>' +
        '</select>' +
        '<input type="number" placeholder="Amount" min="0" value="' + (amount || '') + '" ' +
          'style="padding:8px 12px;border:2px solid #e5e7eb;border-radius:8px;font-size:13px;font-family:inherit;width:120px;" ' +
          'oninput="updateCheckoutTotals()">' +
        '<button onclick="this.parentElement.remove();updateCheckoutTotals();" ' +
          'style="background:#fee2e2;border:none;border-radius:8px;width:32px;height:32px;cursor:pointer;display:flex;align-items:center;justify-content:center;">' +
          '<span class="material-icons" style="font-size:16px;color:#ef4444;">close</span></button>';
      container.appendChild(row);
      updateCheckoutTotals();
    }

    function getAddOnTotal() {
      var total = 0;
      var rows = document.getElementById('addOnChargesContainer').children;
      for (var i = 0; i < rows.length; i++) {
        var input = rows[i].querySelector('input[type="number"]');
        if (input) total += parseFloat(input.value) || 0;
      }
      return total;
    }

    function getAddOnItems() {
      var items = [];
      var rows = document.getElementById('addOnChargesContainer').children;
      for (var i = 0; i < rows.length; i++) {
        var sel = rows[i].querySelector('select');
        var input = rows[i].querySelector('input[type="number"]');
        if (sel && input && (sel.value || parseFloat(input.value))) {
          items.push({ type: sel.value || 'Other', amount: parseFloat(input.value) || 0 });
        }
      }
      return items;
    }

    function updateCheckoutTotals() {
      if (!checkoutBookingData) return;
      var b = checkoutBookingData;
      var origTotal = parseFloat(b.totalAmount) || 0;
      var kotAmt = parseFloat(document.getElementById('checkoutKotAmount').value) || 0;
      var addOnTotal = getAddOnTotal();
      var grandTotal = origTotal + kotAmt + addOnTotal;
      var received = (parseFloat(b.advanceReceived) || 0) + (parseFloat(b.balanceReceived) || 0);
      var balance = grandTotal - received;

      document.getElementById('checkoutOrigTotal').textContent = formatCurrency(origTotal);
      document.getElementById('checkoutKotDisplay').textContent = formatCurrency(kotAmt);
      document.getElementById('checkoutAddOnDisplay').textContent = formatCurrency(addOnTotal);
      document.getElementById('checkoutGrandTotal').textContent = formatCurrency(grandTotal);
      document.getElementById('checkoutReceived').textContent = formatCurrency(received);
      document.getElementById('checkoutBalance').textContent = formatCurrency(balance > 0 ? balance : 0);
    }

    async function processCheckout() {
      var id = document.getElementById('checkoutBookingId').value;
      var backendId = getBackendBookingId(id);
      if (!backendId) return;

      var kotAmt = parseFloat(document.getElementById('checkoutKotAmount').value) || 0;
      var addOnItems = getAddOnItems();
      var addOnTotal = getAddOnTotal();
      var payMode = document.getElementById('checkoutPayMode').value;

      try {
        await apiFetch('/bookings/' + backendId + '/checkout', {
          method: 'POST',
          body: {
            kotAmount: kotAmt,
            addOns: addOnItems,
            paymentMode: payMode || undefined
          }
        });
        await loadBookingsFromAPI();
        closeCheckoutModal();
        renderBookings();
        updateDashboard();
        showToast('Guest checked out! ' + (kotAmt > 0 || addOnTotal > 0 ? 'Extra charges added.' : ''), 'success');
      } catch(e) { /* toast shown */ }
    }

    // ========== EXPORT CSV ==========
    function exportData() {
      if (bookings.length === 0) {
        showToast('No data to export', 'error');
        return;
      }

      var headers = [
        'Booking ID', 'Guest Name', 'Phone', 'Pax', 'KOT', 'Room', 'No. of Rooms',
        'Room Category', 'Check-in', 'Checkout', 'Plan', 'Source', 'Source Name',
        'Add-On', 'Actual Room Rent', 'Collection Amount', 'Payment Type',
        'Advance Received', 'Balance Received', 'Pending', 'Status', 'Payment Mode', 'Remarks'
      ];

      var rows = bookings.map(function(b) {
        var totalReceived = (parseFloat(b.advanceReceived) || 0) + (parseFloat(b.balanceReceived) || 0);
        var pending = (parseFloat(b.totalAmount) || 0) - totalReceived;
        return [
          b.id,
          b.guestName,
          b.phone || '',
          b.pax || 1,
          b.kot || '',
          b.roomNo,
          b.noOfRooms || 1,
          b.roomCategory || '',
          b.checkIn,
          b.checkOut,
          b.mealPlan || '',
          b.source,
          b.sourceName || '',
          b.complimentary || '',
          b.actualRoomRent || 0,
          b.totalAmount,
          b.paymentType,
          b.advanceReceived || 0,
          b.balanceReceived || 0,
          pending,
          b.status,
          b.paymentMode || '',
          b.remarks || ''
        ];
      });

      var csvContent = [headers].concat(rows).map(function(row) {
        return row.map(function(cell) {
          return '"' + String(cell).replace(/"/g, '""') + '"';
        }).join(',');
      }).join('\n');

      var blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      var url = URL.createObjectURL(blob);
      var link = document.createElement('a');
      link.href = url;
      link.download = 'neelkanth-grand-bookings-' + getToday() + '.csv';
      link.click();
      URL.revokeObjectURL(url);
      showToast('Exported successfully', 'success');
    }

    // ========== REPORTS ==========

    // Source-wise Report
    function renderSourceReport() {
      var from = document.getElementById('reportDateFrom').value;
      var to = document.getElementById('reportDateTo').value;

      var sources = {};
      // sources[name] = { bookings, totalAmount, collected, pending }

      bookings.forEach(function(b) {
        // Filter by checkout date range
        if (from && b.checkOut < from) return;
        if (to && b.checkOut > to) return;

        var src = b.source || 'Unknown';
        var srcName = b.sourceName ? src + ' - ' + b.sourceName : src;

        if (!sources[srcName]) {
          sources[srcName] = { bookings: 0, totalAmount: 0, collected: 0, pending: 0 };
        }

        var total = parseFloat(b.totalAmount) || 0;
        var totalReceived = (parseFloat(b.advanceReceived) || 0) + (parseFloat(b.balanceReceived) || 0);
        var pending = total - totalReceived;

        sources[srcName].bookings++;
        sources[srcName].totalAmount += total;
        sources[srcName].collected += totalReceived;
        if (pending > 0) sources[srcName].pending += pending;
      });

      var names = Object.keys(sources).sort();
      var container = document.getElementById('sourceReportContent');

      if (names.length === 0) {
        container.innerHTML = '<p style="color:#6b7280;text-align:center;padding:20px;">No data for selected date range</p>';
        return;
      }

      var grandTotal = { bookings: 0, totalAmount: 0, collected: 0, pending: 0 };

      var html = '<table class="report-table"><thead><tr>' +
        '<th>Source</th><th>Bookings</th><th>Total Amount</th><th>Collected</th><th>Pending</th>' +
        '</tr></thead><tbody>';

      names.forEach(function(name) {
        var s = sources[name];
        grandTotal.bookings += s.bookings;
        grandTotal.totalAmount += s.totalAmount;
        grandTotal.collected += s.collected;
        grandTotal.pending += s.pending;

        html += '<tr>' +
          '<td><strong>' + escapeHtml(name) + '</strong></td>' +
          '<td>' + s.bookings + '</td>' +
          '<td class="amount">' + formatCurrency(s.totalAmount) + '</td>' +
          '<td class="amount amount-received">' + formatCurrency(s.collected) + '</td>' +
          '<td class="amount ' + (s.pending > 0 ? 'amount-pending' : '') + '">' + formatCurrency(s.pending) + '</td>' +
          '</tr>';
      });

      html += '<tr class="total-row">' +
        '<td>TOTAL</td>' +
        '<td>' + grandTotal.bookings + '</td>' +
        '<td class="amount">' + formatCurrency(grandTotal.totalAmount) + '</td>' +
        '<td class="amount amount-received">' + formatCurrency(grandTotal.collected) + '</td>' +
        '<td class="amount ' + (grandTotal.pending > 0 ? 'amount-pending' : '') + '">' + formatCurrency(grandTotal.pending) + '</td>' +
        '</tr>';

      html += '</tbody></table>';
      container.innerHTML = html;
    }

    // Day-wise Payment Report
    function renderPaymentReport() {
      var from = document.getElementById('payReportFrom').value;
      var to = document.getElementById('payReportTo').value;

      var days = {};

      bookings.forEach(function(b) {
        if (b.status === 'CANCELLED') return;

        // Advance payment
        var advAmt = parseFloat(b.advanceReceived) || 0;
        var advDate = b.advanceDate || '';
        var advMode = b.paymentMode || 'Other';
        if (advMode === 'UPI' || advMode === 'SBI Neelkanth') advMode = 'Bank Transfer';
        if (advAmt > 0 && advDate) {
          if (from && advDate < from) { /* skip */ }
          else if (to && advDate > to) { /* skip */ }
          else {
            if (!days[advDate]) days[advDate] = { Cash: 0, Card: 0, 'Bank Transfer': 0, Other: 0, total: 0 };
            var modeKey = days[advDate].hasOwnProperty(advMode) ? advMode : 'Other';
            days[advDate][modeKey] += advAmt;
            days[advDate].total += advAmt;
          }
        }

        // Balance payment
        var balAmt = parseFloat(b.balanceReceived) || 0;
        var balDate = b.balanceDate || '';
        var balMode = b.balancePaymentMode || 'Other';
        if (balMode === 'UPI' || balMode === 'SBI Neelkanth') balMode = 'Bank Transfer';
        if (balAmt > 0 && balDate) {
          if (from && balDate < from) { /* skip */ }
          else if (to && balDate > to) { /* skip */ }
          else {
            if (!days[balDate]) days[balDate] = { Cash: 0, Card: 0, 'Bank Transfer': 0, Other: 0, total: 0 };
            var modeKey2 = days[balDate].hasOwnProperty(balMode) ? balMode : 'Other';
            days[balDate][modeKey2] += balAmt;
            days[balDate].total += balAmt;
          }
        }
      });

      var dateKeys = Object.keys(days).sort();
      var container = document.getElementById('paymentReportContent');

      if (dateKeys.length === 0) {
        container.innerHTML = '<p style="color:#6b7280;text-align:center;padding:20px;">No payment data for selected range</p>';
        return;
      }

      var grand = { Cash: 0, Card: 0, 'Bank Transfer': 0, Other: 0, total: 0 };

      var html = '<table class="report-table"><thead><tr>' +
        '<th>Date</th><th>Cash</th><th>Card</th><th>Bank Transfer</th><th>Other</th><th>Day Total</th>' +
        '</tr></thead><tbody>';

      dateKeys.forEach(function(dt) {
        var d = days[dt];
        grand.Cash += d.Cash;
        grand.Card += d.Card;
        grand['Bank Transfer'] += d['Bank Transfer'];
        grand.Other += d.Other;
        grand.total += d.total;

        html += '<tr>' +
          '<td><strong>' + formatDate(dt) + '</strong></td>' +
          '<td class="amount">' + (d.Cash ? formatCurrency(d.Cash) : '-') + '</td>' +
          '<td class="amount">' + (d.Card ? formatCurrency(d.Card) : '-') + '</td>' +
          '<td class="amount">' + (d['Bank Transfer'] ? formatCurrency(d['Bank Transfer']) : '-') + '</td>' +
          '<td class="amount">' + (d.Other ? formatCurrency(d.Other) : '-') + '</td>' +
          '<td class="amount" style="font-weight:700">' + formatCurrency(d.total) + '</td>' +
          '</tr>';
      });

      html += '<tr class="total-row">' +
        '<td>TOTAL</td>' +
        '<td class="amount">' + formatCurrency(grand.Cash) + '</td>' +
        '<td class="amount">' + formatCurrency(grand.Card) + '</td>' +
        '<td class="amount">' + formatCurrency(grand['Bank Transfer']) + '</td>' +
        '<td class="amount">' + formatCurrency(grand.Other) + '</td>' +
        '<td class="amount" style="font-weight:700">' + formatCurrency(grand.total) + '</td>' +
        '</tr>';

      html += '</tbody></table>';
      container.innerHTML = html;
    }

    // ========== PROFIT & LOSS REPORT ==========
    function updatePnlFilterInputs() {
      var type = document.getElementById('pnlFilterType').value;
      document.getElementById('pnlCalYearGroup').style.display = type === 'calendar' ? '' : 'none';
      document.getElementById('pnlFYGroup').style.display = type === 'financial' ? '' : 'none';
      document.getElementById('pnlCustomFromGroup').style.display = type === 'custom' ? '' : 'none';
      document.getElementById('pnlCustomToGroup').style.display = type === 'custom' ? '' : 'none';
    }

    function getPnlDateRange() {
      var type = document.getElementById('pnlFilterType').value;
      var from, to;
      if (type === 'calendar') {
        var yr = document.getElementById('pnlCalYear').value;
        from = yr + '-01-01';
        to = yr + '-12-31';
      } else if (type === 'financial') {
        var fyStart = parseInt(document.getElementById('pnlFY').value);
        from = fyStart + '-04-01';
        to = (fyStart + 1) + '-03-31';
      } else {
        from = document.getElementById('pnlCustomFrom').value;
        to = document.getElementById('pnlCustomTo').value;
        if (!from || !to) return null;
      }
      return { from: from, to: to };
    }

    async function renderPnlReport() {
      var range = getPnlDateRange();
      if (!range) {
        alert('Please select a valid date range');
        return;
      }

      var container = document.getElementById('pnlReportContent');
      container.innerHTML = '<p style="text-align:center;padding:20px;color:#6b7280;">Loading...</p>';

      try {
        var rows = await apiFetch('/reports/pnl-table?from=' + encodeURIComponent(range.from) + '&to=' + encodeURIComponent(range.to));

        var monthNames = ['','Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
        var expCols = ['Grocery','Electricity','Cylinder','Salary','Maintenance','Fuel','Laundry','Recharges','Garbage','Deco Items','Staff Meal','Bakery','Housekeeping','Butchery'];

        // Build table
        var html = '<table class="report-table" style="font-size:12px;white-space:nowrap;">';

        // Header row 1 - group headers
        html += '<thead><tr style="background:#1e293b;color:#fff;">' +
          '<th rowspan="2" style="position:sticky;left:0;background:#1e293b;z-index:2;padding:8px 6px;">Sr</th>' +
          '<th rowspan="2" style="position:sticky;left:32px;background:#1e293b;z-index:2;padding:8px 6px;">Month</th>' +
          '<th colspan="4" style="text-align:center;border-bottom:2px solid #60a5fa;padding:8px 6px;color:#93c5fd;">OCCUPANCY</th>' +
          '<th colspan="4" style="text-align:center;border-bottom:2px solid #34d399;padding:8px 6px;color:#6ee7b7;">INCOME</th>' +
          '<th colspan="' + expCols.length + '" style="text-align:center;border-bottom:2px solid #f87171;padding:8px 6px;color:#fca5a5;">EXPENSES</th>' +
          '<th rowspan="2" style="text-align:right;padding:8px 6px;color:#fca5a5;">Total Exp</th>' +
          '<th rowspan="2" style="text-align:right;padding:8px 6px;color:#fdba74;">Lease</th>' +
          '<th rowspan="2" style="text-align:right;padding:8px 6px;color:#f87171;">Grand Exp</th>' +
          '<th rowspan="2" style="text-align:right;padding:8px 6px;color:#fbbf24;">P&L</th>' +
          '<th rowspan="2" style="text-align:right;padding:8px 6px;color:#7dd3fc;">ARR</th>' +
          '<th rowspan="2" style="text-align:right;padding:8px 6px;color:#c4b5fd;">Meal/Person</th>' +
          '</tr>';

        // Header row 2 - sub headers
        html += '<tr style="background:#334155;color:#e2e8f0;font-size:11px;">' +
          '<th style="text-align:right;padding:6px 4px;">Rooms</th>' +
          '<th style="text-align:right;padding:6px 4px;">Occ</th>' +
          '<th style="text-align:right;padding:6px 4px;">Vacant</th>' +
          '<th style="text-align:right;padding:6px 4px;">Occ%</th>' +
          '<th style="text-align:right;padding:6px 4px;">Room Sale</th>' +
          '<th style="text-align:right;padding:6px 4px;">KOT</th>' +
          '<th style="text-align:right;padding:6px 4px;">Other</th>' +
          '<th style="text-align:right;padding:6px 4px;font-weight:700;">Total Inc</th>';
        for (var ei = 0; ei < expCols.length; ei++) {
          html += '<th style="text-align:right;padding:6px 4px;">' + expCols[ei] + '</th>';
        }
        html += '</tr></thead>';

        // Body
        html += '<tbody>';
        var totals = {
          totalRooms:0, occupancy:0, vacant:0,
          roomSale:0, kotIncome:0, otherIncome:0, totalIncome:0,
          totalExpenses:0, lease:0, grandTotalExpense:0, profitLoss:0,
          totalPaxNights:0
        };
        var expTotals = {};
        for (var ti = 0; ti < expCols.length; ti++) expTotals[expCols[ti]] = 0;

        for (var i = 0; i < rows.length; i++) {
          var r = rows[i];
          var mp = r.month.split('-');
          var mLabel = monthNames[parseInt(mp[1])] + ' ' + mp[0];

          totals.totalRooms += r.totalRooms;
          totals.occupancy += r.occupancy;
          totals.vacant += r.vacant;
          totals.roomSale += r.roomSale;
          totals.kotIncome += r.kotIncome;
          totals.otherIncome += r.otherIncome;
          totals.totalIncome += r.totalIncome;
          totals.totalExpenses += r.totalExpenses;
          totals.lease += r.lease;
          totals.grandTotalExpense += r.grandTotalExpense;
          totals.profitLoss += r.profitLoss;
          totals.totalPaxNights += r.totalPaxNights;

          var plColor = r.profitLoss >= 0 ? '#0d7a54' : '#c53030';

          html += '<tr>' +
            '<td style="position:sticky;left:0;background:#fff;z-index:1;font-weight:600;">' + (i+1) + '</td>' +
            '<td style="position:sticky;left:32px;background:#fff;z-index:1;font-weight:600;">' + mLabel + '</td>' +
            '<td class="amount" style="text-align:right">' + r.totalRooms + '</td>' +
            '<td class="amount" style="text-align:right">' + r.occupancy + '</td>' +
            '<td class="amount" style="text-align:right">' + r.vacant + '</td>' +
            '<td class="amount" style="text-align:right;font-weight:600;color:' + (r.occupancyPct >= 70 ? '#0d7a54' : r.occupancyPct >= 40 ? '#b45309' : '#c53030') + ';">' + r.occupancyPct + '%</td>' +
            '<td class="amount" style="text-align:right">' + formatCurrency(r.roomSale) + '</td>' +
            '<td class="amount" style="text-align:right">' + formatCurrency(r.kotIncome) + '</td>' +
            '<td class="amount" style="text-align:right">' + formatCurrency(r.otherIncome) + '</td>' +
            '<td class="amount" style="text-align:right;font-weight:700;color:#0d7a54;">' + formatCurrency(r.totalIncome) + '</td>';

          for (var ej = 0; ej < expCols.length; ej++) {
            var expVal = (r.expenses && r.expenses[expCols[ej]]) || 0;
            expTotals[expCols[ej]] += expVal;
            html += '<td class="amount" style="text-align:right">' + (expVal ? formatCurrency(expVal) : '-') + '</td>';
          }

          html += '<td class="amount" style="text-align:right;font-weight:600;color:#c53030;">' + formatCurrency(r.totalExpenses) + '</td>' +
            '<td class="amount" style="text-align:right;color:#b45309;">' + formatCurrency(r.lease) + '</td>' +
            '<td class="amount" style="text-align:right;font-weight:600;color:#c53030;">' + formatCurrency(r.grandTotalExpense) + '</td>' +
            '<td class="amount" style="text-align:right;font-weight:700;color:' + plColor + ';">' + formatCurrency(r.profitLoss) + '</td>' +
            '<td class="amount" style="text-align:right;color:#4338ca;">' + formatCurrency(r.arr) + '</td>' +
            '<td class="amount" style="text-align:right">' + (r.perPersonMealCost ? formatCurrency(r.perPersonMealCost) : '-') + '</td>' +
            '</tr>';
        }

        // TOTALS row
        var tPlColor = totals.profitLoss >= 0 ? '#0d7a54' : '#c53030';
        var tOccPct = totals.totalRooms > 0 ? Math.round((totals.occupancy / totals.totalRooms) * 100) : 0;
        var tArr = totals.occupancy > 0 ? Math.round(totals.roomSale / totals.occupancy) : 0;
        var tMeal = totals.totalPaxNights > 0 ? Math.round((expTotals['Grocery'] || 0) / totals.totalPaxNights) : 0;

        html += '<tr class="total-row" style="background:#f1f5f9;font-weight:700;border-top:2px solid #334155;">' +
          '<td style="position:sticky;left:0;background:#f1f5f9;z-index:1;"></td>' +
          '<td style="position:sticky;left:32px;background:#f1f5f9;z-index:1;font-size:13px;">TOTAL</td>' +
          '<td class="amount" style="text-align:right">' + totals.totalRooms + '</td>' +
          '<td class="amount" style="text-align:right">' + totals.occupancy + '</td>' +
          '<td class="amount" style="text-align:right">' + totals.vacant + '</td>' +
          '<td class="amount" style="text-align:right">' + tOccPct + '%</td>' +
          '<td class="amount" style="text-align:right">' + formatCurrency(totals.roomSale) + '</td>' +
          '<td class="amount" style="text-align:right">' + formatCurrency(totals.kotIncome) + '</td>' +
          '<td class="amount" style="text-align:right">' + formatCurrency(totals.otherIncome) + '</td>' +
          '<td class="amount" style="text-align:right;color:#0d7a54;">' + formatCurrency(totals.totalIncome) + '</td>';

        for (var ek = 0; ek < expCols.length; ek++) {
          html += '<td class="amount" style="text-align:right">' + formatCurrency(expTotals[expCols[ek]]) + '</td>';
        }

        html += '<td class="amount" style="text-align:right;color:#c53030;">' + formatCurrency(totals.totalExpenses) + '</td>' +
          '<td class="amount" style="text-align:right;color:#b45309;">' + formatCurrency(totals.lease) + '</td>' +
          '<td class="amount" style="text-align:right;color:#c53030;">' + formatCurrency(totals.grandTotalExpense) + '</td>' +
          '<td class="amount" style="text-align:right;color:' + tPlColor + ';">' + formatCurrency(totals.profitLoss) + '</td>' +
          '<td class="amount" style="text-align:right;color:#4338ca;">' + formatCurrency(tArr) + '</td>' +
          '<td class="amount" style="text-align:right">' + (tMeal ? formatCurrency(tMeal) : '-') + '</td>' +
          '</tr>';

        html += '</tbody></table>';
        container.innerHTML = html;
      } catch (err) {
        container.innerHTML = '<p style="color:#ef4444;text-align:center;padding:20px;">Error loading P&L report: ' + (err.message || err) + '</p>';
      }
    }

    // ========== LEDGER REPORT ==========
    var ledgerFilteredBookings = []; // cached for export

    function renderLedgerReport() {
      var agent = document.getElementById('ledgerAgent').value;
      var from = document.getElementById('ledgerFrom').value;
      var to = document.getElementById('ledgerTo').value;

      var filtered = bookings.filter(function(b) {
        if (b.status === 'CANCELLED') return false;
        if (b.source !== 'Agent' && b.source !== 'OTA') return false;
        if (agent && b.sourceName !== agent) return false;
        if (from && b.checkIn < from) return false;
        if (to && b.checkOut > to) return false;
        return true;
      });

      ledgerFilteredBookings = filtered;

      // Summary by agent
      var agentSums = {};
      var grandTotal = { total: 0, received: 0, pending: 0, count: 0 };

      filtered.forEach(function(b) {
        var name = b.sourceName || 'Unknown';
        if (!agentSums[name]) agentSums[name] = { total: 0, received: 0, pending: 0, count: 0 };
        var total = parseFloat(b.totalAmount) || 0;
        var recv = (parseFloat(b.advanceReceived) || 0) + (parseFloat(b.balanceReceived) || 0);
        var pend = total - recv;
        agentSums[name].total += total;
        agentSums[name].received += recv;
        if (pend > 0) agentSums[name].pending += pend;
        agentSums[name].count++;
        grandTotal.total += total;
        grandTotal.received += recv;
        if (pend > 0) grandTotal.pending += pend;
        grandTotal.count++;
      });

      // Summary cards
      var cardsHtml = '';
      if (agent) {
        cardsHtml += '<div class="monthly-card"><div class="mc-label">' + escapeHtml(agent) + ' - Bookings</div><div class="mc-value blue">' + grandTotal.count + '</div></div>';
        cardsHtml += '<div class="monthly-card"><div class="mc-label">Total Amount</div><div class="mc-value blue">' + formatCurrency(grandTotal.total) + '</div></div>';
        cardsHtml += '<div class="monthly-card"><div class="mc-label">Received</div><div class="mc-value green">' + formatCurrency(grandTotal.received) + '</div></div>';
        cardsHtml += '<div class="monthly-card"><div class="mc-label">Pending Due</div><div class="mc-value red">' + formatCurrency(grandTotal.pending) + '</div></div>';
      } else {
        // All agents summary
        var agentNames = Object.keys(agentSums).sort();
        agentNames.forEach(function(name) {
          var s = agentSums[name];
          cardsHtml += '<div class="monthly-card">' +
            '<div class="mc-label">' + escapeHtml(name) + ' (' + s.count + ')</div>' +
            '<div class="mc-value ' + (s.pending > 0 ? 'red' : 'green') + '">' + formatCurrency(s.pending) + '</div>' +
            '<div style="font-size:11px;color:#6b7280;margin-top:4px;">Total: ' + formatCurrency(s.total) + ' | Rcvd: ' + formatCurrency(s.received) + '</div>' +
            '</div>';
        });
      }
      document.getElementById('ledgerSummaryCards').innerHTML = cardsHtml;

      // Detail table
      var container = document.getElementById('ledgerReportContent');
      if (filtered.length === 0) {
        container.innerHTML = '<p style="color:#6b7280;text-align:center;padding:20px;">No bookings found for selected filters</p>';
        return;
      }

      var html = '<table class="report-table"><thead><tr>' +
        '<th>ID</th><th>Guest</th><th>Agent</th><th>Room</th><th>Check-in</th><th>Checkout</th>' +
        '<th>Total</th><th>Received</th><th>Pending</th><th>Status</th>' +
        '</tr></thead><tbody>';

      filtered.forEach(function(b) {
        var total = parseFloat(b.totalAmount) || 0;
        var recv = (parseFloat(b.advanceReceived) || 0) + (parseFloat(b.balanceReceived) || 0);
        var pend = total - recv;

        var statusClass = b.status === 'COLLECTED' ? 'badge-collected' :
                          b.status === 'PARTIAL' ? 'badge-partial' : 'badge-pending';

        html += '<tr>' +
          '<td><strong>' + escapeHtml(b.id) + '</strong></td>' +
          '<td>' + escapeHtml(b.guestName) + '</td>' +
          '<td>' + escapeHtml(b.sourceName || '-') + '</td>' +
          '<td>' + escapeHtml(b.roomNo || '-') + '</td>' +
          '<td>' + formatDate(b.checkIn) + '</td>' +
          '<td>' + formatDate(b.checkOut) + '</td>' +
          '<td class="amount">' + formatCurrency(total) + '</td>' +
          '<td class="amount amount-received">' + formatCurrency(recv) + '</td>' +
          '<td class="amount ' + (pend > 0 ? 'amount-pending' : '') + '">' + formatCurrency(pend) + '</td>' +
          '<td><span class="badge ' + statusClass + '">' + escapeHtml(b.status) + '</span></td>' +
          '</tr>';
      });

      html += '<tr class="total-row">' +
        '<td colspan="6">TOTAL (' + grandTotal.count + ' bookings)</td>' +
        '<td class="amount">' + formatCurrency(grandTotal.total) + '</td>' +
        '<td class="amount amount-received">' + formatCurrency(grandTotal.received) + '</td>' +
        '<td class="amount ' + (grandTotal.pending > 0 ? 'amount-pending' : '') + '">' + formatCurrency(grandTotal.pending) + '</td>' +
        '<td></td></tr>';

      html += '</tbody></table>';
      container.innerHTML = html;
    }

    function exportLedgerCSV() {
      if (ledgerFilteredBookings.length === 0) {
        showToast('No data to export', 'error');
        return;
      }
      var agent = document.getElementById('ledgerAgent').value || 'All-Agents';

      var headers = ['Booking ID','Guest','Agent','Room','Check-in','Checkout','Total','Received','Pending','Status'];
      var rows = ledgerFilteredBookings.map(function(b) {
        var recv = (parseFloat(b.advanceReceived) || 0) + (parseFloat(b.balanceReceived) || 0);
        var pend = (parseFloat(b.totalAmount) || 0) - recv;
        return [b.id, b.guestName, b.sourceName||'', b.roomNo||'', b.checkIn, b.checkOut, b.totalAmount, recv, pend > 0 ? pend : 0, b.status];
      });

      var csv = [headers].concat(rows).map(function(r) {
        return r.map(function(c) { return '"' + String(c).replace(/"/g,'""') + '"'; }).join(',');
      }).join('\n');

      var blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      var url = URL.createObjectURL(blob);
      var link = document.createElement('a');
      link.href = url;
      link.download = 'ledger-' + agent.replace(/\s+/g,'-') + '-' + getToday() + '.csv';
      link.click();
      URL.revokeObjectURL(url);
      showToast('Ledger exported', 'success');
    }

    // Monthly Report - date-wise breakdown
    function renderMonthlyReport() {
      var selectedMonth = document.getElementById('reportMonth').value;
      if (!selectedMonth) return;

      // Group by date within the month
      var dates = {};
      // dates[date] = { bookings, totalAmount, collected, pending, guests }

      bookings.forEach(function(b) {
        if (!b.checkOut || b.checkOut.substring(0, 7) !== selectedMonth) return;

        var dt = b.checkOut;
        if (!dates[dt]) {
          dates[dt] = { bookings: 0, totalAmount: 0, collected: 0, pending: 0, guests: [] };
        }

        var total = parseFloat(b.totalAmount) || 0;
        var totalReceived = (parseFloat(b.advanceReceived) || 0) + (parseFloat(b.balanceReceived) || 0);
        var pending = total - totalReceived;

        dates[dt].bookings++;
        dates[dt].totalAmount += total;
        dates[dt].collected += totalReceived;
        if (pending > 0) dates[dt].pending += pending;
        dates[dt].guests.push(b.guestName);
      });

      var dateKeys = Object.keys(dates).sort();
      var container = document.getElementById('monthlyReportContent');

      if (dateKeys.length === 0) {
        container.innerHTML = '<p style="color:#6b7280;text-align:center;padding:20px;">No data for selected month</p>';
        return;
      }

      var grandTotal = { bookings: 0, totalAmount: 0, collected: 0, pending: 0 };

      var html = '<table class="report-table"><thead><tr>' +
        '<th>Date</th><th>Bookings</th><th>Guests</th><th>Collection</th><th>Collected</th><th>Pending</th>' +
        '</tr></thead><tbody>';

      dateKeys.forEach(function(dt) {
        var d = dates[dt];
        grandTotal.bookings += d.bookings;
        grandTotal.totalAmount += d.totalAmount;
        grandTotal.collected += d.collected;
        grandTotal.pending += d.pending;

        html += '<tr>' +
          '<td><strong>' + formatDate(dt) + '</strong></td>' +
          '<td>' + d.bookings + '</td>' +
          '<td><small>' + d.guests.map(function(g) { return escapeHtml(g); }).join(', ') + '</small></td>' +
          '<td class="amount">' + formatCurrency(d.totalAmount) + '</td>' +
          '<td class="amount amount-received">' + formatCurrency(d.collected) + '</td>' +
          '<td class="amount ' + (d.pending > 0 ? 'amount-pending' : '') + '">' + formatCurrency(d.pending) + '</td>' +
          '</tr>';
      });

      html += '<tr class="total-row">' +
        '<td>TOTAL</td>' +
        '<td>' + grandTotal.bookings + '</td>' +
        '<td></td>' +
        '<td class="amount">' + formatCurrency(grandTotal.totalAmount) + '</td>' +
        '<td class="amount amount-received">' + formatCurrency(grandTotal.collected) + '</td>' +
        '<td class="amount ' + (grandTotal.pending > 0 ? 'amount-pending' : '') + '">' + formatCurrency(grandTotal.pending) + '</td>' +
        '</tr>';

      html += '</tbody></table>';
      container.innerHTML = html;
    }

    // ========== BILL / INVOICE GENERATION ==========
    var INVOICE_KEY = 'aksInvoiceCounter';

    function getNextInvoiceNo() {
      var counter = parseInt(localStorage.getItem(INVOICE_KEY)) || 0;
      counter++;
      localStorage.setItem(INVOICE_KEY, counter);
      return 'AKS' + String(counter).padStart(4, '0');
    }

    function formatFullDate(dateStr) {
      if (!dateStr) return '-';
      var d = new Date(dateStr + 'T00:00:00');
      return d.toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' });
    }

    function calculateNights(checkIn, checkOut) {
      if (!checkIn || !checkOut) return 1;
      var d1 = new Date(checkIn);
      var d2 = new Date(checkOut);
      var diff = Math.round((d2 - d1) / (1000 * 60 * 60 * 24));
      return diff > 0 ? diff : 1;
    }

    function updateNightsDisplay() {
      var checkIn = document.getElementById('checkIn').value;
      var checkOut = document.getElementById('checkOut').value;
      var el = document.getElementById('nightsDisplay');
      if (checkIn && checkOut) {
        var nights = calculateNights(checkIn, checkOut);
        el.textContent = nights + (nights === 1 ? ' Night' : ' Nights');
      } else {
        el.textContent = '-';
      }
    }

    function generateBill(id) {
      var b = bookings.find(function(bk) { return bk.id === id; });
      if (!b) return;

      var invoiceNo = getNextInvoiceNo();
      var nights = calculateNights(b.checkIn, b.checkOut);
      var rooms = parseInt(b.noOfRooms) || 1;
      var totalAmount = parseFloat(b.totalAmount) || 0;

      // GST 5%
      var baseAmount = Math.round(totalAmount / 1.05 * 100) / 100;
      var cgst = Math.round((totalAmount - baseAmount) / 2 * 100) / 100;
      var sgst = cgst;
      var gstTotal = cgst + sgst;

      var totalReceived = (parseFloat(b.advanceReceived) || 0) + (parseFloat(b.balanceReceived) || 0);
      var balanceDue = totalAmount - totalReceived;

      var billHtml = '<!DOCTYPE html><html><head><meta charset="UTF-8">' +
        '<title>Invoice ' + invoiceNo + '</title>' +
        '<style>' +
        '* { margin:0; padding:0; box-sizing:border-box; }' +
        'body { font-family: Arial, sans-serif; color: #1c2038; padding: 0; }' +
        '.invoice { max-width: 800px; margin: 0 auto; padding: 40px; }' +
        '.inv-header { display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 3px solid #1e3a5f; padding-bottom: 20px; margin-bottom: 24px; }' +
        '.inv-company h1 { font-size: 24px; color: #1e3a5f; margin-bottom: 4px; }' +
        '.inv-company p { font-size: 12px; color: #4b5563; line-height: 1.6; }' +
        '.inv-meta { text-align: right; }' +
        '.inv-meta h2 { font-size: 28px; color: #1e3a5f; margin-bottom: 8px; }' +
        '.inv-meta p { font-size: 13px; color: #4b5563; line-height: 1.6; }' +
        '.inv-meta strong { color: #1f2937; }' +
        '.inv-section { margin-bottom: 24px; }' +
        '.inv-section h3 { font-size: 14px; color: #1e3a5f; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; border-bottom: 1px solid #e5e7eb; padding-bottom: 6px; }' +
        '.inv-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px 24px; }' +
        '.inv-grid .label { font-size: 12px; color: #6b7280; }' +
        '.inv-grid .val { font-size: 14px; font-weight: 600; color: #1f2937; }' +
        'table { width: 100%; border-collapse: collapse; margin-top: 12px; }' +
        'th { background: #1e3a5f; color: white; padding: 10px 14px; text-align: left; font-size: 12px; text-transform: uppercase; }' +
        'td { padding: 10px 14px; border-bottom: 1px solid #e5e7eb; font-size: 13px; }' +
        'tr:nth-child(even) { background: #f9fafb; }' +
        '.text-right { text-align: right; }' +
        '.totals { margin-top: 20px; display: flex; justify-content: flex-end; }' +
        '.totals table { width: 320px; }' +
        '.totals td { font-size: 13px; padding: 8px 14px; }' +
        '.totals .grand { background: #1e3a5f; color: white; font-weight: 700; font-size: 15px; }' +
        '.inv-footer { margin-top: 40px; border-top: 1px solid #e5e7eb; padding-top: 20px; display: flex; justify-content: space-between; }' +
        '.inv-footer .col { width: 45%; }' +
        '.inv-footer h4 { font-size: 12px; color: #6b7280; text-transform: uppercase; margin-bottom: 8px; }' +
        '.inv-footer p { font-size: 12px; color: #4b5563; line-height: 1.5; }' +
        '.sign-line { margin-top: 60px; border-top: 1px solid #1c2038; width: 200px; padding-top: 6px; font-size: 12px; color: #6b7280; }' +
        '@media print { body { padding: 0; } .invoice { padding: 20px; } .no-print { display: none !important; } }' +
        '</style></head><body>' +
        '<div class="invoice">' +

        // Print button
        '<div class="no-print" style="text-align:right;margin-bottom:20px;">' +
        '<button onclick="window.print()" style="padding:10px 24px;background:#1e3a5f;color:white;border:none;border-radius:8px;font-size:14px;cursor:pointer;font-weight:600;">Print Invoice</button>' +
        '</div>' +

        // Header
        '<div class="inv-header">' +
        '<div class="inv-company">' +
        '<h1>The Neelkanth Grand</h1>' +
        '<p><strong>AKS Hospitality</strong><br>' +
        'Neelkanth Grand, Naggar Road, Manali,<br>Himachal Pradesh<br>' +
        'Contact: 8922032843 | 9838888878<br>' +
        'Sales Office: 912A, 9th Floor, Bhutani Alphatum,<br>Sector 90, Noida<br>' +
        'GSTIN: 02ACAFA1060C1ZI</p>' +
        '</div>' +
        '<div class="inv-meta">' +
        '<h2>INVOICE</h2>' +
        '<p>Invoice No: <strong>' + invoiceNo + '</strong><br>' +
        'Date: <strong>' + formatFullDate(getToday()) + '</strong><br>' +
        'Booking ID: <strong>' + escapeHtml(b.id) + '</strong></p>' +
        '</div>' +
        '</div>' +

        // Guest Details
        '<div class="inv-section">' +
        '<h3>Guest Details</h3>' +
        '<div class="inv-grid">' +
        '<div><div class="label">Guest Name</div><div class="val">' + escapeHtml(b.guestName) + '</div></div>' +
        '<div><div class="label">Phone</div><div class="val">' + escapeHtml(b.phone || '-') + '</div></div>' +
        '<div><div class="label">Pax</div><div class="val">' + (b.pax || 1) + '</div></div>' +
        '<div><div class="label">Room(s)</div><div class="val">' + escapeHtml(b.roomNo) + (b.roomCategory ? ' (' + escapeHtml(b.roomCategory) + ')' : '') + '</div></div>' +
        '<div><div class="label">Check-in</div><div class="val">' + formatFullDate(b.checkIn) + '</div></div>' +
        '<div><div class="label">Check-out</div><div class="val">' + formatFullDate(b.checkOut) + '</div></div>' +
        '<div><div class="label">Nights</div><div class="val">' + nights + '</div></div>' +
        '<div><div class="label">Plan</div><div class="val">' + escapeHtml(b.mealPlan || '-') + '</div></div>' +
        '</div>' +
        '</div>' +

        // Charges Table
        '<div class="inv-section">' +
        '<h3>Charges</h3>' +
        '<table><thead><tr>' +
        '<th>Description</th><th class="text-right">Nights</th><th class="text-right">Rooms</th><th class="text-right">Amount</th>' +
        '</tr></thead><tbody>' +
        '<tr><td>Room Charges' + (b.roomCategory ? ' (' + escapeHtml(b.roomCategory) + ')' : '') + '</td>' +
        '<td class="text-right">' + nights + '</td>' +
        '<td class="text-right">' + rooms + '</td>' +
        '<td class="text-right">' + formatCurrency(baseAmount) + '</td></tr>' +
        (b.complimentary ? '<tr><td>Add-On: ' + escapeHtml(b.complimentary) + '</td><td></td><td></td><td class="text-right">-</td></tr>' : '') +
        (b.kotAmount ? '<tr><td>KOT Charges</td><td></td><td></td><td class="text-right">' + formatCurrency(b.kotAmount) + '</td></tr>' : '') +
        (b.addOns && b.addOns.length > 0 ? b.addOns.map(function(ao) { return '<tr><td>Add-On: ' + escapeHtml(ao.type) + '</td><td></td><td></td><td class="text-right">' + formatCurrency(ao.amount) + '</td></tr>'; }).join('') : '') +
        '</tbody></table>' +
        '</div>' +

        // Totals
        '<div class="totals"><table>' +
        '<tr><td>Subtotal</td><td class="text-right">' + formatCurrency(baseAmount) + '</td></tr>' +
        '<tr><td>CGST @ 2.5%</td><td class="text-right">' + formatCurrency(cgst) + '</td></tr>' +
        '<tr><td>SGST @ 2.5%</td><td class="text-right">' + formatCurrency(sgst) + '</td></tr>' +
        '<tr class="grand"><td>Grand Total (incl. GST 5%)</td><td class="text-right">' + formatCurrency(totalAmount) + '</td></tr>' +
        '<tr><td>Amount Received</td><td class="text-right" style="color:#10b981;font-weight:600">' + formatCurrency(totalReceived) + '</td></tr>' +
        (balanceDue > 0 ? '<tr><td><strong>Balance Due</strong></td><td class="text-right" style="color:#ef4444;font-weight:700">' + formatCurrency(balanceDue) + '</td></tr>' : '') +
        '</table></div>' +

        // Footer
        '<div class="inv-footer">' +
        '<div class="col">' +
        '<h4>Payment Info</h4>' +
        '<p>Payment Type: ' + escapeHtml(b.paymentType) + '<br>' +
        'Mode: ' + escapeHtml(b.paymentMode || '-') + '<br>' +
        'Source: ' + escapeHtml(b.source) + (b.sourceName ? ' (' + escapeHtml(b.sourceName) + ')' : '') + '</p>' +
        '</div>' +
        '<div class="col" style="text-align:right">' +
        '<div class="sign-line">Authorized Signatory<br><strong>AKS Hospitality</strong></div>' +
        '</div>' +
        '</div>' +

        '<p style="text-align:center;margin-top:30px;font-size:11px;color:#9ca3af;">Thank you for staying with us! | The Neelkanth Grand | AKS Hospitality</p>' +

        '</div></body></html>';

      // Open in new window for printing
      var billWindow = window.open('', '_blank', 'width=900,height=700');
      billWindow.document.write(billHtml);
      billWindow.document.close();
    }

    // ========== DAY BOOK + SALARY DATA LAYER ==========
    var DAYBOOK_KEY = 'hotelDayBook';
    var DAYBOOK_BAL_KEY = 'hotelDayBookBalances';
    var STAFF_KEY = 'hotelStaff';
    var ATTENDANCE_KEY = 'hotelAttendance';
    var ADVANCES_KEY = 'hotelSalaryAdvances';

    // Load/save functions are now defined in the API layer above (in-memory cache).
    // These storage keys are kept for reference but localStorage is no longer used for these.

    function generateDayBookId() {
      return 'DB-' + Date.now() + '-' + Math.floor(Math.random() * 1000);
    }
    function generateStaffId() {
      var staff = loadStaffData();
      var maxNum = 0;
      staff.forEach(function(s) {
        var parts = s.id.split('-');
        var num = parseInt(parts[1]) || 0;
        if (num > maxNum) maxNum = num;
      });
      return 'EMP-' + String(maxNum + 1).padStart(3, '0');
    }
    function generateAdvanceId() {
      return 'ADV-' + Date.now();
    }

    var EXPENSE_CATEGORIES = {
      'Grocery': [],
      'Electricity': [],
      'Salary': [],
      'Recharges': [],
      'Deco Items': [],
      'Bakery': [],
      'Housekeeping': ['Napkins/Toilet Rolls','Soap','Shampoo','Lotion','Chemicals','Broom','Mop','Vipers','Slippers','Dental Kits','Room Freshner','Tea','Coffee','Milk','Dusting Pan','Brush','WC Band/Glass Cover','Garbage Bags'],
      'Butchery': [],
      'Fuel': [],
      'Cylinder': [],
      'Laundry': [],
      'Garbage': [],
      'Maintenance': [],
      'Others': []
    };

    // ========== GENERIC MODAL HELPER ==========
    function closeModal(id) {
      document.getElementById(id).classList.remove('active');
    }

    // ========== DAY BOOK FUNCTIONS ==========
    async function renderDayBook() {
      var date = getDayBookDate();
      try {
        var results = await Promise.all([
          loadDayBookEntriesForDate(date),
          loadDayBookClosingForDate(date)
        ]);
        var entries = results[0];
        var closing = results[1];

        renderDayBookBalancesWithData(closing);
        renderDayBookIncomeWithData(entries.filter(function(e) { return e.type === 'income'; }));
        renderDayBookExpensesWithData(entries.filter(function(e) { return e.type === 'expense'; }));
        renderDayBookClosingWithData(closing);
      } catch(e) {
        // toast shown by apiFetch
      }
    }

    function getDayBookDate() {
      return document.getElementById('daybookDate').value || getToday();
    }

    function renderDayBookBalancesWithData(closing) {
      document.getElementById('dbCashOpening').textContent = formatCurrency(closing.cashOpening || 0);
      document.getElementById('dbBankOpening').textContent = formatCurrency(closing.bankOpening || 0);
      document.getElementById('dbCashClosing').textContent = formatCurrency(closing.cashClosing || 0);
      document.getElementById('dbBankClosing').textContent = formatCurrency(closing.bankClosing || 0);
    }

    function renderDayBookIncomeWithData(entries) {
      var tbody = document.getElementById('dayBookIncomeTable');
      var total = 0;

      if (entries.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#9ca3af;padding:20px;">No income entries</td></tr>';
      } else {
        tbody.innerHTML = entries.map(function(e) {
          total += parseFloat(e.amount) || 0;
          return '<tr>' +
            '<td><strong>' + escapeHtml(e.incomeSource || e.category || '-') + '</strong>' +
              (e.guestName ? '<br><small style="color:#6b7280">' + escapeHtml(e.guestName) + '</small>' : '') +
              (e.bookingId ? '<br><small style="color:#6b7280">' + escapeHtml(e.bookingId) + '</small>' : '') +
            '</td>' +
            '<td>' + escapeHtml(e.description || '-') + '</td>' +
            '<td class="amount amount-received">' + formatCurrency(e.amount) + '</td>' +
            '<td><span class="payment-type">' + escapeHtml(e.paymentMode || '-') + '</span></td>' +
            '<td>' + escapeHtml(e.receivedIn || e.paymentSource || '-') + '</td>' +
            '<td><button class="btn btn-danger btn-small" onclick="deleteDayBookEntry(\'' + e.id + '\')">Delete</button></td>' +
            '</tr>';
        }).join('');
      }
      document.getElementById('dbTotalIncome').textContent = formatCurrency(total);
    }

    function renderDayBookExpensesWithData(entries) {
      var tbody = document.getElementById('dayBookExpenseTable');
      var total = 0;

      if (entries.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#9ca3af;padding:20px;">No expense entries</td></tr>';
      } else {
        tbody.innerHTML = entries.map(function(e) {
          total += parseFloat(e.amount) || 0;
          return '<tr>' +
            '<td><strong>' + escapeHtml(e.category || '-') + '</strong>' +
              (e.employeeName ? '<br><small style="color:#6b7280">' + escapeHtml(e.employeeName) + '</small>' : '') +
            '</td>' +
            '<td>' + escapeHtml(e.subItem || '-') + '</td>' +
            '<td>' + escapeHtml(e.description || '-') + '</td>' +
            '<td class="amount amount-pending">' + formatCurrency(e.amount) + '</td>' +
            '<td>' + escapeHtml(e.paymentSource || '-') + '</td>' +
            '<td><button class="btn btn-danger btn-small" onclick="deleteDayBookEntry(\'' + e.id + '\')">Delete</button></td>' +
            '</tr>';
        }).join('');
      }
      document.getElementById('dbTotalExpense').textContent = formatCurrency(total);
    }

    function renderDayBookClosingWithData(c) {
      var tbody = document.getElementById('dayBookClosingBody');

      tbody.innerHTML =
        '<tr><td><strong>Opening Balance</strong></td>' +
          '<td class="amount">' + formatCurrency(c.cashOpening) + '</td>' +
          '<td class="amount">' + formatCurrency(c.bankOpening) + '</td>' +
          '<td class="amount" style="font-weight:700">' + formatCurrency((c.cashOpening || 0) + (c.bankOpening || 0)) + '</td></tr>' +
        '<tr style="color:#10b981"><td><strong>+ Income</strong></td>' +
          '<td class="amount">' + formatCurrency(c.cashIncome) + '</td>' +
          '<td class="amount">' + formatCurrency(c.bankIncome) + '</td>' +
          '<td class="amount" style="font-weight:700">' + formatCurrency((c.cashIncome || 0) + (c.bankIncome || 0)) + '</td></tr>' +
        '<tr style="color:#ef4444"><td><strong>- Expenses</strong></td>' +
          '<td class="amount">' + formatCurrency(c.cashExpense) + '</td>' +
          '<td class="amount">' + formatCurrency(c.bankExpense) + '</td>' +
          '<td class="amount" style="font-weight:700">' + formatCurrency((c.cashExpense || 0) + (c.bankExpense || 0)) + '</td></tr>' +
        '<tr style="background:#f0f4f8;font-weight:700"><td><strong>Closing Balance</strong></td>' +
          '<td class="amount" style="color:#1e3a5f">' + formatCurrency(c.cashClosing) + '</td>' +
          '<td class="amount" style="color:#1e3a5f">' + formatCurrency(c.bankClosing) + '</td>' +
          '<td class="amount" style="color:#1e3a5f;font-size:16px">' + formatCurrency((c.cashClosing || 0) + (c.bankClosing || 0)) + '</td></tr>';
    }

    async function autoCollectDayBookIncome() {
      var date = getDayBookDate();
      try {
        var result = await apiFetch('/daybook/auto-collect?date=' + encodeURIComponent(date), { method: 'POST' });
        await renderDayBook();
        var added = result && result.added ? result.added : 0;
        showToast(added > 0 ? added + ' income entries collected from bookings' : 'No new entries to collect', added > 0 ? 'success' : 'error');
      } catch(e) { /* toast shown */ }
    }

    async function deleteDayBookEntry(id) {
      if (!confirm('Delete this entry?')) return;
      try {
        await apiFetch('/daybook/entries/' + id, { method: 'DELETE' });
        await renderDayBook();
        showToast('Entry deleted', 'success');
      } catch(e) { /* toast shown */ }
    }

    // Opening Balance Modal
    async function openSetBalanceModal() {
      var date = getDayBookDate();
      var bal = { cashOpening: 0, bankSbiOpening: 0 };
      try {
        bal = await loadDayBookBalanceForDate(date);
        if (!bal) bal = { cashOpening: 0, bankSbiOpening: 0 };
      } catch(e) { /* use defaults */ }
      document.getElementById('balanceModalDate').textContent = formatDate(date);
      document.getElementById('balCashOpening').value = bal.cashOpening || '';
      document.getElementById('balBankOpening').value = bal.bankSbiOpening || '';
      document.getElementById('setBalanceModal').classList.add('active');
    }

    async function saveOpeningBalance() {
      var date = getDayBookDate();
      var cash = parseFloat(document.getElementById('balCashOpening').value) || 0;
      var bank = parseFloat(document.getElementById('balBankOpening').value) || 0;

      try {
        await apiFetch('/daybook/balance', {
          method: 'PUT',
          body: { date: date, cashOpening: cash, bankSbiOpening: bank }
        });
        closeModal('setBalanceModal');
        await renderDayBook();
        showToast('Opening balance saved', 'success');
      } catch(e) { /* toast shown */ }
    }

    // Add Expense Modal
    function openAddExpenseModal(prefillCategory, prefillEmployee, prefillAmount) {
      document.getElementById('expenseModalTitle').textContent = 'Add Expense';
      document.getElementById('expenseCategory').value = prefillCategory || '';
      document.getElementById('expenseSubItem').value = '';
      document.getElementById('expenseAmount').value = prefillAmount || '';
      document.getElementById('expensePayFrom').value = 'Cash';
      document.getElementById('expenseDescription').value = '';
      updateExpenseSubItems();
      if (prefillEmployee) {
        document.getElementById('expenseEmployee').value = prefillEmployee;
      }
      document.getElementById('addExpenseModal').classList.add('active');
    }

    function updateExpenseSubItems() {
      var cat = document.getElementById('expenseCategory').value;
      var subGroup = document.getElementById('expenseSubItemGroup');
      var subSelect = document.getElementById('expenseSubItem');
      var empGroup = document.getElementById('expenseEmployeeGroup');

      // Sub-items
      var items = EXPENSE_CATEGORIES[cat] || [];
      if (items.length > 0) {
        subGroup.style.display = 'flex';
        subSelect.innerHTML = '<option value="">Select Sub-Item</option>';
        items.forEach(function(item) {
          subSelect.innerHTML += '<option value="' + escapeHtml(item) + '">' + escapeHtml(item) + '</option>';
        });
      } else {
        subGroup.style.display = 'none';
        subSelect.value = '';
      }

      // Employee picker for salary
      if (cat === 'Salary') {
        empGroup.style.display = 'flex';
        var empSelect = document.getElementById('expenseEmployee');
        var staff = loadStaffData().filter(function(s) { return s.status !== 'left'; });
        empSelect.innerHTML = '<option value="">Select Employee</option>';
        staff.forEach(function(s) {
          empSelect.innerHTML += '<option value="' + s.id + '">' + escapeHtml(s.name) + ' (' + escapeHtml(s.designation) + ')</option>';
        });
      } else {
        empGroup.style.display = 'none';
      }
    }

    async function saveExpense() {
      var cat = document.getElementById('expenseCategory').value;
      var subItem = document.getElementById('expenseSubItem').value;
      var amount = parseFloat(document.getElementById('expenseAmount').value) || 0;
      var payFrom = document.getElementById('expensePayFrom').value;
      var desc = document.getElementById('expenseDescription').value.trim();

      if (!cat || !amount) {
        showToast('Please fill category and amount', 'error');
        return;
      }

      var empId = '', empName = '';
      var backendEmpId = null;
      if (cat === 'Salary') {
        empId = document.getElementById('expenseEmployee').value;
        if (empId) {
          var staff = loadStaffData();
          var emp = staff.find(function(s) { return s.id === empId; });
          empName = emp ? emp.name : '';
          backendEmpId = getBackendStaffId(empId);
        }
      }

      try {
        await apiFetch('/daybook/entries', {
          method: 'POST',
          body: {
            date: getDayBookDate(),
            type: 'expense',
            category: cat,
            subItem: subItem,
            description: desc,
            amount: amount,
            paymentSource: payFrom,
            employeeId: backendEmpId || undefined,
            employeeName: empName || undefined
          }
        });
        closeModal('addExpenseModal');
        await renderDayBook();
        showToast('Expense added', 'success');
      } catch(e) { /* toast shown */ }
    }

    // Manual Income Modal
    function openManualIncomeModal() {
      document.getElementById('incomeSource').value = 'Room Rent';
      document.getElementById('incomeAmount').value = '';
      document.getElementById('incomePayMode').value = 'Cash';
      document.getElementById('incomeReceivedIn').value = 'Cash';
      document.getElementById('incomeDescription').value = '';
      document.getElementById('addIncomeModal').classList.add('active');
    }

    async function saveManualIncome() {
      var source = document.getElementById('incomeSource').value;
      var amount = parseFloat(document.getElementById('incomeAmount').value) || 0;
      var mode = document.getElementById('incomePayMode').value;
      var receivedIn = document.getElementById('incomeReceivedIn').value;
      var desc = document.getElementById('incomeDescription').value.trim();

      if (!amount) {
        showToast('Please enter amount', 'error');
        return;
      }

      try {
        await apiFetch('/daybook/entries', {
          method: 'POST',
          body: {
            date: getDayBookDate(),
            type: 'income',
            category: source,
            incomeSource: source,
            description: desc,
            amount: amount,
            paymentMode: mode,
            receivedIn: receivedIn,
            paymentSource: receivedIn
          }
        });
        closeModal('addIncomeModal');
        await renderDayBook();
        showToast('Income added', 'success');
      } catch(e) { /* toast shown */ }
    }

    // ========== SALARY TAB FUNCTIONS ==========
    async function initSalaryTab() {
      var now = new Date();
      var cm = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0');
      if (!document.getElementById('attMonth').value) {
        document.getElementById('attMonth').value = cm;
      }
      if (!document.getElementById('salaryCalcMonth').value) {
        document.getElementById('salaryCalcMonth').value = cm;
      }
      renderStaffList();
      populateEmployeeDropdowns();
      await renderAttendance();
      renderAdvanceList();
      await renderSalaryCalculation();
    }

    function populateEmployeeDropdowns() {
      var staff = loadStaffData().filter(function(s) { return s.status !== 'left'; });
      var attSel = document.getElementById('attEmployee');
      var advSel = document.getElementById('advanceEmployee');

      [attSel, advSel].forEach(function(sel) {
        var currentVal = sel.value;
        sel.innerHTML = '<option value="">Select Employee</option>';
        staff.forEach(function(s) {
          sel.innerHTML += '<option value="' + s.id + '">' + escapeHtml(s.name) + ' (' + escapeHtml(s.designation) + ')</option>';
        });
        if (currentVal) sel.value = currentVal;
      });
    }

    // Staff List
    function renderStaffList() {
      var staff = loadStaffData();
      var tbody = document.getElementById('staffListTable');

      if (staff.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#9ca3af;padding:20px;">No staff members. Click "New Joining" to add.</td></tr>';
        return;
      }

      tbody.innerHTML = staff.map(function(s) {
        var statusBadge = s.status === 'left'
          ? '<span class="badge badge-left">Left</span>'
          : '<span class="badge badge-active">Active</span>';
        var actions = s.status !== 'left'
          ? '<button class="btn btn-secondary btn-small" onclick="openEditStaff(\'' + s.id + '\')">Edit</button> ' +
            '<button class="btn btn-danger btn-small" onclick="openFnfModal(\'' + s.id + '\')">FnF</button>'
          : '-';
        return '<tr>' +
          '<td><strong>' + escapeHtml(s.id) + '</strong></td>' +
          '<td>' + escapeHtml(s.name) + '</td>' +
          '<td>' + escapeHtml(s.designation) + '</td>' +
          '<td class="amount">' + formatCurrency(s.salary) + '</td>' +
          '<td>' + formatDate(s.doj) + '</td>' +
          '<td>' + statusBadge + '</td>' +
          '<td>' + actions + '</td>' +
          '</tr>';
      }).join('');
    }

    function openAddStaffModal() {
      document.getElementById('staffModalTitle').textContent = 'New Joining';
      document.getElementById('editStaffId').value = '';
      document.getElementById('staffName').value = '';
      document.getElementById('staffDesignation').value = '';
      document.getElementById('staffSalary').value = '';
      document.getElementById('staffDoj').value = getToday();
      document.getElementById('addStaffModal').classList.add('active');
    }

    function openEditStaff(id) {
      var staff = loadStaffData();
      var emp = staff.find(function(s) { return s.id === id; });
      if (!emp) return;
      document.getElementById('staffModalTitle').textContent = 'Edit Staff';
      document.getElementById('editStaffId').value = emp.id;
      document.getElementById('staffName').value = emp.name;
      document.getElementById('staffDesignation').value = emp.designation;
      document.getElementById('staffSalary').value = emp.salary;
      document.getElementById('staffDoj').value = emp.doj;
      document.getElementById('addStaffModal').classList.add('active');
    }

    async function saveStaffMember() {
      var editId = document.getElementById('editStaffId').value;
      var name = document.getElementById('staffName').value.trim();
      var designation = document.getElementById('staffDesignation').value;
      var salary = parseFloat(document.getElementById('staffSalary').value) || 0;
      var doj = document.getElementById('staffDoj').value;

      if (!name || !designation || !salary || !doj) {
        showToast('Please fill all fields', 'error');
        return;
      }

      try {
        if (editId) {
          var backendId = getBackendStaffId(editId);
          if (!backendId) { showToast('Staff not found', 'error'); return; }
          await apiFetch('/staff/' + backendId, {
            method: 'PUT',
            body: { name: name, designation: designation, salary: salary, doj: doj }
          });
        } else {
          await apiFetch('/staff', {
            method: 'POST',
            body: { name: name, designation: designation, salary: salary, doj: doj }
          });
        }
        await loadStaffFromAPI();
        closeModal('addStaffModal');
        renderStaffList();
        populateEmployeeDropdowns();
        showToast(editId ? 'Staff updated' : 'Staff added', 'success');
      } catch(e) { /* toast shown */ }
    }

    // Attendance
    async function renderAttendance() {
      var empId = document.getElementById('attEmployee').value;
      var monthStr = document.getElementById('attMonth').value;
      var container = document.getElementById('attendanceCalendar');
      var summaryContainer = document.getElementById('attendanceSummary');

      if (!empId || !monthStr) {
        container.innerHTML = '<p style="color:#9ca3af;text-align:center;padding:20px;">Select an employee and month</p>';
        summaryContainer.innerHTML = '';
        return;
      }

      var staff = loadStaffData();
      var emp = staff.find(function(s) { return s.id === empId; });
      if (!emp) { container.innerHTML = ''; summaryContainer.innerHTML = ''; return; }

      var parts = monthStr.split('-');
      var year = parseInt(parts[0]);
      var month = parseInt(parts[1]) - 1;
      var daysInMonth = new Date(year, month + 1, 0).getDate();
      var firstDayOfWeek = new Date(year, month, 1).getDay(); // 0=Sun
      var today = getToday();

      var empAtt = {};
      try {
        empAtt = await loadAttendanceForEmployee(empId, monthStr);
      } catch(e) { /* toast shown */ }

      // Update cache
      var attKey = empId + '-' + monthStr;
      _attendanceCache[attKey] = empAtt;

      var html = '<div class="attendance-calendar">';
      // Headers
      ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].forEach(function(d) {
        html += '<div class="attendance-day header">' + d + '</div>';
      });

      // Empty cells before first day
      for (var i = 0; i < firstDayOfWeek; i++) {
        html += '<div class="attendance-day empty"></div>';
      }

      var absentCount = 0;
      for (var d = 1; d <= daysInMonth; d++) {
        var dateStr = monthStr + '-' + String(d).padStart(2, '0');
        var isFuture = dateStr > today;
        var isAbsent = empAtt[dateStr] && empAtt[dateStr].absent;
        if (isAbsent) absentCount++;

        var cls = isFuture ? 'future' : (isAbsent ? 'absent' : 'present');
        var title = isAbsent ? 'Absent' + (empAtt[dateStr].remark ? ': ' + empAtt[dateStr].remark : '') : 'Present';
        if (isFuture) title = 'Future';

        var onclick = '';
        if (!isFuture) {
          if (isAbsent) {
            onclick = ' onclick="removeAbsent(\'' + empId + '\',\'' + dateStr + '\')"';
          } else {
            onclick = ' onclick="openMarkAbsent(\'' + empId + '\',\'' + dateStr + '\')"';
          }
        }

        html += '<div class="attendance-day ' + cls + '" title="' + escapeHtml(title) + '"' + onclick + '>' + d;
        if (isAbsent) html += '<br><small>A</small>';
        html += '</div>';
      }

      html += '</div>';
      container.innerHTML = html;

      // Count present days (only up to today)
      var countableDays = 0;
      for (var d2 = 1; d2 <= daysInMonth; d2++) {
        var ds = monthStr + '-' + String(d2).padStart(2, '0');
        if (ds <= today) countableDays++;
      }
      var presentCount = countableDays - absentCount;

      summaryContainer.innerHTML =
        '<div class="att-chip chip-days">Days in Month: ' + daysInMonth + '</div>' +
        '<div class="att-chip chip-present">Present: ' + presentCount + '</div>' +
        '<div class="att-chip chip-absent">Absent: ' + absentCount + '</div>';
    }

    function openMarkAbsent(empId, dateStr) {
      var staff = loadStaffData();
      var emp = staff.find(function(s) { return s.id === empId; });
      document.getElementById('absentEmpName').textContent = emp ? emp.name : empId;
      document.getElementById('absentDateDisplay').textContent = formatDate(dateStr);
      document.getElementById('absentEmpId').value = empId;
      document.getElementById('absentDate').value = dateStr;
      document.getElementById('absentRemark').value = '';
      document.getElementById('markAbsentModal').classList.add('active');
    }

    async function saveAbsent() {
      var empId = document.getElementById('absentEmpId').value;
      var dateStr = document.getElementById('absentDate').value;
      var remark = document.getElementById('absentRemark').value.trim();

      var backendStaffId = getBackendStaffId(empId);
      if (!backendStaffId) { showToast('Staff not found', 'error'); return; }

      try {
        await apiFetch('/attendance', {
          method: 'POST',
          body: { staffId: backendStaffId, date: dateStr, absent: true, remark: remark }
        });
        closeModal('markAbsentModal');
        await renderAttendance();
        showToast('Marked absent', 'success');
      } catch(e) { /* toast shown */ }
    }

    async function removeAbsent(empId, dateStr) {
      if (!confirm('Remove absence for ' + formatDate(dateStr) + '?')) return;

      var backendStaffId = getBackendStaffId(empId);
      if (!backendStaffId) { showToast('Staff not found', 'error'); return; }

      try {
        await apiFetch('/attendance?staffId=' + backendStaffId + '&date=' + encodeURIComponent(dateStr), { method: 'DELETE' });
        await renderAttendance();
        showToast('Absence removed', 'success');
      } catch(e) { /* toast shown */ }
    }

    // Salary Advances
    function renderAdvanceList() {
      var advances = loadAdvances();
      var tbody = document.getElementById('advanceListTable');

      if (advances.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#9ca3af;padding:20px;">No advances recorded</td></tr>';
        return;
      }

      // Sort by date descending
      advances.sort(function(a, b) { return b.date > a.date ? 1 : -1; });

      var staff = loadStaffData();
      tbody.innerHTML = advances.map(function(adv) {
        var emp = staff.find(function(s) { return s.id === adv.employeeId; });
        var empName = emp ? emp.name : adv.employeeId;
        var statusBadge = adv.deducted
          ? '<span class="salary-paid">Deducted</span>'
          : '<span class="salary-unpaid">Pending</span>';
        return '<tr>' +
          '<td>' + escapeHtml(empName) + '</td>' +
          '<td class="amount">' + formatCurrency(adv.amount) + '</td>' +
          '<td>' + formatDate(adv.date) + '</td>' +
          '<td>' + escapeHtml(adv.deductMonth || '-') + '</td>' +
          '<td>' + escapeHtml(adv.remarks || '-') + '</td>' +
          '<td>' + statusBadge + '</td>' +
          '<td>' + (!adv.deducted ? '<button class="btn btn-danger btn-small" onclick="deleteAdvance(\'' + adv.id + '\')">Delete</button>' : '-') + '</td>' +
          '</tr>';
      }).join('');
    }

    function openAddAdvanceModal() {
      document.getElementById('advanceEmployee').value = '';
      document.getElementById('advanceAmount').value = '';
      document.getElementById('advanceDate').value = getToday();
      var now = new Date();
      document.getElementById('advanceDeductMonth').value = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0');
      document.getElementById('advanceRemarks').value = '';
      populateEmployeeDropdowns();
      document.getElementById('addAdvanceModal').classList.add('active');
    }

    async function saveAdvance() {
      var empId = document.getElementById('advanceEmployee').value;
      var amount = parseFloat(document.getElementById('advanceAmount').value) || 0;
      var date = document.getElementById('advanceDate').value;
      var deductMonth = document.getElementById('advanceDeductMonth').value;
      var remarks = document.getElementById('advanceRemarks').value.trim();

      if (!empId || !amount || !date || !deductMonth) {
        showToast('Please fill all required fields', 'error');
        return;
      }

      var backendStaffId = getBackendStaffId(empId);
      if (!backendStaffId) { showToast('Staff not found', 'error'); return; }

      try {
        await apiFetch('/advances', {
          method: 'POST',
          body: {
            staffId: backendStaffId,
            amount: amount,
            date: date,
            deductMonth: deductMonth,
            remarks: remarks
          }
        });
        await loadAdvancesFromAPI();
        closeModal('addAdvanceModal');
        renderAdvanceList();
        showToast('Advance recorded', 'success');
      } catch(e) { /* toast shown */ }
    }

    async function deleteAdvance(id) {
      if (!confirm('Delete this advance record?')) return;

      var backendId = getBackendAdvanceId(id);
      if (!backendId) { showToast('Advance not found', 'error'); return; }

      try {
        await apiFetch('/advances/' + backendId, { method: 'DELETE' });
        await loadAdvancesFromAPI();
        renderAdvanceList();
        showToast('Advance deleted', 'success');
      } catch(e) { /* toast shown */ }
    }

    // Salary Calculation
    async function renderSalaryCalculation() {
      var monthStr = document.getElementById('salaryCalcMonth').value;
      if (!monthStr) return;

      var tbody = document.getElementById('salaryCalcTable');

      try {
        var data = await apiFetch('/reports/salary?month=' + encodeURIComponent(monthStr));

        if (!data || data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="12" style="text-align:center;color:#9ca3af;padding:20px;">No active staff</td></tr>';
          return;
        }

        tbody.innerHTML = data.map(function(row) {
          var s = row.staff;
          var staffCode = s.staffCode || ('EMP-TEMP-' + s.id);
          var statusBadge = row.isPaid ? '<span class="salary-paid">Paid</span>' : '<span class="salary-unpaid">Unpaid</span>';
          var payBtn = !row.isPaid && row.net > 0
            ? '<button class="btn btn-primary btn-small" onclick="paySalaryViaDayBook(\'' + escapeHtml(staffCode) + '\',' + row.net + ',\'' + monthStr + '\')">Pay</button>'
            : '';

          return '<tr>' +
            '<td><strong>' + escapeHtml(s.name) + '</strong></td>' +
            '<td>' + escapeHtml(s.designation) + '</td>' +
            '<td class="amount">' + formatCurrency(s.salary) + '</td>' +
            '<td>' + row.daysInMonth + '</td>' +
            '<td style="color:#065f46;font-weight:600">' + row.presentDays + '</td>' +
            '<td style="color:#991b1b;font-weight:600">' + row.absentDays + '</td>' +
            '<td class="amount">' + formatCurrency(row.perDay) + '</td>' +
            '<td class="amount">' + formatCurrency(row.gross) + '</td>' +
            '<td class="amount" style="color:#ef4444">' + formatCurrency(row.totalAdvance) + '</td>' +
            '<td class="amount" style="font-weight:700">' + formatCurrency(row.net) + '</td>' +
            '<td>' + statusBadge + '</td>' +
            '<td>' + payBtn + '</td>' +
            '</tr>';
        }).join('');
      } catch(e) {
        tbody.innerHTML = '<tr><td colspan="12" style="text-align:center;color:#ef4444;padding:20px;">Failed to load salary data</td></tr>';
      }
    }

    function paySalaryViaDayBook(empId, netAmount, monthStr) {
      var staff = loadStaffData();
      var emp = staff.find(function(s) { return s.id === empId; });
      if (!emp) return;

      // Switch to day book and open expense modal pre-filled
      // First ensure day book date is set to today
      document.getElementById('daybookDate').value = getToday();

      // Open expense modal pre-filled with Salary
      openAddExpenseModal('Salary', empId, netAmount);
      document.getElementById('expenseDescription').value = 'Salary for ' + monthStr + ' - ' + emp.name;

      // Note: advance deduction is handled by the backend when FnF is processed
    }

    // FnF
    function openFnfModal(empId) {
      var staff = loadStaffData();
      var emp = staff.find(function(s) { return s.id === empId; });
      if (!emp) return;

      document.getElementById('fnfEmpId').value = empId;
      document.getElementById('fnfLastDate').value = getToday();
      document.getElementById('fnfEmployeeInfo').innerHTML =
        '<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">' +
        '<div><small style="color:#6b7280">Name</small><br><strong>' + escapeHtml(emp.name) + '</strong></div>' +
        '<div><small style="color:#6b7280">Designation</small><br><strong>' + escapeHtml(emp.designation) + '</strong></div>' +
        '<div><small style="color:#6b7280">Monthly Salary</small><br><strong>' + formatCurrency(emp.salary) + '</strong></div>' +
        '<div><small style="color:#6b7280">Date of Joining</small><br><strong>' + formatDate(emp.doj) + '</strong></div>' +
        '</div>';

      calculateFnf();
      document.getElementById('fnfModal').classList.add('active');
    }

    function calculateFnf() {
      var empId = document.getElementById('fnfEmpId').value;
      var lastDate = document.getElementById('fnfLastDate').value;
      if (!empId || !lastDate) return;

      var staff = loadStaffData();
      var emp = staff.find(function(s) { return s.id === empId; });
      if (!emp) return;

      var lastDateObj = new Date(lastDate + 'T00:00:00');
      var year = lastDateObj.getFullYear();
      var month = lastDateObj.getMonth();
      var daysInMonth = new Date(year, month + 1, 0).getDate();
      var dayWorked = lastDateObj.getDate();

      var perDay = Math.round(emp.salary / daysInMonth);
      var proRated = perDay * dayWorked;

      // Pending advances
      var advances = loadAdvances();
      var pendingAdvance = 0;
      advances.forEach(function(adv) {
        if (adv.employeeId === empId && !adv.deducted) {
          pendingAdvance += parseFloat(adv.amount) || 0;
        }
      });

      var netPayable = proRated - pendingAdvance;
      if (netPayable < 0) netPayable = 0;

      document.getElementById('fnfBreakdown').innerHTML =
        '<div style="display:flex;justify-content:space-between;margin-bottom:8px;">' +
          '<span>Days in final month:</span><strong>' + daysInMonth + '</strong></div>' +
        '<div style="display:flex;justify-content:space-between;margin-bottom:8px;">' +
          '<span>Days worked:</span><strong>' + dayWorked + '</strong></div>' +
        '<div style="display:flex;justify-content:space-between;margin-bottom:8px;">' +
          '<span>Per day salary:</span><strong>' + formatCurrency(perDay) + '</strong></div>' +
        '<div style="display:flex;justify-content:space-between;margin-bottom:8px;">' +
          '<span>Pro-rated salary:</span><strong>' + formatCurrency(proRated) + '</strong></div>' +
        '<div style="display:flex;justify-content:space-between;margin-bottom:8px;color:#ef4444;">' +
          '<span>Pending advances:</span><strong>' + formatCurrency(pendingAdvance) + '</strong></div>' +
        '<div style="display:flex;justify-content:space-between;padding-top:8px;border-top:2px solid #1e3a5f;font-size:16px;">' +
          '<span>Net Payable:</span><strong style="color:#1e3a5f">' + formatCurrency(netPayable) + '</strong></div>';
    }

    async function processFnf() {
      var empId = document.getElementById('fnfEmpId').value;
      var lastDate = document.getElementById('fnfLastDate').value;
      if (!empId || !lastDate) return;

      if (!confirm('Process Full & Final settlement? This will mark the employee as Left.')) return;

      var backendId = getBackendStaffId(empId);
      if (!backendId) { showToast('Staff not found', 'error'); return; }

      try {
        await apiFetch('/staff/' + backendId + '/fnf', {
          method: 'POST',
          body: { lastWorkingDate: lastDate }
        });
        await Promise.all([loadStaffFromAPI(), loadAdvancesFromAPI()]);
        closeModal('fnfModal');
        renderStaffList();
        populateEmployeeDropdowns();
        await renderSalaryCalculation();
        showToast('FnF processed. Employee marked as Left.', 'success');
      } catch(e) { /* toast shown */ }
    }

  </script>
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js').catch(function(){});
    }
  </script>
</body>
</html>
